<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>System ZarzƒÖdzania</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+EAN13+Text&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-light: #f0f2f5;
            --background-dark: #121212;
            --text-light: #1c1c1c;
            --text-dark: #e0e0e0;
            --surface-light: #fff;
            --surface-dark: #1e1e1e;
            --border-light: #ddd;
            --border-dark: #333;
            --priority-color: #B8860B;
            --supabase-source-color: #56a761;
            --firebase-source-color: #ffca28;
            --user-task-color: #007bff;
            --reject-color: #dc3545;
        }
        body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            background-color: var(--background-light);
            color: var(--text-light);
            transition: background-color 0.3s, color 0.3s;
        }
        .nav-bar {
            overflow: visible;
            padding: 0 20px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .nav-links { flex-grow: 1; display: flex; overflow-x: auto; }
        .blue-nav { background-color: #004896; }
        .gray-nav { background-color: #6c757d; }
        .nav-bar a {
            float: left;
            display: block;
            color: white;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.3s;
            white-space: nowrap;
        }
        .blue-nav a:hover { background-color: #ffc101; color: black; }
        .gray-nav a:hover { background-color: #5a6268; }
        .nav-actions { display: flex; align-items: center; }
        .theme-toggle-btn, .refresh-btn {
            font-size: 1.5em; background: none; border: none; cursor: pointer; padding: 0 10px; color: white;
        }
        .hamburger-btn {
            display: none; font-size: 1.8em; background: none; border: none; cursor: pointer; color: white;
        }
        .content { padding: 20px 30px; display: none; }
        .content.active { display: block; }

        /* --- FILTERS --- */
        .filter-bar {
            display: flex; align-items: center; gap: 10px; margin-bottom: 15px;
            background: var(--surface-light); padding: 10px; border-radius: 5px; border: 1px solid var(--border-light);
        }
        .dark-mode .filter-bar { background: var(--surface-dark); border-color: var(--border-dark); }
        .filter-bar select { padding: 6px; border-radius: 4px; border: 1px solid #ccc; }

        /* --- ITEM ROWS --- */
        .item-row {
            border-bottom: 1px solid var(--border-light); padding: 10px 5px;
            display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;
        }
        .item-row.done { color: red !important; text-decoration: line-through; background-color: #f9f9f9; }
        .item-row.priority { color: var(--priority-color); font-weight: bold; }
        .item-row.user-submitted { color: var(--user-task-color); }
        .item-row.user-submitted.done, .item-row.priority.done { color: red !important; }
        .item-row.due-date-warning:not(.done) .task-text-container,
        .item-row.due-date-warning:not(.done) .due-date-text { color: purple; font-weight: bold; }
        .dark-mode .item-row.due-date-warning:not(.done) .task-text-container,
        .dark-mode .item-row.due-date-warning:not(.done) .due-date-text { color: #c58af9; }
        .item-content-wrapper { display: flex; align-items: center; flex-grow: 1; }
        .assignees, .supplier-info { color: #555; font-size: 0.9em; margin-left: 15px; }
        .date-info { font-size: 0.8em; color: #888; margin-left: auto; padding-left: 20px; text-align: right; white-space: nowrap; }
        .due-date-text { margin-left: 15px; font-size: 1em; font-weight: normal; }
        .right-aligned-info { text-align: right; }

        /* --- INVENTORY STYLES --- */
        .inventory-controls {
            display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
            background: var(--surface-light); padding: 15px; border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); align-items: flex-end;
        }
        .filter-group { display: flex; flex-direction: column; flex: 1; min-width: 150px; }
        .filter-group label { font-size: 0.8em; margin-bottom: 5px; color: #666; }
        .inventory-table {
            width: 100%; border-collapse: collapse; background: var(--surface-light);
            border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .inventory-table th, .inventory-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-light); }
        .inventory-table th { background-color: #f8f9fa; font-weight: bold; color: #555; cursor: pointer; }
        .inventory-table tr:hover { background-color: rgba(0,0,0,0.02); }
        .price-tag { font-weight: bold; color: #28a745; }
        .quantity-badge {
            background: #fff; border: 1px solid #ddd; color: #000;
            padding: 4px 8px; border-radius: 12px; font-size: 0.9em; font-weight: bold;
        }
        .quantity-badge.out { background: #dc3545; color: #fff; border-color: #dc3545; }
        .load-more-container { text-align: center; margin-top: 15px; padding-bottom: 20px; }
        .load-more-btn { background-color: #6c757d; width: 100%; max-width: 300px; }
        #user-inventory.price-hidden .inventory-table th:nth-child(4),
        #user-inventory.price-hidden .inventory-table td:nth-child(4),
        #admin-inventory.price-hidden .inventory-table th:nth-child(4),
        #admin-inventory.price-hidden .inventory-table td:nth-child(4) { display: none; }

        /* --- CONTACTS MODULE STYLES (NOWE) --- */
        .company-card {
            padding: 15px; border-bottom: 1px solid var(--border-light);
            cursor: pointer; transition: background-color 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .company-card:hover { background-color: rgba(0,0,0,0.05); }
        .dark-mode .company-card:hover { background-color: rgba(255,255,255,0.05); }
        .dark-mode .company-card { border-bottom-color: var(--border-dark); }

        .contact-card {
            background: var(--surface-light); border: 1px solid var(--border-light);
            border-radius: 8px; padding: 15px; margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }
        .dark-mode .contact-card { background: #2c2c2c; border-color: #444; }

        .contact-role { font-weight: bold; font-size: 1.1em; margin-bottom: 8px; display: block; color: var(--priority-color); }
        .contact-detail { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; color: var(--text-light); }
        .dark-mode .contact-detail { color: var(--text-dark); }
        .contact-detail a { color: var(--user-task-color); text-decoration: none; }
        .contact-actions {
            margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;
            text-align: right;
        }
        .dark-mode .contact-actions { border-top-color: #444; }
        .contact-actions button { font-size: 0.8em; padding: 4px 8px; }


        h2, h3 { color: var(--text-light); }
        form {
            margin-top: 20px; margin-bottom: 20px; background-color: var(--surface-light);
            padding: 15px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        form input, form textarea, .inventory-controls input, .inventory-controls select, form select, .filter-bar select {
            padding: 8px; margin-right: 10px; border: 1px solid #ccc; border-radius: 4px; resize: none;
        }

        /* --- CUSTOM DROPDOWN --- */
        .custom-dropdown { position: relative; margin-bottom: 10px; margin-right: 10px; min-width: 200px; display: inline-block; vertical-align: top; }
        .dropdown-selected {
            background-color: var(--surface-light); border: 1px solid #ccc; border-radius: 4px; padding: 8px;
            cursor: pointer; display: flex; justify-content: space-between; align-items: center; min-height: 19px;
            user-select: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .dropdown-selected:after { content: '‚ñº'; font-size: 0.8em; margin-left: 10px; color: #666; }
        .dropdown-options {
            display: none; position: absolute; top: 100%; left: 0; width: 100%; max-height: 200px; overflow-y: auto;
            background-color: var(--surface-light); border: 1px solid #ccc; border-radius: 0 0 4px 4px;
            z-index: 1000; box-shadow: 0 4px 8px rgba(0,0,0,0.1); box-sizing: border-box;
        }
        .dropdown-options.open { display: block; }
        .dropdown-option { padding: 8px 10px; display: flex; align-items: center; cursor: pointer; border-bottom: 1px solid var(--border-light); transition: background-color 0.2s; }
        .dropdown-option:last-child { border-bottom: none; }
        .dropdown-option:hover { background-color: rgba(0,0,0,0.05); }
        .dropdown-option input[type="checkbox"] { margin-right: 10px; cursor: pointer; }
        .dark-mode .dropdown-selected { background-color: #2a2a2a; border-color: #444; color: var(--text-dark); }
        .dark-mode .dropdown-options { background-color: #2a2a2a; border-color: #444; }
        .dark-mode .dropdown-option { border-bottom-color: #444; color: var(--text-dark); }
        .dark-mode .dropdown-option:hover { background-color: rgba(255,255,255,0.05); }

        @media (min-width: 769px) {
            #user-task-form, #admin-task-form { display: flex; align-items: center; gap: 10px; flex-wrap: nowrap; }
            #user-task-form h3, #admin-task-form h3 { display: none; }
            #user-task-form input[type="text"], #admin-task-form input[type="text"] { flex: 2; margin-right: 0; }
            #user-task-form .custom-dropdown, #admin-task-form .custom-dropdown { flex: 1; margin-bottom: 0; margin-right: 0; min-width: 180px; }
            #user-task-form input[type="date"], #admin-task-form input[type="date"] { margin-top: 0 !important; margin-right: 0; width: auto; }
            #user-task-form button, #admin-task-form button { margin-left: 0; white-space: nowrap; }
            .desktop-hide-label { display: none !important; }
        }

        .vacation-request-form { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
        .vacation-request-form .vacation-form-row { display: flex; flex-direction: column; gap: 5px; flex: 1 1 200px; }
        .vacation-request-form textarea { min-height: 36px; }
        .vacation-request-form button { margin-left: 0; }
        button { margin-left: 10px; cursor: pointer; padding: 8px 12px; border: none; border-radius: 4px; color: white; background-color: #004896; transition: background-color 0.3s; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        .item-row button { background-color: #6c757d; font-size: 0.8em; padding: 5px 8px; }
        .item-row button.reject-btn { background-color: var(--reject-color) !important; color: white; border: 1px solid var(--reject-color); }
        .google-sheet-iframe { width: 100%; height: 75vh; border: 1px solid var(--border-light); border-radius: 5px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .page-header a { display: inline-block; padding: 8px 16px; background-color: #28a745; color: white; text-decoration: none; border-radius: 4px; font-size: 0.9em; transition: background-color 0.3s; }
        .page-header a:hover { background-color: #218838; }

        /* --- VACATION REQUESTS --- */
        .vacation-request.accepted { background-color: #d4edda; }
        .vacation-request.rejected { background-color: #f8d7da; }
        .request-notes { color: #666; font-style: italic; }
        .request-status { margin-left: 15px; font-weight: bold; flex-shrink: 0; }
        .request-status.accepted { color: #155724; }
        .request-status.rejected { color: #721c24; }
        .request-status.pending { color: #856404; }

        /* --- DARK MODE --- */
        body.dark-mode { background-color: var(--background-dark); color: var(--text-dark); }
        .dark-mode h2, .dark-mode h3 { color: var(--text-dark); }
        .dark-mode form, .dark-mode .inventory-controls, .dark-mode .inventory-table { background-color: var(--surface-dark); border: 1px solid var(--border-dark); }
        .dark-mode form input, .dark-mode form textarea, .dark-mode form select, .dark-mode .filter-bar select, .dark-mode .note-content-input, .dark-mode .raw-editor, .dark-mode .modal-input, .dark-mode .inventory-controls input, .dark-mode .inventory-controls select { background-color: #2a2a2a; color: var(--text-dark); border-color: #444; }
        .dark-mode .item-row { border-bottom-color: var(--border-dark); }
        .dark-mode .item-row.done { background-color: #2c1d1d; }
        .dark-mode .assignees, .dark-mode .supplier-info, .dark-mode .date-info { color: #999; }
        .dark-mode .google-sheet-iframe { border-color: var(--border-dark); filter: invert(90%) hue-rotate(180deg); }
        .dark-mode .item-row.priority { color: #ffc101; }
        .dark-mode .item-row.user-submitted { color: #3399ff; }
        .dark-mode .item-row.due-date-warning:not(.done) .task-text-container,
        .dark-mode .item-row.due-date-warning:not(.done) .due-date-text { color: #c58af9; }
        .dark-mode .inventory-table th { background-color: #2c2c2c; color: #ccc; border-bottom-color: #444; }
        .dark-mode .inventory-table td { border-bottom-color: #444; }
        .dark-mode .barcode-display { color: #eee; filter: invert(1); }
        .dark-mode .quantity-badge { background: #333; color: #fff; border-color: #555; }
        .dark-mode .quantity-badge.out { background: #5c181f; color: #ff6b6b; border-color: #5c181f; }
        .dark-mode .source-tag.firebase { color: black; }
        .dark-mode .vacation-request.accepted { background-color: #051b0b; }
        .dark-mode .vacation-request.rejected { background-color: #2c0b0e; }
        .dark-mode .request-notes { color: #aaa; }
        .dark-mode .request-status.accepted { color: #4ade80; }
        .dark-mode .request-status.rejected { color: #f87171; }
        .dark-mode .request-status.pending { color: #facc15; }

        /* --- NOTEBOOK --- */
        .notebook-container { display: flex; gap: 20px; height: 80vh; }
        .note-list-column { flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border-light); padding-right: 20px; }
        .dark-mode .note-list-column { border-right-color: var(--border-dark); }
        .note-editor-column { flex: 3; display: flex; flex-direction: column; }
        .note-editor-content-wrapper { position: relative; flex-grow: 1; display: flex; }
        #new-note-btn, #user-new-note-btn { width: 100%; margin: 0 0 10px 0; }
        #note-title-list, #user-note-title-list { overflow-y: auto; }
        .note-list-item { padding: 10px; border-bottom: 1px solid var(--border-light); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .note-title-wrapper { display: flex; align-items: baseline; flex-grow: 1; overflow: hidden; }
        .note-title { font-weight: bold; font-size: 1.1em; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        .note-list-date { font-size: 0.8em; font-weight: normal; color: #888; margin-left: 8px; white-space: nowrap; }
        .dark-mode .note-list-date { color: #aaa; }
        .note-list-item:hover { background-color: rgba(0, 0, 0, 0.05); }
        .note-list-item.selected { background-color: #cccccc; color: #1c1c1c; }
        .dark-mode .note-list-item:hover { background-color: rgba(255, 255, 255, 0.05); }
        .dark-mode .note-list-item.selected { background-color: #383838; color: #e0e0e0; }
        .note-actions { display: flex; align-items: center; }
        .note-pin-btn, .note-publish-btn, .note-share-btn { cursor: pointer; opacity: 0.6; font-size: 1.1em; margin-left: 10px; }
        .note-pin-btn:hover, .note-publish-btn:hover, .note-share-btn:hover { opacity: 1; }
        .note-list-item.pinned .note-pin-btn { opacity: 1; color: #007bff; }
        .note-list-item.public .note-publish-btn { opacity: 1; color: #28a745; }
        .editor-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        #note-title-input, #user-note-title-input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        #note-color-input, #user-note-color-input { height: 35px; padding: 2px; border: 1px solid #ccc; border-radius: 4px; background-color: white; }
        .note-content-input, .raw-editor { flex-grow: 1; width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; resize: none; }
        .note-content-input { overflow-y: auto; }
        .note-content-input div { min-height: 1.2em; display: flex; align-items: center; }
        .note-content-input input[type="checkbox"] { margin-right: 8px; flex-shrink: 0; }
        .note-content-input img, .note-content-input video { max-width: 100%; height: auto; }
        #note-timestamps, #user-note-timestamps { font-size: 0.8em; color: #888; text-align: right; margin-top: 10px; padding-right: 10px; }
        .dark-mode #note-timestamps, .dark-mode #user-note-timestamps { color: #aaa; }
        .note-editor-buttons { margin-top: 10px; text-align: right; }
        #admin-notes button { background-color: #6c757d; }
        #admin-notes button:hover { background-color: #5a6268; }
        #delete-note-btn, .delete-order-btn, .delete-vacation-btn, .delete-task-btn { background-color: #dc3545; }
        #delete-note-btn:hover, .delete-order-btn:hover, .delete-vacation-btn:hover, .delete-task-btn:hover { background-color: #c82333; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-content {
            background: var(--surface-light); color: var(--text-light); padding: 20px; border-radius: 8px; text-align: center; max-width: 90%; width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .dark-mode .modal-content { background: var(--surface-dark); color: var(--text-dark); }
        .modal-content h4 { margin-top: 0; }
        .modal-content p { white-space: pre-wrap; }
        .modal-input { width: calc(100% - 20px); padding: 8px; margin-top: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .ean-barcode { font-family: 'Libre Barcode EAN13 Text', system-ui; font-size: 110px; line-height: 1; }
        .subtask { display: inline-flex; align-items: center; margin: 0 5px; }
        .subtask-text.done { text-decoration: line-through; }
        .task-text-container { display: inline; }
        .source-tag { font-size: 0.7em; padding: 2px 5px; border-radius: 3px; margin-left: 5px; font-weight: normal; color: white; }
        .source-tag.supabase { background-color: var(--supabase-source-color); }
        .source-tag.firebase { background-color: var(--firebase-source-color); color: var(--text-light); }
        .days-of-week { display: flex; gap: 10px; margin: 10px 0; }
        .days-of-week label { cursor: pointer; }

        @media (max-width: 768px) {
            .nav-links { display: none; flex-direction: column; position: absolute; top: 100%; left: 0; width: 100%; background-color: inherit; z-index: 1000; box-shadow: 0 8px 16px rgba(0,0,0,0.2); }
            .nav-links.open { display: flex; }
            .nav-bar a { float: none; text-align: left; }
            .nav-bar .nav-links { flex-grow: 0; }
            .hamburger-btn { display: block; }
            .nav-bar .nav-actions { order: 2; }
            .nav-bar .nav-links { order: 3; width: 100%; }
            .nav-bar::before { content: "Lista Zada≈Ñ"; order: 1; flex-grow: 1; text-align: left; }
            .notebook-container { flex-direction: column; height: 75vh; }
            .note-list-column { border-right: none; padding-right: 0; border-bottom: 1px solid var(--border-light); padding-bottom: 20px; margin-bottom: 20px; flex-shrink: 0; max-height: 30%; }
            .dark-mode .note-list-column { border-bottom-color: var(--border-dark); }
            .content { padding: 15px; }
            .order-item .order-buttons { width: 100%; text-align: left; padding-top: 5px; }
            .order-item .order-buttons button { margin-left: 0; margin-right: 10px; }
            .vacation-request-form { flex-direction: column; align-items: stretch; gap: 10px; }
            .vacation-request-form .vacation-form-row { flex: initial; }
            .inventory-table thead { display: none; }
            .inventory-table tr { display: block; border-bottom: 2px solid #444; margin-bottom: 10px; }
            .inventory-table td { display: flex; justify-content: space-between; align-items: center; text-align: right; padding: 10px; }
            .inventory-table td::before { content: attr(data-label); font-weight: bold; float: left; }
            .vacation-request { flex-direction: column; align-items: flex-start; padding: 15px; margin-bottom: 15px; background: var(--surface-light); border: 1px solid var(--border-light); border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
            .dark-mode .vacation-request { background: #1e1e1e; border-color: #333; }
            .vacation-request .item-content-wrapper { flex-direction: column; align-items: flex-start; width: 100%; gap: 8px; }
            .vacation-request .item-content-wrapper > span:nth-child(1) { font-size: 1.2em; color: var(--text-light); font-weight: bold; display: block; width: 100%; margin-left: 0 !important; }
            .dark-mode .vacation-request .item-content-wrapper > span:nth-child(1) { color: var(--text-dark); }
            .vacation-request .item-content-wrapper > span:nth-child(2) { color: #555; font-weight: 500; display: block; margin-left: 0 !important; }
            .dark-mode .vacation-request .item-content-wrapper > span:nth-child(2) { color: #aaa; }
            .vacation-request .item-content-wrapper > span:nth-child(2)::before { content: 'üìÖ '; }
            .vacation-request .request-status { display: inline-block; padding: 4px 8px; border-radius: 4px; background-color: rgba(0,0,0,0.05); margin-left: 0 !important; margin-top: 5px; }
            .dark-mode .vacation-request .request-status { background-color: rgba(255,255,255,0.1); }
            .vacation-request .request-notes { text-align: left !important; padding: 10px; background: #f9f9f9; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 0.9em; margin-top: 5px; display: block; }
            .dark-mode .vacation-request .request-notes { background: #2c2c2c; }
            .vacation-request .right-aligned-info { width: 100%; margin-top: 15px; text-align: center; padding-top: 10px; border-top: 1px solid var(--border-light); display: flex; flex-wrap: wrap; justify-content: flex-end; }
            .dark-mode .vacation-request .right-aligned-info { border-top-color: #333; }
            .vacation-request button { padding: 10px 15px; margin: 5px; flex: 1 0 auto; min-width: 80px; }
            .vacation-request .right-aligned-info > div { display: flex; flex-wrap: wrap; gap: 5px; width: 100%; justify-content: flex-end; }
        }

        /* --- EASTER EGGS --- */
        @keyframes rainbow-cycle { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }
        .jeb-mode { animation: rainbow-cycle 2s linear infinite; }
        .upside-down-mode { transform: rotate(180deg); min-height: 100vh; }
    </style>
</head>
<body>
<div id="modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h4 id="modal-title"></h4>
        <p id="modal-text"></p>
        <button id="modal-close-btn">Zamknij</button>
    </div>
</div>

<div id="confirm-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h4>Niezapisane zmiany</h4>
        <p>Masz niezapisane zmiany w notatce. Czy chcesz je zapisaƒá?</p>
        <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
            <button id="confirm-yes-btn" style="background-color: #28a745;">Tak</button>
            <button id="confirm-no-btn" style="background-color: #dc3545;">Nie</button>
            <button id="confirm-cancel-btn" style="background-color: #6c757d;">Wr√≥ƒá</button>
        </div>
    </div>
</div>

<div id="edit-task-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h4>Edytuj Zadanie</h4>
        <div style="text-align: left;">
            <label style="font-size: 0.9em; color: #666;">Tre≈õƒá:</label>
            <input type="text" id="edit-task-content" class="modal-input" style="width: 100%; box-sizing: border-box; margin-bottom: 15px;">
            <label style="font-size: 0.9em; color: #666;">Dla kogo:</label>
            <div id="edit-task-assignees-container" style="margin-bottom: 15px;"></div>
            <label style="font-size: 0.9em; color: #666;">Termin:</label>
            <input type="date" id="edit-task-date" class="modal-input" style="width: 100%; box-sizing: border-box; margin-bottom: 20px;">
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button id="edit-task-cancel-btn" style="background-color: #6c757d;">Anuluj</button>
            <button id="edit-task-save-btn">Zapisz</button>
        </div>
    </div>
</div>

<div id="company-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h4 id="company-modal-title">Dodaj Firmƒô</h4>
        <input type="text" id="company-name-input" class="modal-input" placeholder="Nazwa firmy" style="width: 100%; box-sizing: border-box; margin-bottom: 15px;">
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button id="company-modal-cancel" style="background-color: #6c757d;">Anuluj</button>
            <button id="company-modal-save">Zapisz</button>
        </div>
    </div>
</div>

<div id="contact-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h4 id="contact-modal-title">Dane Kontaktu</h4>
        <input type="text" id="contact-label-input" class="modal-input" placeholder="Rola / Osoba (np. Biuro, Przedstawiciel)" style="width: 100%; box-sizing: border-box; margin-bottom: 10px;">
        <input type="tel" id="contact-phone-input" class="modal-input" placeholder="Telefon" style="width: 100%; box-sizing: border-box; margin-bottom: 10px;">
        <input type="email" id="contact-email-input" class="modal-input" placeholder="Email" style="width: 100%; box-sizing: border-box; margin-bottom: 10px;">
        <input type="text" id="contact-note-input" class="modal-input" placeholder="Dodatkowa notatka" style="width: 100%; box-sizing: border-box; margin-bottom: 15px;">
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button id="contact-modal-cancel" style="background-color: #6c757d;">Anuluj</button>
            <button id="contact-modal-save">Zapisz</button>
        </div>
    </div>
</div>

<div id="user-view">
    <div class="nav-bar blue-nav">
        <div class="nav-links" id="user-nav-links">
            <a data-page="user-tasks">üìã Lista zada≈Ñ</a>
            <a data-page="user-order">üõí Do zam√≥wienia</a>
            <a data-page="user-schedule">üìÖ Grafik</a>
            <a data-page="user-schedule-requests">üìù Wnioski do grafiku</a>
            <a data-page="user-inventory">üì¶ Magazyn</a>
            <a data-page="user-notes">üìí Notatnik</a>
            <a id="switch-to-admin-btn">üîê Panel Administratora</a>
        </div>
        <div class="nav-actions">
            <button class="refresh-btn" title="Od≈õwie≈º dane">üîÑ</button>
            <button class="theme-toggle-btn">üåì</button>
            <button class="hamburger-btn" id="user-hamburger-btn">&#9776;</button>
        </div>
    </div>
    <div id="user-tasks" class="content active">
        <h2>Lista Zada≈Ñ</h2>
        <form id="user-task-form">
            <h3>Dodaj zadanie</h3>
            <input type="text" id="user-task-input" placeholder="Tre≈õƒá zadania" required>
            <label class="desktop-hide-label" style="display:block; margin-bottom:5px; font-size:0.9em; color:#666;">Dla kogo:</label>
            <div id="user-assignee-container">≈Åadowanie...</div>
            <input type="date" id="user-due-date-input" title="Termin wykonania" style="margin-top:10px;">
            <button type="submit">Dodaj</button>
        </form>
        <div class="filter-bar">
            <label for="user-task-filter-person">Filtruj wg osoby:</label>
            <select id="user-task-filter-person"><option value="">Wszyscy</option></select>
        </div>
        <div id="user-task-list">≈Åadowanie...</div>
    </div>
    <div id="user-order" class="content">
        <h2>Do zam√≥wienia</h2>
        <form id="user-order-form">
            <input type="text" id="user-order-name" placeholder="Nazwa produktu (!!! dla priorytetu)" required>
            <input type="text" id="user-order-supplier" placeholder="Dostawca">
            <button type="submit">Dodaj do listy</button>
        </form>
        <div id="user-order-list"></div>
    </div>
    <div id="user-schedule" class="content">
        <h2>Grafik</h2>
        <iframe class="google-sheet-iframe" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTDEEc4cmeNHgLhQwp6zAXiUwhzwJSw0DYH-MV0XLEQBs9-2LvsklLOeSHbat4DZexTXeSad5MqzY_e/pubhtml?gid=0&single=true&widget=true&headers=false"></iframe>
    </div>
    <div id="user-schedule-requests" class="content">
        <h2>Z≈Ç√≥≈º wniosek do grafiku</h2>
        <form id="user-schedule-request-form" class="vacation-request-form">
            <div class="vacation-form-row">
                <label for="user-employee-name">Imiƒô i nazwisko:</label>
                <select id="user-employee-name" required><option value="">Wybierz...</option></select>
            </div>
            <div class="vacation-form-row"><label for="user-start-date">Data od:</label><input type="date" id="user-start-date" required></div>
            <div class="vacation-form-row"><label for="user-end-date">Data do:</label><input type="date" id="user-end-date" required></div>
            <div class="vacation-form-row"><label for="user-vacation-notes">Notatka:</label><textarea id="user-vacation-notes"></textarea></div>
            <button type="submit">Wy≈õlij wniosek</button>
        </form>
        <h3>Zg≈Çoszone wnioski</h3>
        <div class="filter-bar">
            <label for="user-request-filter-person">Filtruj wg osoby:</label>
            <select id="user-request-filter-person"><option value="">Wszyscy</option></select>
        </div>
        <div id="user-schedule-request-list"></div>
    </div>
    <div id="user-inventory" class="content">
        <h2>Magazyn</h2>
        <div id="user-db-info" style="font-size: 0.8em; color: #888; margin-top: -10px; margin-bottom: 10px; display: none;"></div>
        <div class="inventory-controls">
            <div class="filter-group"><label>Nazwa produktu:</label><input type="text" id="user-inv-search-name" placeholder="Wpisz nazwƒô..."></div>
            <div class="filter-group"><label>Kod kreskowy (lub @skan):</label><input type="text" id="user-inv-search-code" placeholder="Skanuj kod..." inputmode="numeric" pattern="[0-9]*"></div>
            <div class="filter-group"><label>Sortuj wed≈Çug:</label>
                <select id="user-inv-sort">
                    <option value="name_asc">Nazwa (A-Z)</option>
                    <option value="name_desc">Nazwa (Z-A)</option>
                    <option value="price_asc">Cena (rosnƒÖco)</option>
                    <option value="price_desc">Cena (malejƒÖco)</option>
                    <option value="qty_asc">Ilo≈õƒá (rosnƒÖco)</option>
                    <option value="qty_desc">Ilo≈õƒá (malejƒÖco)</option>
                </select>
            </div>
            <div class="filter-group" style="flex-direction: row; align-items: center; gap: 10px;"><button id="user-toggle-zeros-btn" style="margin:0">Ukryj stany 0</button></div>
        </div>
        <div id="user-inventory-count" style="margin-bottom: 10px; font-size: 0.9em; color: #888;"></div>
        <table class="inventory-table">
            <thead><tr><th>Produkt</th><th>Kod</th><th>Ilo≈õƒá</th><th>Cena (Brutto)</th></tr></thead>
            <tbody id="user-inventory-list"></tbody>
        </table>
        <div class="load-more-container"><button id="user-load-more-btn" class="load-more-btn" style="display: none;">Poka≈º wiƒôcej</button></div>
    </div>
    <div id="user-notes" class="content">
        <h2>Notatnik</h2>
        <div class="notebook-container">
            <div class="note-list-column">
                <button id="user-new-note-btn">+ Nowa notatka</button>
                <div id="user-note-title-list">Brak notatek</div>
            </div>
            <div class="note-editor-column">
                <div class="editor-header">
                    <input type="text" id="user-note-title-input" placeholder="Tytu≈Ç notatki...">
                    <input type="color" id="user-note-color-input" title="Wybierz kolor tytu≈Çu" value="#000000">
                </div>
                <div class="note-editor-content-wrapper">
                    <div id="user-note-content-input" class="note-content-input" contenteditable="true"></div>
                    <textarea id="user-note-content-raw" class="raw-editor" style="display: none;"></textarea>
                </div>
                <div id="user-note-timestamps"></div>
                <div class="note-editor-buttons">
                    <button id="user-toggle-raw-btn">Edytuj Kod</button>
                    <button id="user-save-note-btn">Zapisz</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="admin-view" style="display: none;">
    <div class="nav-bar gray-nav">
        <div class="nav-links" id="admin-nav-links">
            <a data-page="admin-tasks">üìã Zadania</a>
            <a data-page="admin-recurring-tasks">üîÑ Cykliczne</a>
            <a data-page="admin-order">üõí Zam√≥wienia</a>
            <a data-page="admin-inventory">üì¶ Magazyn</a>
            <a data-page="admin-schedule">üìÖ Grafik</a>
            <a data-page="admin-schedule-requests">üìù Wnioski</a>
            <a data-page="admin-contacts">üìû Kontakty</a>
            <a data-page="admin-notes">üìí Notatnik</a>
            <a data-page="admin-employees">üë• Pracownicy</a>
            <a id="switch-to-user-btn">üë§ Panel u≈ºytkownika</a>
            <a id="admin-commands-btn">üíª Komendy</a>
        </div>
        <div class="nav-actions">
            <button class="refresh-btn" title="Od≈õwie≈º dane">üîÑ</button>
            <button class="theme-toggle-btn">üåì</button>
            <button class="hamburger-btn" id="admin-hamburger-btn">&#9776;</button>
        </div>
    </div>
    <div id="admin-tasks" class="content">
        <h2>Panel Administratora</h2>
        <form id="admin-task-form">
            <h3>Dodaj zadanie</h3>
            <input type="text" id="admin-task-input" placeholder="Tre≈õƒá zadania" required>
            <label class="desktop-hide-label" style="display:block; margin-bottom:5px; font-size:0.9em; color:#666;">Dla kogo:</label>
            <div id="admin-assignee-container">≈Åadowanie pracownik√≥w...</div>
            <input type="date" id="admin-due-date-input" title="Termin wykonania" style="margin-top:10px;">
            <button type="submit">Dodaj</button>
        </form>
        <h3>Lista zada≈Ñ</h3>
        <div class="filter-bar">
            <label for="admin-task-filter-person">Filtruj wg osoby:</label>
            <select id="admin-task-filter-person"><option value="">Wszyscy</option></select>
        </div>
        <div id="admin-task-list-visible">≈Åadowanie...</div>
        <h3>Zadania ukryte</h3>
        <div id="admin-task-list-hidden"></div>
    </div>
    <div id="admin-order" class="content">
        <h2>Do zam√≥wienia (Admin)</h2>
        <form id="admin-order-form">
            <input type="text" id="admin-order-name" placeholder="Nazwa produktu (!!! dla priorytetu)" required>
            <input type="text" id="admin-order-supplier" placeholder="Dostawca">
            <button type="submit">Dodaj do listy</button>
        </form>
        <h3>Pozycje do zam√≥wienia</h3>
        <div id="admin-order-list-active"></div>
        <h3>Zam√≥wienia zrealizowane</h3>
        <div id="admin-order-list-completed"></div>
    </div>
    <div id="admin-inventory" class="content">
        <div class="page-header">
            <div>
                <h2>ZarzƒÖdzanie Magazynem</h2>
                <div id="admin-db-info" style="font-size: 0.8em; color: #888; margin-top: -10px; margin-bottom: 10px;"></div>
            </div>
            <a href="https://drive.google.com/file/d/1rleT0kRGo11zloRZge6lY9qKpGcpueE0/view?usp=drive_link" target="_blank">üì± App</a>
        </div>
        <div class="inventory-controls">
            <div class="filter-group"><label>Nazwa produktu:</label><input type="text" id="admin-inv-search-name" placeholder="Wpisz nazwƒô..."></div>
            <div class="filter-group"><label>Kod kreskowy (lub @skan):</label><input type="text" id="admin-inv-search-code" placeholder="Skanuj kod..." inputmode="numeric" pattern="[0-9]*"></div>
            <div class="filter-group"><label>Sortuj wed≈Çug:</label>
                <select id="admin-inv-sort">
                    <option value="name_asc">Nazwa (A-Z)</option>
                    <option value="name_desc">Nazwa (Z-A)</option>
                    <option value="price_asc">Cena (rosnƒÖco)</option>
                    <option value="price_desc">Cena (malejƒÖco)</option>
                    <option value="qty_asc">Ilo≈õƒá (rosnƒÖco)</option>
                    <option value="qty_desc">Ilo≈õƒá (malejƒÖco)</option>
                </select>
            </div>
            <div class="filter-group" style="flex-direction: row; align-items: center; gap: 10px;"><button id="admin-toggle-zeros-btn" style="margin:0">Ukryj stany 0</button></div>
        </div>
        <div id="admin-inventory-count" style="margin-bottom: 10px; font-size: 0.9em; color: #888;"></div>
        <table class="inventory-table">
            <thead><tr><th>Produkt</th><th>Kod</th><th>Ilo≈õƒá</th><th>Cena</th></tr></thead>
            <tbody id="admin-inventory-list"></tbody>
        </table>
        <div class="load-more-container"><button id="admin-load-more-btn" class="load-more-btn" style="display: none;">Poka≈º wiƒôcej</button></div>
    </div>
    <div id="admin-recurring-tasks" class="content">
        <h2>Zadania cykliczne</h2>
        <form id="recurring-task-form">
            <h3>Dodaj zadanie cykliczne</h3>
            <input type="text" id="recurring-task-content" placeholder="Tre≈õƒá zadania" required>
            <input type="text" id="recurring-task-assignees" placeholder="Przypisane osoby (≈õrednik ;)">
            <div class="days-of-week">
                <label><input type="checkbox" name="day" value="1"> Pn</label>
                <label><input type="checkbox" name="day" value="2"> Wt</label>
                <label><input type="checkbox" name="day" value="3"> ≈ör</label>
                <label><input type="checkbox" name="day" value="4"> Cz</label>
                <label><input type="checkbox" name="day" value="5"> Pt</label>
                <label><input type="checkbox" name="day" value="6"> So</label>
                <label><input type="checkbox" name="day" value="7"> Nd</label>
            </div>
            <button type="submit">Dodaj</button>
        </form>
        <h3>IstniejƒÖce zadania cykliczne</h3>
        <div id="recurring-task-list"></div>
    </div>
    <div id="admin-schedule" class="content">
        <div class="page-header">
            <h2>Grafik</h2>
            <a href="https://docs.google.com/spreadsheets/d/1nKe6cmb0Tz60gZykzb1Rw06pq1tG0c2FTdktCS2OYV0/edit?usp=sharing" target="_blank">Edytuj</a>
        </div>
        <iframe class="google-sheet-iframe" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTDEEc4cmeNHgLhQwp6zAXiUwhzwJSw0DYH-MV0XLEQBs9-2LvsklLOeSHbat4DZexTXeSad5MqzY_e/pubhtml?widget=true&headers=false&rm=minimal"></iframe>
    </div>
    <div id="admin-notes" class="content">
        <h2>Notatnik</h2>
        <div class="notebook-container">
            <div class="note-list-column">
                <button id="new-note-btn">+ Nowa notatka</button>
                <div id="note-title-list">≈Åadowanie...</div>
            </div>
            <div class="note-editor-column">
                <div class="editor-header">
                    <input type="text" id="note-title-input" placeholder="Tytu≈Ç notatki...">
                    <input type="color" id="note-color-input" title="Wybierz kolor tytu≈Çu">
                </div>
                <div class="note-editor-content-wrapper">
                    <div id="note-content-input" class="note-content-input" contenteditable="true"></div>
                    <textarea id="note-content-raw" class="raw-editor" style="display: none;"></textarea>
                </div>
                <div id="note-timestamps"></div>
                <div class="note-editor-buttons">
                    <button id="admin-toggle-raw-btn">Edytuj Kod</button>
                    <button id="delete-note-btn">Usu≈Ñ</button>
                    <button id="save-note-btn">Zapisz</button>
                </div>
            </div>
        </div>
    </div>
    <div id="admin-schedule-requests" class="content">
        <h2>Z≈Ç√≥≈º wniosek do grafiku (tylko Firebase)</h2>
        <form id="admin-schedule-request-form" class="vacation-request-form">
            <div class="vacation-form-row">
                <label for="admin-employee-name">Imiƒô i nazwisko:</label>
                <select id="admin-employee-name" required><option value="">Wybierz...</option></select>
            </div>
            <div class="vacation-form-row"><label for="admin-start-date">Data od:</label><input type="date" id="admin-start-date" required></div>
            <div class="vacation-form-row"><label for="admin-end-date">Data do:</label><input type="date" id="admin-end-date" required></div>
            <div class="vacation-form-row"><label for="admin-vacation-notes">Notatka:</label><textarea id="admin-vacation-notes"></textarea></div>
            <button type="submit">Wy≈õlij wniosek</button>
        </form>
        <h2>ZarzƒÖdzaj wnioskami</h2>
        <div class="filter-container" style="margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
            <label for="admin-filter-start">Filtruj od:</label><input type="date" id="admin-filter-start">
            <label for="admin-filter-end">do:</label><input type="date" id="admin-filter-end">
            <button id="admin-filter-btn">Filtruj</button>
            <button id="admin-clear-filter-btn">Wyczy≈õƒá</button>
        </div>
        <div class="filter-bar">
            <label for="admin-request-filter-person">Filtruj wg osoby:</label>
            <select id="admin-request-filter-person"><option value="">Wszyscy</option></select>
        </div>
        <h3>Widoczne wnioski</h3>
        <div id="admin-schedule-request-list-visible">≈Åadowanie...</div>
        <h3>Ukryte wnioski</h3>
        <div id="admin-schedule-request-list-hidden">≈Åadowanie...</div>
    </div>

    <div id="admin-contacts" class="content">
        <h2>Baza Kontakt√≥w</h2>
        <div class="inventory-controls">
            <div class="filter-group" style="flex-grow: 1;">
                <label>Szukaj firmy:</label>
                <input type="text" id="admin-company-search" placeholder="üîç Nazwa firmy...">
            </div>
            <div class="filter-group" style="flex: 0;">
                <label>&nbsp;</label>
                <button id="add-company-btn" style="white-space: nowrap;">+ Nowa Firma</button>
            </div>
        </div>
        <div id="admin-company-list">≈Åadowanie...</div>
    </div>

    <div id="admin-company-details" class="content">
        <div class="page-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <button id="back-to-companies-btn" style="background-color: #6c757d; margin:0;">&larr; Wr√≥ƒá</button>
                <h2 id="detail-company-name" style="margin:0;">Nazwa Firmy</h2>
            </div>
            <button id="add-contact-btn">+ Dodaj Kontakt</button>
        </div>
        <div id="admin-contact-list" style="margin-top: 20px;"></div>
    </div>

    <div id="admin-employees" class="content">
        <h2>ZarzƒÖdzanie Pracownikami</h2>
        <form id="admin-employee-form">
            <h3>Dodaj pracownika</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <input type="text" id="admin-emp-firstname" placeholder="Imiƒô" required style="flex: 1;">
                <input type="text" id="admin-emp-lastname" placeholder="Nazwisko" required style="flex: 1;">
            </div>
            <input type="text" id="admin-emp-note" placeholder="Notatka (opcjonalnie)" style="width: 100%; box-sizing: border-box; margin-top: 10px;">
            <button type="submit" style="margin-top: 10px; margin-left: 0;">Dodaj pracownika</button>
        </form>
        <h3>Aktywni Pracownicy</h3>
        <div id="admin-employee-list-active">≈Åadowanie...</div>
        <h3>Archiwum</h3>
        <div id="admin-employee-list-archived"></div>
    </div>
</div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, updateDoc, deleteDoc, doc, getDocs, getDoc, setDoc, where, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/+esm';

    // --- CONFIGURATION ---
    const firebaseConfigFromEnv = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const firebaseConfig = firebaseConfigFromEnv || {
        apiKey: "AIzaSyDT2h4LtrlLP0d2X4jWyaQKabzUbpK_elA",
        authDomain: "psb-app-58090.firebaseapp.com",
        projectId: "psb-app-58090",
        storageBucket: "psb-app-58090.appspot.com",
        messagingSenderId: "100516614463",
        appId: "1:100516614463:web:36fe37ee48cee575b8838a"
    };

    const supabaseUrl = 'https://ugznhwthaztruazsjbhu.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnem5od3RoYXp0cnVhenNqYmh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NjU4NjAsImV4cCI6MjA2NDA0MTg2MH0.MlBkk-oKSRW7CaUiFf3Edo0KXamVlLaZfLuxGcWL4yU';
    const supabase = createClient(supabaseUrl, supabaseKey);

    // --- GLOBAL STATE ---
    let isAdminInitialized = false;
    let isUserInitialized = false;
    let showSourceTagsAdmin = false;
    let editorMode = { user: 'render', admin: 'render' };
    let currentUserNoteId = null;
    let currentAdminNoteId = null;
    let inventoryData = [];
    let employeeData = [];
    let allCompanies = [];
    let currentCompanyData = null;
    let themeToggleButtons;
    let showZeros = true;
    let displayLimit = 100;

    // USTAWIENIE DOMY≈öLNE CENNIKA (0 - ukryte, 1 - widoczne)
    // Pobiera z localStorage, je≈õli brak - domy≈õlnie false (0)
    let showUserPrices = localStorage.getItem('showUserPrices') === '1';

    let editingTask = null;
    let editingContactIndex = -1;
    let lastSavedState = { title: '', content: '' };

    // --- OPTIMIZATION STATE ---
    const loadedViews = new Set();
    let isAuthReady = false;

    // --- Firebase Setup ---
    let app, db, auth, userId;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        setLogLevel('silent');

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Auth failed:", error);
                    await signInAnonymously(auth);
                }
            }
            userId = auth.currentUser?.uid || crypto.randomUUID();
            isAuthReady = true;

            await checkAndCreateRecurringTasks();
            await loadEmployees();

            const savedView = localStorage.getItem('defaultView');
            if (savedView === 'admin') showAdminView();
            else switchToUser();
        });
    } catch (error) {
        console.error("Firebase init failed:", error);
    }

    // --- VIEW LOADERS ---
    const viewLoaders = {
        'user-tasks': () => renderTasks(false),
        'user-order': () => renderOrders(false),
        'user-schedule': () => { },
        'user-schedule-requests': () => renderVacationRequests(false),
        'user-inventory': () => loadInventory(),
        'user-notes': () => renderNotes(false),
        'admin-tasks': () => renderTasks(true),
        'admin-recurring-tasks': () => renderRecurringTasks(),
        'admin-order': () => renderOrders(true),
        'admin-inventory': () => loadInventory(),
        'admin-schedule': () => { },
        'admin-schedule-requests': () => renderVacationRequests(true),
        'admin-notes': () => renderNotes(true),
        'admin-employees': () => loadEmployees(true),
        'admin-contacts': () => loadCompanies(),
        'admin-company-details': () => {}
    };

    // --- UI UTILITIES ---
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalText = document.getElementById('modal-text');
    document.getElementById('modal-close-btn').onclick = () => modal.style.display = 'none';

    function showModal(title, text) {
        modalTitle.textContent = title;
        modalText.textContent = text;
        modal.style.display = 'flex';
    }

    function checkUnsavedChanges(nextAction) {
        const isAdmin = document.getElementById('admin-view').style.display === 'block';
        const prefix = isAdmin ? '' : 'user-';
        const titleInput = document.getElementById(prefix + 'note-title-input');
        if (!titleInput) { nextAction(); return; }

        const currentTitle = titleInput.value;
        const currentContentRaw = document.getElementById(prefix + 'note-content-raw').value;
        const currentContentRender = document.getElementById(prefix + 'note-content-input');
        const currentContent = editorMode[isAdmin?'admin':'user'] === 'raw' ? currentContentRaw : convertRenderedToSource(currentContentRender);

        const hasChanges = (currentTitle !== lastSavedState.title || currentContent !== lastSavedState.content) && (currentTitle || currentContent);

        if(hasChanges) {
            const confirmModal = document.getElementById('confirm-modal');
            confirmModal.style.display = 'flex';
            document.getElementById('confirm-yes-btn').onclick = async () => {
                confirmModal.style.display = 'none';
                if(isAdmin) await saveAdminNote(); else await saveUserNote();
                nextAction();
            };
            document.getElementById('confirm-no-btn').onclick = () => {
                confirmModal.style.display = 'none';
                lastSavedState = { title: '', content: '' };
                nextAction();
            };
            document.getElementById('confirm-cancel-btn').onclick = () => confirmModal.style.display = 'none';
        } else {
            nextAction();
        }
    }

    async function showPage(pageId) {
        document.querySelectorAll('.content').forEach(div => div.classList.remove('active'));
        const page = document.getElementById(pageId);
        if (page) page.classList.add('active');
        document.getElementById('user-nav-links').classList.remove('open');
        document.getElementById('admin-nav-links').classList.remove('open');

        if (viewLoaders[pageId] && !loadedViews.has(pageId)) {
            await viewLoaders[pageId]();
            loadedViews.add(pageId);
        }
    }

    async function refreshCurrentView() {
        if (!isAuthReady) return;
        const activeDiv = document.querySelector('.content.active');
        if (activeDiv && viewLoaders[activeDiv.id]) {
            if (activeDiv.id.includes('inventory')) localStorage.removeItem(`inventory_meta_${appId}`);
            if (activeDiv.id.includes('employees')) localStorage.removeItem(`employees_cache_${appId}`);
            await viewLoaders[activeDiv.id]();
        }
    }

    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        updateThemeIcon();
    }

    function updateThemeIcon() {
        const isDarkMode = document.body.classList.contains('dark-mode');
        if (themeToggleButtons) themeToggleButtons.forEach(btn => { btn.innerHTML = isDarkMode ? '&#9728;&#65039;' : '&#127769;'; });
    }

    function showAdminView() {
        checkUnsavedChanges(() => {
            document.getElementById('user-view').style.display = 'none';
            document.getElementById('admin-view').style.display = 'block';
            showPage('admin-tasks');
            if (!isAdminInitialized) { initAdminView(); isAdminInitialized = true; }
        });
    }

    function switchToUser() {
        checkUnsavedChanges(() => {
            document.getElementById('admin-view').style.display = 'none';
            document.getElementById('user-view').style.display = 'block';
            showPage('user-tasks');
            if (!isUserInitialized) { initUserView(); isUserInitialized = true; }
        });
    }

    function updatePriceVisibility() {
        const userContainer = document.getElementById('user-inventory');
        const adminContainer = document.getElementById('admin-inventory');
        const userDbInfo = document.getElementById('user-db-info');

        // Sprawdza aktualny stan zmiennej (za≈Çadowanej z localStorage)
        if (showUserPrices) {
            if(userContainer) userContainer.classList.remove('price-hidden');
            if(adminContainer) adminContainer.classList.remove('price-hidden');
            if(userDbInfo) userDbInfo.style.display = 'block';
        } else {
            if(userContainer) userContainer.classList.add('price-hidden');
            if(adminContainer) adminContainer.classList.add('price-hidden');
            if(userDbInfo) userDbInfo.style.display = 'none';
        }
    }

    // --- PASSWORD & COMMANDS ---
    async function checkAdminPassword(password) {
        const docRef = doc(db, `artifacts/${appId}/config/admin`);
        try {
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) return docSnap.data().password === password;
            else { await setDoc(docRef, { password: 'admin' }); return password === 'admin'; }
        } catch (e) { return false; }
    }

    const passwordActions = {
        'admin_1': async () => {
            const p = prompt("Potwierd≈∫ has≈Çem:"); if(p&&await checkAdminPassword(p)) { localStorage.setItem('defaultView', 'admin'); showModal('Sukces', 'Panel administratora domy≈õlny.'); showAdminView(); }
        },
        'admin_0': async () => {
            const p = prompt("Potwierd≈∫ has≈Çem:"); if(p&&await checkAdminPassword(p)) { localStorage.setItem('defaultView', 'user'); showModal('Sukces', 'Panel u≈ºytkownika domy≈õlny.'); switchToUser(); }
        },
        'passwd': async () => {
            const newPass1 = prompt("Wpisz nowe has≈Ço:"); if (newPass1 === null) return;
            const newPass2 = prompt("Powt√≥rz nowe has≈Ço:"); if (newPass2 === null) return;
            if (newPass1 && newPass1 === newPass2) {
                try {
                    await setDoc(doc(db, `artifacts/${appId}/config/admin`), { password: newPass1 });
                    showModal('Sukces', 'Has≈Ço zosta≈Ço zmienione.');
                } catch (e) { showModal('B≈ÇƒÖd', 'Nie uda≈Ço siƒô zmieniƒá has≈Ça.'); }
            } else { showModal('B≈ÇƒÖd', 'Has≈Ça nie sƒÖ takie same lub pole jest puste.'); }
        },
        // Zapisywanie ustawienia widoczno≈õci cen w localStorage
        'value_1': async () => { const p=prompt("Has≈Ço:"); if(p&&await checkAdminPassword(p)) { showUserPrices=true; localStorage.setItem('showUserPrices','1'); updatePriceVisibility(); showModal('Sukces','Ceny w≈ÇƒÖczone (zapisano).'); }},
        'value_0': async () => { const p=prompt("Has≈Ço:"); if(p&&await checkAdminPassword(p)) { showUserPrices=false; localStorage.setItem('showUserPrices','0'); updatePriceVisibility(); showModal('Sukces','Ceny wy≈ÇƒÖczone (zapisano).'); }},
        'sql': () => {
            showSourceTagsAdmin = !showSourceTagsAdmin;
            showModal('Status', `Widoczno≈õƒá tag√≥w ≈∫r√≥d≈Ça: ${showSourceTagsAdmin ? 'W≈ÇƒÖczona' : 'Wy≈ÇƒÖczona'}`);
            refreshCurrentView();
        },
        'dev': () => window.open('https://psb-app-58090.web.app/', '_blank'),
        'iddqd': () => window.open('https://www.youtube.com/watch?v=dXji8ycMolI', '_blank'),
        'minecraft': () => window.open('https://classic.minecraft.net', '_blank'),
        'jeb_': () => {
            document.body.classList.toggle('jeb-mode');
            const isActive = document.body.classList.contains('jeb-mode');
            showModal('üêë Beeee!', isActive ? 'Tƒôczowy motyw jeb_ aktywowany! üåà' : 'Koniec tƒôczy.');
        },
        'Dinnerbone': () => { document.body.classList.toggle('upside-down-mode'); showModal('üôÉ', 'Do g√≥ry nogami!'); },
        'Grumm': () => { document.body.classList.toggle('upside-down-mode'); showModal('üôÉ', 'Do g√≥ry nogami!'); },
        'help': () => {
            const isAdmin = document.getElementById('admin-view').style.display === 'block';
            let cmds = ['sql', 'dev', 'iddqd', 'minecraft', 'jeb_', 'Dinnerbone', 'Grumm', 'help'];
            if (isAdmin) {
                const adminCmds = ['admin_1', 'admin_0', 'passwd', 'value_1', 'value_0'];
                cmds = [...adminCmds, ...cmds];
            }
            showModal('Dostƒôpne komendy', '- ' + cmds.join('\n- '));
        }
    };

    async function handleCommandPrompt() {
        const userInput = prompt("Wpisz has≈Ço lub komendƒô:");
        if (userInput === null) return;
        if (passwordActions.hasOwnProperty(userInput)) {
            passwordActions[userInput]();
        } else {
            if (await checkAdminPassword(userInput)) { showAdminView(); } else { showModal("B≈ÇƒÖd", "Niepoprawne has≈Ço lub komenda!"); }
        }
    }

    const getSourceTag = (source) => showSourceTagsAdmin ? `<span class="source-tag ${source}">${source}</span>` : '';


    // --- CONTACTS MODULE LOGIC ---

    async function loadCompanies() {
        if (!isAuthReady) return;
        const listEl = document.getElementById('admin-company-list');
        listEl.innerHTML = '≈Åadowanie...';

        try {
            const q = query(collection(db, `artifacts/${appId}/public/data/companies`), orderBy("name"));
            const snapshot = await getDocs(q);
            allCompanies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderCompanyList();
        } catch (e) {
            console.error(e);
            listEl.innerHTML = 'B≈ÇƒÖd pobierania firm. Sprawd≈∫ konsolƒô.';
        }
    }

    function renderCompanyList() {
        const listEl = document.getElementById('admin-company-list');
        const search = document.getElementById('admin-company-search').value.toLowerCase();

        const filtered = allCompanies.filter(c => c.name.toLowerCase().includes(search));

        if (filtered.length === 0) { listEl.innerHTML = '<p style="text-align:center; color:#666;">Brak firm lub brak wynik√≥w wyszukiwania.</p>'; return; }

        listEl.innerHTML = '';
        filtered.forEach(comp => {
            const div = document.createElement('div');
            div.className = 'company-card';
            div.innerHTML = `<span>üè¢ <strong>${comp.name}</strong></span> <span>&rsaquo;</span>`;
            div.onclick = () => openCompanyDetails(comp);

            const delBtn = document.createElement('button');
            delBtn.textContent = 'Usu≈Ñ';
            delBtn.style.marginLeft = '10px';
            delBtn.style.backgroundColor = '#dc3545';
            delBtn.style.fontSize = '0.7em';
            delBtn.style.float = 'right';
            delBtn.onclick = async (e) => {
                e.stopPropagation();
                if(confirm(`UsunƒÖƒá firmƒô ${comp.name} i wszystkie jej kontakty?`)) {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/companies`, comp.id));
                    loadCompanies();
                }
            };
            const rightSpan = div.lastElementChild;
            rightSpan.innerHTML = '';
            rightSpan.appendChild(delBtn);

            listEl.appendChild(div);
        });
    }

    function openCompanyDetails(company) {
        currentCompanyData = company;
        document.getElementById('detail-company-name').textContent = company.name;
        document.getElementById('admin-contacts').classList.remove('active');
        document.getElementById('admin-company-details').classList.add('active');
        renderContactList();
    }

    function renderContactList() {
        const listEl = document.getElementById('admin-contact-list');
        listEl.innerHTML = '';
        const contacts = currentCompanyData.contacts || [];

        if (contacts.length === 0) { listEl.innerHTML = '<p style="text-align:center; color:#666;">Brak kontakt√≥w w tej firmie.</p>'; return; }

        contacts.forEach((contact, index) => {
            const card = document.createElement('div');
            card.className = 'contact-card';

            let html = `<span class="contact-role">${contact.label}</span>`;
            if (contact.phone) html += `<div class="contact-detail">üìû <a href="tel:${contact.phone}">${contact.phone}</a></div>`;
            if (contact.email) html += `<div class="contact-detail">üìß <a href="mailto:${contact.email}">${contact.email}</a></div>`;
            if (contact.note) html += `<div class="contact-detail">üìù <span style="font-style:italic; color:#777;">${contact.note}</span></div>`;

            html += `<div class="contact-actions">
                <button class="edit-contact-btn">Edytuj</button>
                <button class="delete-contact-btn" style="background-color: #dc3545;">Usu≈Ñ</button>
            </div>`;

            card.innerHTML = html;

            card.querySelector('.delete-contact-btn').onclick = async () => {
                if(confirm('UsunƒÖƒá ten kontakt?')) {
                    const updatedContacts = contacts.filter((_, i) => i !== index);
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/companies`, currentCompanyData.id), { contacts: updatedContacts });
                    currentCompanyData.contacts = updatedContacts;
                    renderContactList();
                }
            };

            card.querySelector('.edit-contact-btn').onclick = () => {
                openContactModal(contact, index);
            };

            listEl.appendChild(card);
        });
    }

    function openCompanyModal() {
        document.getElementById('company-name-input').value = '';
        document.getElementById('company-modal').style.display = 'flex';
    }

    function openContactModal(contact = null, index = -1) {
        editingContactIndex = index;
        document.getElementById('contact-label-input').value = contact ? contact.label : '';
        document.getElementById('contact-phone-input').value = contact ? contact.phone : '';
        document.getElementById('contact-email-input').value = contact ? contact.email : '';
        document.getElementById('contact-note-input').value = contact ? contact.note : '';
        document.getElementById('contact-modal').style.display = 'flex';
    }


    // --- INVENTORY ---
    async function loadInventory() {
        if (!isAuthReady) return;
        const localKey = `inventory_data_${appId}`;
        const localMetaKey = `inventory_meta_${appId}`;
        try {
            const metaRef = doc(db, `artifacts/${appId}/public/data/inventory_batches`, 'metadata');
            const metaSnap = await getDoc(metaRef);
            let needsUpdate = true;
            let serverLastUpdate = null;

            if (metaSnap.exists()) {
                const meta = metaSnap.data();
                if (meta.lastUpdate) {
                    serverLastUpdate = meta.lastUpdate.seconds;
                    const dateStr = `Ostatni import: ${new Date(serverLastUpdate * 1000).toLocaleString()}`;
                    const i1=document.getElementById('admin-db-info'), i2=document.getElementById('user-db-info');
                    if(i1) i1.textContent = dateStr; if(i2) i2.textContent = dateStr;

                    const localMeta = localStorage.getItem(localMetaKey);
                    if (localMeta && parseInt(localMeta) === serverLastUpdate) {
                        const cachedData = localStorage.getItem(localKey);
                        if (cachedData) { inventoryData = JSON.parse(cachedData); needsUpdate = false; }
                    }
                }
            }

            if (needsUpdate) {
                const q = collection(db, `artifacts/${appId}/public/data/inventory_batches`);
                const snapshot = await getDocs(q);
                let allItems = [];
                snapshot.forEach(doc => {
                    if (doc.id === 'metadata') return;
                    if (doc.data().products) allItems = allItems.concat(doc.data().products);
                });
                inventoryData = allItems;
                localStorage.setItem(localKey, JSON.stringify(inventoryData));
                if (serverLastUpdate) localStorage.setItem(localMetaKey, serverLastUpdate.toString());
            }
            const isAdmin = document.getElementById('admin-view').style.display === 'block';
            renderInventory(isAdmin);
        } catch (e) { console.error("Inventory error", e); }
    }

    function renderInventory(isAdmin) {
        const prefix = isAdmin ? 'admin' : 'user';
        const listEl = document.getElementById(`${prefix}-inventory-list`);
        const countEl = document.getElementById(`${prefix}-inventory-count`);
        const loadMoreBtn = document.getElementById(`${prefix}-load-more-btn`);
        if(!listEl) return;

        const nameSearchRaw = document.getElementById(`${prefix}-inv-search-name`).value.toLowerCase();
        const codeSearch = document.getElementById(`${prefix}-inv-search-code`).value.toLowerCase();
        const sortValue = document.getElementById(`${prefix}-inv-sort`).value;
        const nameParts = nameSearchRaw.split('%').filter(part => part.trim() !== "");

        let filtered = inventoryData.filter(item => {
            if(!showZeros && item.quantity <= 0) return false;
            const n = item.name ? item.name.toLowerCase() : "";
            const c = item.barcode ? item.barcode.toLowerCase() : "";
            const matchName = nameParts.length === 0 || nameParts.every(part => n.includes(part));
            const matchCode = !codeSearch || c.includes(codeSearch);
            return matchName && matchCode;
        });

        filtered.sort((a, b) => {
            const [key, dir] = sortValue.split('_');
            let valA = key === 'name' ? a.name : (key === 'price' ? a.price : a.quantity);
            let valB = key === 'name' ? b.name : (key === 'price' ? b.price : b.quantity);
            if (typeof valA === 'string') { return dir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA); }
            else { return dir === 'asc' ? valA - valB : valB - valA; }
        });

        const itemsToShow = filtered.slice(0, displayLimit);
        if(countEl) countEl.textContent = `Wy≈õwietlanie ${itemsToShow.length} z ${filtered.length} (ca≈Ço≈õƒá: ${inventoryData.length})`;

        if(loadMoreBtn) {
            if(itemsToShow.length < filtered.length) {
                loadMoreBtn.style.display = 'inline-block';
                loadMoreBtn.onclick = () => { displayLimit += 100; renderInventory(isAdmin); };
            } else { loadMoreBtn.style.display = 'none'; }
        }

        if (itemsToShow.length === 0) { listEl.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px;">Brak wynik√≥w</td></tr>'; return; }

        listEl.innerHTML = itemsToShow.map(item => {
            const qtyClass = item.quantity <= 0 ? 'out' : '';
            return `<tr>
                    <td data-label="Produkt"><strong>${item.name}</strong></td>
                    <td data-label="Kod">${item.barcode || '-'}</td>
                    <td data-label="Ilo≈õƒá"><span class="quantity-badge ${qtyClass}">${item.quantity} szt</span></td>
                    <td data-label="Cena"><span class="price-tag">${parseFloat(item.price).toFixed(2)} z≈Ç</span></td>
                </tr>`;
        }).join('');
    }

    // --- HELPER: Create Task Row DOM Element ---
    function createTaskElement(task, isAdmin, filterPerson) {
        const assigneesList = Array.isArray(task.assignees) ? task.assignees : (typeof task.assignees === 'string' && task.assignees.length > 0 ? task.assignees.split(/[,;]/).map(s => s.trim()) : []);
        if (filterPerson && !assigneesList.includes(filterPerson)) return null;

        const isPriority = task.content.startsWith('!!!');
        const itemDiv = document.createElement('div');
        itemDiv.className = `item-row task-item ${task.done ? 'done' : ''} ${isPriority ? 'priority' : ''}`;
        if (task.source === 'firebase' && task.userAdded) { itemDiv.classList.add('user-submitted'); }
        itemDiv.dataset.taskId = task.id;
        itemDiv.dataset.source = task.source;
        itemDiv.dataset.fullContent = task.content;

        const contentWrapper = document.createElement('div');
        contentWrapper.className = 'item-content-wrapper';
        const mainCheckbox = document.createElement('input');
        mainCheckbox.type = 'checkbox';
        mainCheckbox.checked = task.done;
        mainCheckbox.style.marginRight = '10px';
        mainCheckbox.onchange = async () => {
            const isChecked = mainCheckbox.checked;
            const updateData = { done: isChecked, completedAt: isChecked ? new Date() : null };
            try {
                itemDiv.classList.toggle('done', mainCheckbox.checked);
                if (task.source === 'supabase') { await supabase.from('tasks').update(updateData).eq('id', task.id.replace('supabase-','')); }
                else { await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, task.id), updateData); }
                if (isPriority && mainCheckbox.checked) new Audio('https://raw.githubusercontent.com/coffynerd/task_app/main/GLaDOS-758719.wav').play();
            } catch (error) { mainCheckbox.checked = !mainCheckbox.checked; }
        };

        const taskContentContainer = document.createElement('span');
        taskContentContainer.className = 'task-text-container';
        taskContentContainer.innerHTML = parseTaskContent(isPriority ? task.content.substring(3).trim() : task.content);

        const sourceTag = document.createElement('span');
        if(showSourceTagsAdmin) { sourceTag.innerHTML = getSourceTag(task.source); }

        contentWrapper.append(mainCheckbox, taskContentContainer);
        if(showSourceTagsAdmin) contentWrapper.appendChild(sourceTag);

        if (task.dueDate) {
            const dueDateSpan = document.createElement('span');
            dueDateSpan.classList.add('due-date-text');
            const d = new Date(task.dueDate);
            d.setHours(0,0,0,0);
            const today = new Date();
            today.setHours(0,0,0,0);

            const day = d.getDate().toString().padStart(2, '0');
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            dueDateSpan.textContent = `Wykonaƒá do: ${day}.${month}`;

            if (d <= today && !task.done) itemDiv.classList.add('due-date-warning');
            contentWrapper.appendChild(dueDateSpan);
        }

        const rightSideInfo = document.createElement('div');
        rightSideInfo.className = 'right-aligned-info';
        let completedInfo = '';
        if (task.done && task.completedAt) {
            const cDate = task.completedAt.seconds ? new Date(task.completedAt.seconds * 1000) : new Date(task.completedAt);
            completedInfo = `<div class="date-info" style="color: green;">‚úì ${cDate.toLocaleDateString('pl-PL')}</div>`;
        }
        rightSideInfo.innerHTML = `
            <div class="assignees">Osoby: ${assigneesList.length > 0 ? assigneesList.join(', ') : 'brak'}</div>
            ${task.createdAt ? `<div class="date-info">Dodano: ${new Date(task.createdAt).toLocaleDateString('pl-PL')}</div>` : ''}
            ${completedInfo}
         `;
        itemDiv.append(contentWrapper, rightSideInfo);

        const editHandler = () => { openEditTaskModal(task); };

        if (isAdmin) {
            const buttonsDiv = document.createElement('div');
            buttonsDiv.innerHTML = `<button class="edit-btn">Edytuj</button><button class="toggle-btn">${task.visible === false ? 'Odkryj' : 'Ukryj'}</button><button class="delete-task-btn">Usu≈Ñ</button>`;
            buttonsDiv.querySelector('.edit-btn').onclick = editHandler;
            buttonsDiv.querySelector('.toggle-btn').onclick = async () => {
                const updateData = { visible: !(task.visible !== false) };
                if (task.source === 'supabase') await supabase.from('tasks').update(updateData).eq('id', task.id.replace('supabase-',''));
                else await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, task.id), updateData);
                itemDiv.remove();
            };
            buttonsDiv.querySelector('.delete-task-btn').onclick = async () => {
                if (confirm('Czy na pewno chcesz usunƒÖƒá to zadanie?')) {
                    if (task.source === 'supabase') await supabase.from('tasks').delete().eq('id', task.id.replace('supabase-',''));
                    else await deleteDoc(doc(db, `artifacts/${appId}/public/data/tasks`, task.id));
                    itemDiv.remove();
                }
            };
            itemDiv.appendChild(buttonsDiv);
        } else {
            if (task.source === 'firebase' && task.userAdded) {
                const buttonsDiv = document.createElement('div');
                buttonsDiv.innerHTML = `<button class="edit-btn">Edytuj</button><button class="delete-task-btn">Usu≈Ñ</button>`;
                buttonsDiv.querySelector('.edit-btn').onclick = editHandler;
                buttonsDiv.querySelector('.delete-task-btn').onclick = async () => {
                    if (confirm('Czy na pewno chcesz usunƒÖƒá to zadanie?')) {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/tasks`, task.id));
                        itemDiv.remove();
                    }
                };
                itemDiv.appendChild(buttonsDiv);
            }
        }
        return itemDiv;
    }

    // --- TASKS ---
    async function renderTasks(isAdmin) {
        const listElement = document.getElementById(isAdmin ? 'admin-task-list-visible' : 'user-task-list');
        const hiddenListElement = isAdmin ? document.getElementById('admin-task-list-hidden') : null;
        if (!isAuthReady) { if (listElement) listElement.innerHTML = '≈Åadowanie uwierzytelniania...'; return; }

        const filterPerson = document.getElementById(isAdmin ? 'admin-task-filter-person' : 'user-task-filter-person').value;

        const { data: supabaseTasks } = await supabase.from('tasks').select('*');
        const formattedSupabaseTasks = (supabaseTasks || []).map(task => ({ ...task, source: 'supabase', createdAt: task.created_at, id: `supabase-${task.id}` }));

        const firebaseTasksColRef = collection(db, `artifacts/${appId}/public/data/tasks`);
        const q = query(firebaseTasksColRef, orderBy("createdAt", "desc"), limit(100));

        const firebaseTasksSnapshot = await getDocs(q);
        const firebaseTasks = firebaseTasksSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), source: 'firebase', createdAt: doc.data().createdAt?.toDate() }));

        const allTasks = [...formattedSupabaseTasks, ...firebaseTasks];

        allTasks.sort((a, b) => {
            const aIsPriority = a.content.startsWith('!!!');
            const bIsPriority = b.content.startsWith('!!!');
            if (aIsPriority && !bIsPriority) return -1;
            if (!aIsPriority && bIsPriority) return 1;
            return (b.createdAt ? new Date(b.createdAt) : 0) - (a.createdAt ? new Date(a.createdAt) : 0);
        });

        listElement.innerHTML = '';
        let visibleCount = 0;
        allTasks.forEach(task => {
            if (task.visible === false) return;
            const el = createTaskElement(task, isAdmin, filterPerson);
            if (el) { listElement.appendChild(el); visibleCount++; }
        });
        if (visibleCount === 0) listElement.innerHTML = '<p>Brak zada≈Ñ.</p>';

        if (isAdmin && hiddenListElement) {
            hiddenListElement.innerHTML = '';
            const loadBtn = document.createElement('button');
            loadBtn.textContent = 'Za≈Çaduj ukryte zadania (Archiwum)';
            loadBtn.style.width = '100%';
            loadBtn.style.padding = '10px';
            loadBtn.style.marginBottom = '20px';

            loadBtn.onclick = async () => {
                loadBtn.textContent = 'Pobieranie...';
                loadBtn.disabled = true;
                const qHidden = query(firebaseTasksColRef, where("visible", "==", false));
                const snap = await getDocs(qHidden);
                const hiddenTasks = snap.docs.map(doc => ({ id: doc.id, ...doc.data(), source: 'firebase', createdAt: doc.data().createdAt?.toDate() }));
                hiddenTasks.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                loadBtn.remove();
                if (hiddenTasks.length === 0) {
                    hiddenListElement.innerHTML = '<p>Brak ukrytych zada≈Ñ.</p>';
                } else {
                    hiddenTasks.forEach(task => {
                        const el = createTaskElement(task, isAdmin, filterPerson);
                        if (el) hiddenListElement.appendChild(el);
                    });
                }
            };
            hiddenListElement.parentNode.insertBefore(loadBtn, hiddenListElement);
        }
    }

    // --- HELPER: Create Order Row ---
    function createOrderElement(order, isAdmin) {
        const isPriority = order.name.startsWith('!!!');
        const displayName = isPriority ? order.name.substring(3).trim() : order.name;
        const itemDiv = document.createElement('div');
        itemDiv.className = `item-row order-item ${order.done ? 'done' : ''} ${isPriority ? 'priority' : ''}`;
        itemDiv.dataset.orderId = order.id;

        const contentWrapper = document.createElement('div');
        contentWrapper.className = 'item-content-wrapper';
        const nameSpan = document.createElement('span');
        nameSpan.textContent = displayName;
        contentWrapper.append(nameSpan);

        if(showSourceTagsAdmin) {
            const tag = document.createElement('span');
            tag.innerHTML = getSourceTag(order.source);
            contentWrapper.appendChild(tag);
        }

        const supplierInfo = document.createElement('span');
        supplierInfo.classList.add('supplier-info');
        supplierInfo.textContent = `(${order.supplier || 'brak dostawcy'})`;
        contentWrapper.appendChild(supplierInfo);

        const rightSideInfo = document.createElement('div');
        rightSideInfo.className = 'right-aligned-info';
        rightSideInfo.innerHTML = `${order.createdAt ? `<div class="date-info">${new Date(order.createdAt).toLocaleDateString('pl-PL')}</div>` : ''}`;

        const buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'order-buttons';
        const doneBtn = document.createElement('button');
        doneBtn.textContent = 'Zam√≥wione';
        doneBtn.onclick = async () => {
            if (isPriority) new Audio('https://raw.githubusercontent.com/coffynerd/task_app/main/GLaDOS-770340.wav').play();
            try {
                if (order.source === 'supabase') { await supabase.from('orders').update({ is_completed: true }).eq('id', order.id.replace('supabase-','')); }
                else { await updateDoc(doc(db, `artifacts/${appId}/public/data/orders`, order.id), { done: true }); }
                itemDiv.classList.add('done');
                itemDiv.remove();
            } catch (error) { showModal('B≈ÇƒÖd', 'Nie uda≈Ço siƒô zaktualizowaƒá statusu.'); }
        };
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edytuj';
        editBtn.onclick = async () => {
            const newName = prompt('Nowa nazwa produktu:', order.name);
            if (newName === null) return;
            const newSupplier = prompt('Nowy dostawca:', order.supplier || '');
            if (newSupplier === null) return;
            try {
                if (order.source === 'supabase') { await supabase.from('orders').update({ name: newName, supplier: newSupplier }).eq('id', order.id.replace('supabase-','')); }
                else { await updateDoc(doc(db, `artifacts/${appId}/public/data/orders`, order.id), { name: newName, supplier: newSupplier }); }
                nameSpan.textContent = newName;
                supplierInfo.textContent = `(${newSupplier})`;
            } catch(error) { showModal('B≈ÇƒÖd', 'Nie uda≈Ço siƒô zaktualizowaƒá.'); }
        };
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Usu≈Ñ';
        deleteBtn.className = 'delete-order-btn';
        deleteBtn.onclick = async () => {
            if (confirm('Czy na pewno chcesz usunƒÖƒá tƒô pozycjƒô?')) {
                try {
                    if (order.source === 'supabase') { await supabase.from('orders').delete().eq('id', order.id.replace('supabase-','')); }
                    else { await deleteDoc(doc(db, `artifacts/${appId}/public/data/orders`, order.id)); }
                    itemDiv.remove();
                } catch (error) { showModal('B≈ÇƒÖd', 'Nie uda≈Ço siƒô usunƒÖƒá.'); }
            }
        };

        if (!isAdmin) {
            if (!order.done) { buttonsDiv.appendChild(doneBtn); if (order.source === 'firebase') { buttonsDiv.appendChild(editBtn); } }
        } else {
            if (!order.done) { buttonsDiv.appendChild(editBtn); buttonsDiv.appendChild(doneBtn); }
            buttonsDiv.appendChild(deleteBtn);
        }
        itemDiv.append(contentWrapper, rightSideInfo, buttonsDiv);
        return itemDiv;
    }

    // --- ORDERS ---
    async function renderOrders(isAdmin) {
        const activeListElement = document.getElementById(isAdmin ? 'admin-order-list-active' : 'user-order-list');
        const completedListElement = isAdmin ? document.getElementById('admin-order-list-completed') : null;
        if (!isAuthReady) { if (activeListElement) activeListElement.innerHTML = '≈Åadowanie...'; return; }

        const { data: supabaseOrders } = await supabase.from('orders').select('*').eq('is_completed', false);
        const formattedSupabaseOrders = (supabaseOrders || []).map(order => ({ ...order, done: order.is_completed, source: 'supabase', createdAt: order.created_at, id: `supabase-${order.id}` }));

        const qActive = query(collection(db, `artifacts/${appId}/public/data/orders`), where("done", "==", false));
        const firebaseOrdersSnapshot = await getDocs(qActive);
        const firebaseOrders = firebaseOrdersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), source: 'firebase', createdAt: doc.data().createdAt?.toDate() }));

        const activeOrders = [...formattedSupabaseOrders, ...firebaseOrders];
        activeOrders.sort((a, b) => {
            const aIsPriority = a.name.startsWith('!!!');
            const bIsPriority = b.name.startsWith('!!!');
            if (aIsPriority !== bIsPriority) return aIsPriority ? -1 : 1;
            return (b.createdAt ? new Date(b.createdAt) : 0) - (a.createdAt ? new Date(a.createdAt) : 0);
        });

        activeListElement.innerHTML = '';
        if (activeOrders.length === 0) activeListElement.innerHTML = '<p>Brak pozycji.</p>';
        activeOrders.forEach(order => {
            activeListElement.appendChild(createOrderElement(order, isAdmin));
        });

        if (isAdmin && completedListElement) {
            completedListElement.innerHTML = '';
            const loadBtn = document.createElement('button');
            loadBtn.textContent = 'Poka≈º historiƒô zam√≥wie≈Ñ';
            loadBtn.style.width = '100%';
            loadBtn.style.padding = '10px';
            loadBtn.style.marginBottom = '20px';

            loadBtn.onclick = async () => {
                loadBtn.textContent = 'Pobieranie...';
                loadBtn.disabled = true;
                const qDone = query(collection(db, `artifacts/${appId}/public/data/orders`), where("done", "==", true));
                const snap = await getDocs(qDone);
                const historyOrders = snap.docs.map(doc => ({ id: doc.id, ...doc.data(), source: 'firebase', createdAt: doc.data().createdAt?.toDate() }));
                historyOrders.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                loadBtn.remove();
                if (historyOrders.length === 0) {
                    completedListElement.innerHTML = '<p>Brak historii.</p>';
                } else {
                    historyOrders.forEach(order => {
                        completedListElement.appendChild(createOrderElement(order, isAdmin));
                    });
                }
            };
            completedListElement.parentNode.insertBefore(loadBtn, completedListElement);
        }
    }

    // --- VACATION REQUESTS ---
    async function renderVacationRequests(isAdmin) {
        const userListElement = document.getElementById('user-schedule-request-list');
        const adminVisibleListElement = document.getElementById('admin-schedule-request-list-visible');
        const adminHiddenListElement = document.getElementById('admin-schedule-request-list-hidden');
        if (!isAuthReady) { if(userListElement) userListElement.innerHTML='≈Åadowanie...'; return; }

        const filterPerson = document.getElementById(isAdmin ? 'admin-request-filter-person' : 'user-request-filter-person').value;

        const { data: supabaseRequests } = await supabase.from('vacation_requests').select('*');
        const formattedSupabaseRequests = (supabaseRequests || []).map(req => ({ ...req, source: 'supabase', createdAt: req.created_at, id: `supabase-${req.id}` }));
        const firebaseRequestsSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/vacation_requests`));
        const firebaseRequests = firebaseRequestsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), source: 'firebase', createdAt: doc.data().createdAt?.toDate() }));
        let allRequests = [...formattedSupabaseRequests, ...firebaseRequests];
        allRequests.sort((a, b) => new Date(b.created_at || b.createdAt) - new Date(a.created_at || a.createdAt));

        const renderList = (requestsToRender, targetElement) => {
            if (!targetElement) return;

            const filteredRequests = requestsToRender.filter(req => {
                if (!filterPerson) return true;
                return req.employee_name === filterPerson;
            });

            targetElement.innerHTML = filteredRequests.length === 0 ? '<p>Brak wniosk√≥w.</p>' : '';
            filteredRequests.forEach(req => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `item-row vacation-request`;
                let statusText = 'OczekujƒÖcy', statusColor = 'request-status pending';
                if (req.is_accepted === true) { statusText = 'Zaakceptowany'; statusColor = 'request-status accepted'; itemDiv.classList.add('accepted'); }
                else if (req.rejection_reason) { statusText = 'Odrzucony'; statusColor = 'request-status rejected'; itemDiv.classList.add('rejected'); }
                itemDiv.dataset.id = req.id;
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'item-content-wrapper';
                const sourceTagHtml = getSourceTag(req.source);

                let notesText = req.notes || '';
                if(req.rejection_reason) { notesText += ` (Pow√≥d: ${req.rejection_reason})`; }
                contentWrapper.innerHTML = `<span style="font-weight: bold; flex-shrink: 0; min-width: 150px;">${req.employee_name} ${sourceTagHtml}</span>
                    <span style="margin-left: 15px; flex-shrink: 0;">${req.start_date} do ${req.end_date}</span>
                    <span class="${statusColor}" style="margin-left: 15px;">(${statusText})</span>
                    <span class="request-notes" style="flex-grow: 1; text-align: right; padding: 0 20px;">${notesText}</span>`;
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'right-aligned-info';
                if (isAdmin) {
                    const adminBtnsContainer = document.createElement('div');
                    adminBtnsContainer.innerHTML = `<div style="margin-top: 5px;">
                            <label style="cursor:pointer; margin-right: 10px;"><input type="checkbox" class="accept-chk" ${req.is_accepted ? 'checked' : ''}> Akceptuj</label>
                            <button class="toggle-vis">${req.is_visible !== false ? 'Ukryj' : 'Poka≈º'}</button>
                            <button class="edit-btn">Edytuj</button>
                            ${req.source === 'firebase' ? '<button class="reject-btn" style="background-color: var(--reject-color)!important;">Odrzuƒá</button>' : ''}
                            <button class="del-btn">Usu≈Ñ</button></div>`;
                    adminBtnsContainer.querySelector('.accept-chk').onchange = async (e) => {
                        const u={is_accepted:e.target.checked, rejection_reason:""};
                        if(req.source==='supabase') await supabase.from('vacation_requests').update(u).eq('id', req.id.replace('supabase-',''));
                        else await updateDoc(doc(db, `artifacts/${appId}/public/data/vacation_requests`, req.id), u);
                        renderVacationRequests(isAdmin);
                    };
                    adminBtnsContainer.querySelector('.toggle-vis').onclick = async () => {
                        const u={is_visible:!(req.is_visible!==false)};
                        if(req.source==='supabase') await supabase.from('vacation_requests').update(u).eq('id', req.id.replace('supabase-',''));
                        else await updateDoc(doc(db, `artifacts/${appId}/public/data/vacation_requests`, req.id), u);
                        renderVacationRequests(isAdmin);
                    };
                    adminBtnsContainer.querySelector('.edit-btn').onclick = async () => {
                        const ns=prompt('Od:',req.start_date), ne=prompt('Do:',req.end_date), nn=prompt('Notatka:',req.notes);
                        if(ns&&ne) {
                            const u={start_date:ns,end_date:ne,notes:nn};
                            if(req.source==='supabase') await supabase.from('vacation_requests').update(u).eq('id', req.id.replace('supabase-',''));
                            else await updateDoc(doc(db,`artifacts/${appId}/public/data/vacation_requests`,req.id),u);
                            renderVacationRequests(isAdmin);
                        }
                    };
                    if(adminBtnsContainer.querySelector('.reject-btn')) adminBtnsContainer.querySelector('.reject-btn').onclick = async () => {
                        const r=prompt("Pow√≥d:"); if(r) { await updateDoc(doc(db,`artifacts/${appId}/public/data/vacation_requests`,req.id),{is_accepted:false,rejection_reason:r}); renderVacationRequests(isAdmin); }
                    };
                    adminBtnsContainer.querySelector('.del-btn').onclick = async () => {
                        if(confirm('UsunƒÖƒá?')) {
                            if(req.source==='supabase') await supabase.from('vacation_requests').delete().eq('id',req.id.replace('supabase-',''));
                            else await deleteDoc(doc(db,`artifacts/${appId}/public/data/vacation_requests`,req.id));
                            renderVacationRequests(isAdmin);
                        }
                    };
                    buttonsDiv.appendChild(adminBtnsContainer);
                } else {
                    const userBtnsDiv = document.createElement('div');
                    const userEditBtn = document.createElement('button');
                    userEditBtn.textContent = 'Edytuj';
                    userEditBtn.onclick = async () => {
                        const ns=prompt('Od:',req.start_date), ne=prompt('Do:',req.end_date), nn=prompt('Notatka:',req.notes);
                        if(ns&&ne) {
                            const u={start_date:ns,end_date:ne,notes:nn};
                            await updateDoc(doc(db,`artifacts/${appId}/public/data/vacation_requests`,req.id),u);
                            renderVacationRequests(isAdmin);
                        }
                    };
                    const delBtn = document.createElement('button'); delBtn.textContent='Usu≈Ñ'; delBtn.className='delete-vacation-btn';
                    delBtn.onclick=async()=>{ if(confirm('UsunƒÖƒá?')) { await deleteDoc(doc(db,`artifacts/${appId}/public/data/vacation_requests`,req.id)); renderVacationRequests(isAdmin); }};
                    if (!req.is_accepted && !req.rejection_reason) { userBtnsDiv.append(userEditBtn, delBtn); }
                    buttonsDiv.appendChild(userBtnsDiv);
                }
                itemDiv.append(contentWrapper, buttonsDiv);
                targetElement.appendChild(itemDiv);
            });
        };
        if (isAdmin) {
            const filterStart = document.getElementById('admin-filter-start').value;
            const filterEnd = document.getElementById('admin-filter-end').value;
            let filteredData = allRequests;
            if (filterStart) filteredData = filteredData.filter(req => new Date(req.end_date) >= new Date(filterStart));
            if (filterEnd) filteredData = filteredData.filter(req => new Date(req.start_date) <= new Date(filterEnd));
            renderList(filteredData.filter(req => req.is_visible !== false), adminVisibleListElement);
            renderList(filteredData.filter(req => req.is_visible === false), adminHiddenListElement);
        } else { renderList(allRequests.filter(req => req.is_visible !== false), userListElement); }
    }

    // --- NOTES ---
    async function renderNotes(isAdmin) {
        if (!isAuthReady) return;
        const listEl = document.getElementById(isAdmin ? 'note-title-list' : 'user-note-title-list');
        listEl.innerHTML = '≈Åadowanie...';
        const { data: supabaseNotes = [] } = await supabase.from('notes').select('*');
        const formattedSupabaseNotes = supabaseNotes.map(n => ({ ...n, id: `supabase-${n.id}`, source: 'supabase', createdAt: n.created_at, titleColor: n.title_color, pinned: n.is_pinned, public: n.is_public }));
        const fbPath = `artifacts/${appId}/public/data/notes`;
        const fbSnapshot = await getDocs(collection(db, fbPath));
        const firebaseNotes = fbSnapshot.docs.map(d => ({ ...d.data(), id: d.id, source: 'firebase', createdAt: d.data().createdAt?.toDate() }));
        const allNotes = [...formattedSupabaseNotes, ...firebaseNotes]
            .filter(note => isAdmin || note.public || note.is_public)
            .sort((a, b) => (b.pinned ? 1 : -1) - (a.pinned ? 1 : -1) || (new Date(b.createdAt || b.created_at) - new Date(a.createdAt || a.created_at)));
        listEl.innerHTML = allNotes.length === 0 ? 'Brak notatek.' : '';
        allNotes.forEach(note => {
            const item = document.createElement('div');
            item.className = `note-list-item ${note.pinned ? 'pinned' : ''} ${note.public || note.is_public ? 'public' : ''}`;
            item.dataset.id = note.id;
            item.dataset.source = note.source;
            if ((isAdmin && note.id === currentAdminNoteId) || (!isAdmin && note.id === currentUserNoteId)) item.classList.add('selected');
            const sourceTagHtml = getSourceTag(note.source);
            const titleHtml = `<span class="note-title" style="color:${note.titleColor || note.title_color || 'inherit'}">${note.title} ${sourceTagHtml}</span>
                               <span class="note-list-date">${note.createdAt ? new Date(note.createdAt).toLocaleDateString() : ''}</span>`;
            item.innerHTML = `<div class="note-title-wrapper">${titleHtml}</div>`;
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'note-actions';
            const pinBtn = document.createElement('span');
            pinBtn.className = 'note-pin-btn';
            pinBtn.innerHTML = '&#128204;';
            pinBtn.onclick = (e) => { e.stopPropagation(); handleNoteAction('pin', note, isAdmin); };
            const publishBtn = document.createElement('span');
            publishBtn.className = 'note-publish-btn';
            publishBtn.innerHTML = (note.public || note.is_public) ? '&#128275;' : '&#128274;';
            publishBtn.onclick = (e) => { e.stopPropagation(); handleNoteAction('publish', note, isAdmin); };
            const shareBtn = document.createElement('span');
            shareBtn.className = 'note-share-btn';
            shareBtn.innerHTML = '&#128279;';
            shareBtn.onclick = (e) => { e.stopPropagation(); navigator.clipboard.writeText(`https://publicnotebook.web.app/?uuid=${note.uuid||note.id}`); showModal('Sukces', 'Link skopiowany.'); };
            actionsDiv.appendChild(pinBtn);
            if (isAdmin) { actionsDiv.appendChild(publishBtn); }
            if(note.uuid || note.source === 'firebase') actionsDiv.appendChild(shareBtn);
            item.appendChild(actionsDiv);
            item.onclick = () => {
                checkUnsavedChanges(() => {
                    if (isAdmin) { currentAdminNoteId = note.id; loadAdminNoteIntoEditor(note); }
                    else { currentUserNoteId = note.id; loadUserNoteIntoEditor(note); }
                    document.querySelectorAll('.note-list-item.selected').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                });
            };
            listEl.appendChild(item);
        });
    }

    async function handleNoteAction(action, note, isAdmin) {
        const source = note.source;
        const noteId = source === 'supabase' ? note.id.replace('supabase-', '') : note.id;
        try {
            if (action === 'pin') {
                const newPinnedState = !(note.pinned || note.is_pinned);
                if (source === 'supabase') { await supabase.from('notes').update({ is_pinned: newPinnedState }).eq('id', noteId); }
                else { await updateDoc(doc(db, `artifacts/${appId}/public/data/notes`, noteId), { pinned: newPinnedState }); }
            } else if (action === 'publish') {
                if (isAdmin) {
                    const newPublicState = !(note.public || note.is_public);
                    if(source === 'supabase') { await supabase.from('notes').update({ is_public: newPublicState }).eq('id', noteId); }
                    else { await updateDoc(doc(db, `artifacts/${appId}/public/data/notes`, noteId), { public: newPublicState }); }
                } else { showModal('B≈ÇƒÖd', 'Tylko administrator mo≈ºe zmieniaƒá status publiczny.'); }
            }
            renderNotes(true); renderNotes(false);
        } catch (error) { showModal('B≈ÇƒÖd', 'Akcja nieudana.'); }
    }

    // --- EMPLOYEES & CACHING ---
    async function loadEmployees(forceRefresh = false) {
        if (!isAuthReady) return;
        const cacheKey = `employees_cache_${appId}`;
        const cacheTimeKey = `employees_time_${appId}`;
        const CACHE_DURATION = 24 * 60 * 60 * 1000;
        try {
            const cached = localStorage.getItem(cacheKey);
            const cacheTime = localStorage.getItem(cacheTimeKey);
            const now = Date.now();
            if (!forceRefresh && cached && cacheTime && (now - parseInt(cacheTime) < CACHE_DURATION)) {
                employeeData = JSON.parse(cached);
            } else {
                const snapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/employees`));
                employeeData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                localStorage.setItem(cacheKey, JSON.stringify(employeeData));
                localStorage.setItem(cacheTimeKey, now.toString());
            }
            employeeData.sort((a, b) => (a.lastName||'').localeCompare(b.lastName||'') || (a.firstName||'').localeCompare(b.firstName||''));
            populateEmployeeForms();
            renderEmployeeTable();
        } catch(e) { console.error("Employee load error:", e); }
    }

    // --- HELPER FUNCTIONS ---
    function convertTextToHtml(text) {
        if (!text) return '';
        const lines = text.split('\n');
        let inHtmlBlock = false;
        let htmlContent = '';
        const output = [];
        for (const line of lines) {
            if (line.trim().startsWith('(html){') && !inHtmlBlock) {
                inHtmlBlock = true;
                htmlContent = line.substring(line.indexOf('{') + 1);
                if (line.trim().endsWith('}(html)')) {
                    htmlContent = htmlContent.slice(0, htmlContent.lastIndexOf('}(html)'));
                    output.push(`<div class="raw-html-block">${htmlContent}</div>`);
                    inHtmlBlock = false;
                    htmlContent = '';
                }
                continue;
            }
            if (inHtmlBlock) {
                if (line.trim().endsWith('}(html)')) {
                    htmlContent += '\n' + line.slice(0, line.lastIndexOf('}(html)'));
                    output.push(`<div class="raw-html-block">${htmlContent}</div>`);
                    inHtmlBlock = false;
                    htmlContent = '';
                } else { htmlContent += (htmlContent ? '\n' : '') + line; }
                continue;
            }
            if (line.trim() === '') { output.push('<div><br></div>'); continue; }
            let hasCheckbox = false;
            let isChecked = false;
            let lineContent = line;
            const trimmed = line.trim();
            if (trimmed.startsWith('# ')) { hasCheckbox = true; isChecked = false; lineContent = trimmed.substring(2); }
            else if (trimmed.startsWith('& ')) { hasCheckbox = true; isChecked = true; lineContent = trimmed.substring(2); }
            let renderedContent = lineContent.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            renderedContent = renderedContent.replace(/ean\((.+?)\)/g, (match, content) => {
                const displayCode = content.replace(/[@"']/g, '');
                const escapedMatch = match.replace(/'/g, '&apos;').replace(/"/g, '&quot;');
                return `<span class="ean-barcode" data-ean-source="${escapedMatch}">${displayCode}</span>`;
            });
            renderedContent = renderedContent.replace(/\[(.*?)\]\{(.*?)\}/g, (match, buttonText, link) => {
                let href = link.trim();
                if (!href.startsWith('http://') && !href.startsWith('https://')) href = 'https://' + href;
                const unescapedButtonText = buttonText.replace(/&lt;/g, '<').replace(/&gt;/g, '>');
                return `<a href="${href}" target="_blank"><button>${unescapedButtonText}</button></a>`;
            });
            if (hasCheckbox) { output.push(`<div><input type="checkbox" ${isChecked ? 'checked' : ''}>${renderedContent}</div>`); }
            else { output.push(`<div>${renderedContent}</div>`); }
        }
        if (inHtmlBlock) { output.push(`<div class="raw-html-block">${htmlContent}</div>`); }
        return output.join('');
    }
    function getNodeTextContent(node) {
        let text = '';
        node.childNodes.forEach(child => {
            if (child.nodeType === Node.TEXT_NODE) { text += child.textContent; }
            else if (child.nodeType === Node.ELEMENT_NODE) {
                if (child.tagName === 'BR') { text += '\n'; }
                else if (child.classList.contains('ean-barcode')) { text += child.dataset.eanSource.replace(/&apos;/g, "'").replace(/&quot;/g, '"'); }
                else if (child.tagName === 'A' && child.querySelector('button')) {
                    const button = child.querySelector('button');
                    let href = child.getAttribute('href');
                    if (href.startsWith('https://')) href = href.substring(8);
                    else if (href.startsWith('http://')) href = href.substring(7);
                    text += `[${button.textContent}]{${href}}`;
                } else { text += getNodeTextContent(child); }
            }
        });
        return text;
    }
    function convertRenderedToSource(element) {
        const lines = [];
        element.childNodes.forEach(node => {
            let line = '';
            if (node.nodeType === Node.TEXT_NODE) { line = node.textContent; }
            else if (node.nodeType === Node.ELEMENT_NODE) {
                if (node.innerHTML === '<br>') { lines.push(''); return; }
                if (node.classList.contains('raw-html-block')) { lines.push(`(html){${node.innerHTML}}(html)`); return; }
                const checkbox = node.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    line += checkbox.checked ? '& ' : '# ';
                    const tempNode = node.cloneNode(true);
                    const tempCheckbox = tempNode.querySelector('input[type="checkbox"]');
                    if (tempCheckbox) tempCheckbox.remove();
                    line += getNodeTextContent(tempNode);
                } else { line += getNodeTextContent(node); }
            }
            lines.push(line);
        });
        if (lines.length === 1 && lines[0].trim() === '') { return ''; }
        return lines.join('\n');
    }
    function parseTaskContent(content = '') {
        let index = 0;
        let processedContent = content.replace(/\((#|&)(.*?)\)/g, (match, sign, text) => {
            const isChecked = sign === '&';
            return `<span class="subtask"><input type="checkbox" class="subtask-checkbox" data-index="${index++}" ${isChecked ? 'checked' : ''}><span class="subtask-text ${isChecked ? 'done' : ''}">${text}</span></span>`;
        });
        processedContent = processedContent.replace(/{([^}]+?)}/g, (match, link) => {
            let href = link.trim();
            if (!href.startsWith('http://') && !href.startsWith('https://')) { href = 'https://' + href; }
            return `<a href="${href}" target="_blank" style="margin-left: 10px;"><button>za≈ÇƒÖcznik</button></a>`;
        });
        return processedContent;
    }

    function clearUserEditor() {
        checkUnsavedChanges(() => {
            currentUserNoteId = null;
            document.getElementById('user-note-title-input').value = '';
            document.getElementById('user-note-color-input').value = '#000000';
            document.getElementById('user-note-content-input').innerHTML = '';
            document.getElementById('user-note-content-raw').value = '';
            document.getElementById('user-note-timestamps').textContent = '';
            document.querySelectorAll('#user-note-title-list .selected').forEach(item => item.classList.remove('selected'));
            editorMode.user = 'render';
            document.getElementById('user-note-content-input').style.display = 'block';
            document.getElementById('user-note-content-raw').style.display = 'none';
            lastSavedState = { title: '', content: '' };
        });
    }
    function loadUserNoteIntoEditor(note) {
        currentUserNoteId = note.id;
        document.getElementById('user-note-title-input').value = note.title || '';
        document.getElementById('user-note-color-input').value = note.titleColor || note.title_color || '#000000';
        document.getElementById('user-note-content-input').innerHTML = convertTextToHtml(note.content);
        document.getElementById('user-note-content-raw').value = note.content || '';
        document.getElementById('user-note-timestamps').textContent = note.updatedAt ? `Ostatnia edycja: ${new Date(note.updatedAt.seconds*1000).toLocaleString()}` : '';
        editorMode.user = 'render';
        document.getElementById('user-note-content-input').style.display = 'block';
        document.getElementById('user-note-content-raw').style.display = 'none';
        lastSavedState = { title: note.title||'', content: note.content||'' };
    }
    async function saveUserNote() {
        const title = document.getElementById('user-note-title-input').value.trim();
        if (!title) { showModal('B≈ÇƒÖd', 'Brak tytu≈Çu!'); return; }
        const content = editorMode.user === 'raw' ? document.getElementById('user-note-content-raw').value : convertRenderedToSource(document.getElementById('user-note-content-input'));
        const noteData = { title, content, titleColor: document.getElementById('user-note-color-input').value, updatedAt: new Date() };
        if (currentUserNoteId) {
            if (currentUserNoteId.startsWith('supabase')) { await supabase.from('notes').update({title:noteData.title, content:noteData.content, title_color:noteData.titleColor}).eq('id', currentUserNoteId.replace('supabase-','')); }
            else { await updateDoc(doc(db, `artifacts/${appId}/public/data/notes`, currentUserNoteId), noteData); }
        } else {
            const ref = await addDoc(collection(db, `artifacts/${appId}/public/data/notes`), { ...noteData, createdAt: new Date(), pinned: false, public: true, submittedByUserId: userId, uuid: crypto.randomUUID() });
            currentUserNoteId = ref.id;
        }
        lastSavedState = { title, content }; renderNotes(false); renderNotes(true);
    }
    function clearAdminEditor() {
        checkUnsavedChanges(() => {
            currentAdminNoteId = null;
            document.getElementById('note-title-input').value = '';
            document.getElementById('note-color-input').value = '#000000';
            document.getElementById('note-content-input').innerHTML = '';
            document.getElementById('note-content-raw').value = '';
            document.getElementById('note-timestamps').textContent = '';
            document.querySelectorAll('#note-title-list .selected').forEach(item => item.classList.remove('selected'));
            editorMode.admin = 'render';
            document.getElementById('note-content-input').style.display = 'block';
            document.getElementById('note-content-raw').style.display = 'none';
            lastSavedState = { title: '', content: '' };
        });
    }
    function loadAdminNoteIntoEditor(note) {
        currentAdminNoteId = note.id;
        document.getElementById('note-title-input').value = note.title || '';
        document.getElementById('note-color-input').value = note.titleColor || note.title_color || '#000000';
        document.getElementById('note-content-input').innerHTML = convertTextToHtml(note.content);
        document.getElementById('note-content-raw').value = note.content || '';
        document.getElementById('note-timestamps').textContent = note.updatedAt ? `Edycja: ${new Date(note.updatedAt.seconds*1000).toLocaleString()}` : '';
        editorMode.admin = 'render';
        document.getElementById('note-content-input').style.display = 'block';
        document.getElementById('note-content-raw').style.display = 'none';
        lastSavedState = { title: note.title||'', content: note.content||'' };
    }
    async function saveAdminNote() {
        const title = document.getElementById('note-title-input').value.trim();
        if (!title) { showModal('B≈ÇƒÖd', 'Brak tytu≈Çu'); return; }
        const content = editorMode.admin === 'raw' ? document.getElementById('note-content-raw').value : convertRenderedToSource(document.getElementById('note-content-input'));
        const noteData = { title, content, titleColor: document.getElementById('note-color-input').value, updatedAt: new Date() };
        if (currentAdminNoteId) {
            if (currentAdminNoteId.startsWith('supabase')) await supabase.from('notes').update({title:title,content:content,title_color:noteData.titleColor}).eq('id',currentAdminNoteId.replace('supabase-',''));
            else await updateDoc(doc(db, `artifacts/${appId}/public/data/notes`, currentAdminNoteId), noteData);
        } else {
            const ref = await addDoc(collection(db, `artifacts/${appId}/public/data/notes`), { ...noteData, createdAt: new Date(), pinned: false, public: false, uuid: crypto.randomUUID() });
            currentAdminNoteId = ref.id;
        }
        lastSavedState = { title, content }; renderNotes(true);
    }
    async function deleteAdminNote() {
        if (!currentAdminNoteId || !confirm('UsunƒÖƒá?')) return;
        if(currentAdminNoteId.startsWith('supabase')) await supabase.from('notes').delete().eq('id',currentAdminNoteId.replace('supabase-',''));
        else await deleteDoc(doc(db, `artifacts/${appId}/public/data/notes`, currentAdminNoteId));
        clearAdminEditor(); renderNotes(true);
    }

    async function renderRecurringTasks() {
        const listEl = document.getElementById('recurring-task-list');
        if(!listEl) return;
        listEl.innerHTML = '≈Åadowanie...';
        const recurringTasksSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/recurring_tasks`));
        const recurringTasks = recurringTasksSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        listEl.innerHTML = recurringTasks.length === 0 ? '<p>Brak.</p>' : '';
        const dayNames = ['N/A', 'Pn', 'Wt', '≈ör', 'Cz', 'Pt', 'So', 'Nd'];
        recurringTasks.forEach(task => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item-row';
            itemDiv.innerHTML = `<div class="item-content-wrapper"><span>${task.content}</span><span class="assignees">Osoby: ${task.assignees.join(', ')}</span><span class="assignees">Dni: ${task.days.map(d=>dayNames[d]).join(', ')}</span></div><div><button class="edit-recurring-btn">Edytuj</button><button class="delete-recurring-btn">Usu≈Ñ</button></div>`;
            itemDiv.querySelector('.edit-recurring-btn').onclick = async () => {
                const nc=prompt('Tre≈õƒá',task.content), na=prompt('Osoby',task.assignees.join(';')), nd=prompt('Dni (1-7)',task.days.join(','));
                if(nc&&na&&nd) await updateDoc(doc(db,`artifacts/${appId}/public/data/recurring_tasks`,task.id),{content:nc,assignees:na.split(';'),days:nd.split(',').map(Number)});
                renderRecurringTasks();
            };
            itemDiv.querySelector('.delete-recurring-btn').onclick=async()=>{ if(confirm('UsunƒÖƒá?')) { await deleteDoc(doc(db,`artifacts/${appId}/public/data/recurring_tasks`,task.id)); renderRecurringTasks(); } };
            listEl.appendChild(itemDiv);
        });
    }

    async function checkAndCreateRecurringTasks() {
        if (!isAuthReady) return;
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        let dayOfWeek = today.getDay() === 0 ? 7 : today.getDay();
        const recurringTasksSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/recurring_tasks`));
        let createdAny = false;
        const promises = [];
        recurringTasksSnapshot.forEach(doc => {
            const rt = { id: doc.id, ...doc.data() };
            if (rt.days.includes(dayOfWeek) && rt.lastCreated !== todayStr) {
                createdAny = true;
                promises.push(addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), { content: rt.content, assignees: rt.assignees, createdAt: new Date(), done: false, visible: true }));
                promises.push(updateDoc(doc.ref, { lastCreated: todayStr }));
            }
        });
        await Promise.all(promises);
    }

    function populateEmployeeForms() {
        const activeEmployees = employeeData.filter(e => !e.isArchived);
        ['user-employee-name', 'admin-employee-name'].forEach(id => {
            const select = document.getElementById(id);
            if (!select) return;
            const currentVal = select.value;
            select.innerHTML = '<option value="">Wybierz...</option>';
            activeEmployees.forEach(emp => {
                const opt = document.createElement('option');
                opt.value = `${emp.firstName} ${emp.lastName}`;
                opt.textContent = `${emp.firstName} ${emp.lastName}`;
                select.appendChild(opt);
            });
            if (currentVal) select.value = currentVal;
        });
        ['user-task-filter-person', 'admin-task-filter-person', 'user-request-filter-person', 'admin-request-filter-person'].forEach(id => {
            const select = document.getElementById(id);
            if(!select) return;
            const currentVal = select.value;
            select.innerHTML = '<option value="">Wszyscy</option>';
            activeEmployees.forEach(emp => {
                const opt = document.createElement('option');
                opt.value = id.includes('request') ? `${emp.firstName} ${emp.lastName}` : emp.firstName;
                opt.textContent = opt.value;
                select.appendChild(opt);
            });
            if(currentVal) select.value = currentVal;
        });
        ['user-assignee-container', 'admin-assignee-container'].forEach(id => {
            const container = document.getElementById(id);
            if (!container) return;
            renderCustomDropdown(container, id.includes('user') ? 'user-assignee' : 'admin-assignee');
        });
    }

    function renderCustomDropdown(container, inputName, preselectedValues = []) {
        if (!container) return;
        const activeEmployees = employeeData.filter(e => !e.isArchived);
        container.innerHTML = '';
        container.className = 'custom-dropdown';
        const selectedDiv = document.createElement('div');
        selectedDiv.className = 'dropdown-selected';
        selectedDiv.textContent = 'Wybierz osoby...';
        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'dropdown-options';

        if (activeEmployees.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.style.padding = "8px";
            emptyMsg.textContent = "Brak pracownik√≥w";
            optionsDiv.appendChild(emptyMsg);
        } else {
            activeEmployees.forEach(emp => {
                const label = document.createElement('label');
                label.className = 'dropdown-option';
                const chk = document.createElement('input');
                chk.type = 'checkbox';
                chk.value = emp.firstName;
                chk.name = inputName;
                if (preselectedValues.includes(emp.firstName)) chk.checked = true;
                chk.addEventListener('change', () => updateDropdownText(container, inputName));
                label.onclick = (e) => {
                    if (e.target !== chk) {
                        e.preventDefault();
                        chk.checked = !chk.checked;
                        chk.dispatchEvent(new Event('change'));
                    }
                };
                label.appendChild(chk);
                label.appendChild(document.createTextNode(emp.firstName));
                optionsDiv.appendChild(label);
            });
        }
        selectedDiv.onclick = (e) => {
            e.stopPropagation();
            document.querySelectorAll('.dropdown-options.open').forEach(el => {
                if (el !== optionsDiv) el.classList.remove('open');
            });
            optionsDiv.classList.toggle('open');
        };
        container.appendChild(selectedDiv);
        container.appendChild(optionsDiv);
        updateDropdownText(container, inputName);
    }

    function updateDropdownText(container, inputName) {
        const checked = container.querySelectorAll(`input[name="${inputName}"]:checked`);
        const displayDiv = container.querySelector('.dropdown-selected');
        if (checked.length === 0) { displayDiv.textContent = 'Wybierz osoby...'; }
        else {
            const names = Array.from(checked).map(cb => cb.value);
            if (names.join(', ').length > 25) { displayDiv.textContent = `Wybrano: ${checked.length} os.`; }
            else { displayDiv.textContent = names.join(', '); }
        }
    }

    function renderEmployeeTable() {
        const activeListEl = document.getElementById('admin-employee-list-active');
        const archivedListEl = document.getElementById('admin-employee-list-archived');
        if (!activeListEl) return;
        activeListEl.innerHTML=''; archivedListEl.innerHTML='';
        const createEmpRow = (emp) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = `item-row ${emp.isArchived ? 'done' : ''}`;
            itemDiv.innerHTML = `<div class="item-content-wrapper"><strong>${emp.firstName} ${emp.lastName}</strong>${emp.note?` <span style="color:#666; font-size:0.9em; margin-left:10px;">(${emp.note})</span>`:''}</div>`;
            const btns = document.createElement('div');
            const edit = document.createElement('button'); edit.textContent='Edytuj'; edit.onclick=async()=>{
                const f=prompt('Imiƒô',emp.firstName); if(f===null) return;
                const l=prompt('Nazwisko',emp.lastName); if(l===null) return;
                const n=prompt('Notatka',emp.note); if(n===null) return;
                await updateDoc(doc(db, `artifacts/${appId}/public/data/employees`, emp.id),{firstName:f,lastName:l,note:n}); loadEmployees();
            };
            const arch = document.createElement('button'); arch.textContent=emp.isArchived?'Przywr√≥ƒá':'Archiwizuj'; arch.onclick=async()=>{
                await updateDoc(doc(db,`artifacts/${appId}/public/data/employees`,emp.id),{isArchived:!emp.isArchived}); loadEmployees();
            };
            const del = document.createElement('button'); del.textContent='Usu≈Ñ'; del.className='delete-task-btn'; del.onclick=async()=>{
                if(confirm('UsunƒÖƒá?')) { await deleteDoc(doc(db,`artifacts/${appId}/public/data/employees`,emp.id)); loadEmployees(); }
            };
            btns.append(edit, arch, del); itemDiv.appendChild(btns);
            return itemDiv;
        };
        employeeData.forEach(e => (e.isArchived ? archivedListEl : activeListEl).appendChild(createEmpRow(e)));
        if(activeListEl.innerHTML==='') activeListEl.innerHTML='<p>Brak.</p>';
        if(archivedListEl.innerHTML==='') archivedListEl.innerHTML='<p>Brak.</p>';
    }

    function openEditTaskModal(task) {
        editingTask = task;
        document.getElementById('edit-task-content').value = task.content.startsWith('!!!') ? task.content.substring(3).trim() : task.content;
        document.getElementById('edit-task-date').value = task.dueDate || '';
        let currentAssignees = [];
        if (Array.isArray(task.assignees)) { currentAssignees = task.assignees; }
        else if (typeof task.assignees === 'string' && task.assignees.trim() !== '') { currentAssignees = task.assignees.split(';').map(s => s.trim()); }
        const container = document.getElementById('edit-task-assignees-container');
        renderCustomDropdown(container, 'edit-task-assignee', currentAssignees);
        document.getElementById('edit-task-modal').style.display = 'flex';
    }

    // --- INITIALIZATION ---
    function initUserView() {
        document.getElementById('user-order-form').onsubmit = async (e) => { e.preventDefault();
            await addDoc(collection(db, `artifacts/${appId}/public/data/orders`), { name:document.getElementById('user-order-name').value, supplier:document.getElementById('user-order-supplier').value, done:false, createdAt:new Date(), submittedByUserId:userId });
            e.target.reset(); renderOrders(false);
        };
        document.getElementById('user-new-note-btn').onclick = clearUserEditor;
        document.getElementById('user-save-note-btn').onclick = saveUserNote;
        document.getElementById('user-toggle-raw-btn').onclick = (e) => {
            const ci = document.getElementById('user-note-content-input'), cr = document.getElementById('user-note-content-raw');
            if (editorMode.user === 'render') { cr.value = convertRenderedToSource(ci); ci.style.display = 'none'; cr.style.display = 'block'; editorMode.user = 'raw'; e.target.textContent = 'PodglƒÖd'; }
            else { ci.innerHTML = convertTextToHtml(cr.value); cr.style.display = 'none'; ci.style.display = 'block'; editorMode.user = 'render'; e.target.textContent = 'Kod'; }
        };
        document.getElementById('user-schedule-request-form').onsubmit = async (e) => {
            e.preventDefault(); const f=e.target;
            const empName = f.querySelector('#user-employee-name').value;
            if(!empName) { showModal('B≈ÇƒÖd', 'Wybierz pracownika'); return; }
            await addDoc(collection(db, `artifacts/${appId}/public/data/vacation_requests`), { employee_name:empName, start_date:f.querySelector('#user-start-date').value, end_date:f.querySelector('#user-end-date').value, notes:f.querySelector('#user-vacation-notes').value, is_visible:true, is_accepted:false, createdAt:new Date() });
            showModal('Sukces', 'Wys≈Çano.'); f.reset(); renderVacationRequests(false);
        };
        document.getElementById('user-task-form').onsubmit = async (e) => {
            e.preventDefault(); const f=e.target;
            const checkedBoxes = f.querySelectorAll('input[name="user-assignee"]:checked');
            const assignees = Array.from(checkedBoxes).map(cb => cb.value);
            await addDoc(collection(db,`artifacts/${appId}/public/data/tasks`), { content:f.querySelector('#user-task-input').value, assignees:assignees, done:false, visible:true, createdAt:new Date(), userAdded:true, dueDate:f.querySelector('#user-due-date-input').value });
            f.reset();
            f.querySelectorAll('input[name="user-assignee"]').forEach(cb => cb.checked = false);
            const dropdown = f.querySelector('#user-assignee-container');
            if(dropdown) updateDropdownText(dropdown, 'user-assignee');
            renderTasks(false);
        };
        document.getElementById('user-toggle-zeros-btn').onclick = () => { showZeros=!showZeros; renderInventory(false); };
        document.getElementById('user-task-filter-person').onchange = () => { renderTasks(false); };
        document.getElementById('user-request-filter-person').onchange = () => { renderVacationRequests(false); };
    }

    function initAdminView() {
        document.getElementById('admin-task-form').onsubmit = async (e) => {
            e.preventDefault(); const f=e.target;
            const checkedBoxes = f.querySelectorAll('input[name="admin-assignee"]:checked');
            const assignees = Array.from(checkedBoxes).map(cb => cb.value);
            await addDoc(collection(db,`artifacts/${appId}/public/data/tasks`), { content:f.querySelector('#admin-task-input').value, assignees:assignees, done:false, visible:true, createdAt:new Date(), dueDate:f.querySelector('#admin-due-date-input').value });
            f.reset();
            f.querySelectorAll('input[name="admin-assignee"]').forEach(cb => cb.checked = false);
            const dropdown = f.querySelector('#admin-assignee-container');
            if(dropdown) updateDropdownText(dropdown, 'admin-assignee');
            renderTasks(true);
        };
        document.getElementById('admin-order-form').onsubmit = async (e) => {
            e.preventDefault();
            await addDoc(collection(db,`artifacts/${appId}/public/data/orders`), { name:document.getElementById('admin-order-name').value, supplier:document.getElementById('admin-order-supplier').value, done:false, createdAt:new Date() });
            e.target.reset(); renderOrders(true);
        };
        document.getElementById('new-note-btn').onclick = clearAdminEditor;
        document.getElementById('save-note-btn').onclick = saveAdminNote;
        document.getElementById('delete-note-btn').onclick = deleteAdminNote;
        document.getElementById('admin-toggle-raw-btn').onclick = (e) => {
            const ci = document.getElementById('note-content-input'), cr = document.getElementById('note-content-raw');
            if (editorMode.admin === 'render') { cr.value = convertRenderedToSource(ci); ci.style.display = 'none'; cr.style.display = 'block'; editorMode.admin = 'raw'; e.target.textContent = 'PodglƒÖd'; }
            else { ci.innerHTML = convertTextToHtml(cr.value); cr.style.display = 'none'; ci.style.display = 'block'; editorMode.admin = 'render'; e.target.textContent = 'Kod'; }
        };
        document.getElementById('admin-schedule-request-form').onsubmit = async (e) => {
            e.preventDefault(); const f=e.target;
            const empName = f.querySelector('#admin-employee-name').value;
            if(!empName) { showModal('B≈ÇƒÖd', 'Wybierz pracownika'); return; }
            await addDoc(collection(db, `artifacts/${appId}/public/data/vacation_requests`), { employee_name:empName, start_date:f.querySelector('#admin-start-date').value, end_date:f.querySelector('#admin-end-date').value, notes:f.querySelector('#admin-vacation-notes').value, is_visible:true, is_accepted:false, createdAt:new Date() });
            showModal('Sukces', 'Wys≈Çano.'); f.reset(); renderVacationRequests(true);
        };
        document.getElementById('recurring-task-form').onsubmit = async (e) => {
            e.preventDefault(); const f=e.target;
            const days = Array.from(f.querySelectorAll('input[name="day"]:checked')).map(c=>parseInt(c.value));
            await addDoc(collection(db,`artifacts/${appId}/public/data/recurring_tasks`), { content:f.querySelector('#recurring-task-content').value, assignees:f.querySelector('#recurring-task-assignees').value.split(';'), days, lastCreated:null });
            f.reset(); renderRecurringTasks();
        };
        document.getElementById('admin-toggle-zeros-btn').onclick = () => { showZeros=!showZeros; renderInventory(true); };
        document.getElementById('admin-filter-btn').onclick = () => renderVacationRequests(true);
        document.getElementById('admin-clear-filter-btn').onclick = () => { document.getElementById('admin-filter-start').value=''; document.getElementById('admin-filter-end').value=''; renderVacationRequests(true); };
        document.getElementById('admin-task-filter-person').onchange = () => { renderTasks(true); };
        document.getElementById('admin-request-filter-person').onchange = () => { renderVacationRequests(true); };
        const empForm = document.getElementById('admin-employee-form');
        if (empForm) {
            empForm.onsubmit = async (e) => {
                e.preventDefault();
                const f = document.getElementById('admin-emp-firstname').value.trim();
                const l = document.getElementById('admin-emp-lastname').value.trim();
                const n = document.getElementById('admin-emp-note').value.trim();
                if (!f || !l) { showModal('B≈ÇƒÖd', 'Imiƒô/Nazwisko wymagane'); return; }
                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/employees`), { firstName:f, lastName:l, note:n, isArchived:false, createdAt:new Date() });
                    empForm.reset(); document.getElementById('admin-emp-firstname').focus(); loadEmployees();
                } catch (err) { showModal('B≈ÇƒÖd', err.message); }
            };
        }
        document.getElementById('edit-task-cancel-btn').onclick = () => {
            document.getElementById('edit-task-modal').style.display = 'none'; editingTask = null;
        };
        document.getElementById('edit-task-save-btn').onclick = async () => {
            if (!editingTask) return;
            let newContent = document.getElementById('edit-task-content').value;
            if (editingTask.content.startsWith('!!!')) { newContent = '!!! ' + newContent; }
            const newDueDate = document.getElementById('edit-task-date').value;
            const checkedBoxes = document.querySelectorAll('input[name="edit-task-assignee"]:checked');
            const newAssignees = Array.from(checkedBoxes).map(cb => cb.value);
            const updateData = { content: newContent, assignees: newAssignees, dueDate: newDueDate || null };
            try {
                if (editingTask.source === 'supabase') { await supabase.from('tasks').update(updateData).eq('id', editingTask.id.replace('supabase-','')); }
                else { await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, editingTask.id), updateData); }
                document.getElementById('edit-task-modal').style.display = 'none';
                refreshCurrentView();
            } catch (e) { showModal('B≈ÇƒÖd', 'Nie uda≈Ço siƒô zapisaƒá zmian.'); }
        };

        // --- CONTACTS LISTENERS ---
        document.getElementById('admin-company-search').addEventListener('input', renderCompanyList);

        document.getElementById('add-company-btn').onclick = openCompanyModal;
        document.getElementById('company-modal-cancel').onclick = () => document.getElementById('company-modal').style.display = 'none';

        document.getElementById('company-modal-save').onclick = async () => {
            const name = document.getElementById('company-name-input').value.trim();
            if (!name) return;
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/companies`), {
                    name: name,
                    contacts: [],
                    createdAt: new Date()
                });
                document.getElementById('company-modal').style.display = 'none';
                loadCompanies();
            } catch (e) { showModal('B≈ÇƒÖd', e.message); }
        };

        document.getElementById('back-to-companies-btn').onclick = () => {
            document.getElementById('admin-company-details').classList.remove('active');
            document.getElementById('admin-contacts').classList.add('active');
            currentCompanyData = null;
        };

        document.getElementById('add-contact-btn').onclick = () => openContactModal();
        document.getElementById('contact-modal-cancel').onclick = () => document.getElementById('contact-modal').style.display = 'none';

        document.getElementById('contact-modal-save').onclick = async () => {
            const label = document.getElementById('contact-label-input').value.trim();
            const phone = document.getElementById('contact-phone-input').value.trim();
            const email = document.getElementById('contact-email-input').value.trim();
            const note = document.getElementById('contact-note-input').value.trim();

            if (!label) { alert('Podaj rolƒô/osobƒô!'); return; }

            const newContact = { label, phone, email, note };
            let updatedContacts = [...(currentCompanyData.contacts || [])];

            if (editingContactIndex >= 0) {
                updatedContacts[editingContactIndex] = newContact;
            } else {
                updatedContacts.push(newContact);
            }

            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/companies`, currentCompanyData.id), { contacts: updatedContacts });
                currentCompanyData.contacts = updatedContacts;
                document.getElementById('contact-modal').style.display = 'none';
                renderContactList();
            } catch (e) { showModal('B≈ÇƒÖd', 'Nie uda≈Ço siƒô zapisaƒá kontaktu.'); }
        };
    }

    document.addEventListener('DOMContentLoaded', () => {
        themeToggleButtons = document.querySelectorAll('.theme-toggle-btn');
        if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        updateThemeIcon();

        // INICJALIZACJA WIDOCZNO≈öCI CEN (domy≈õlnie ukryte, chyba ≈ºe localStorage m√≥wi inaczej)
        updatePriceVisibility();

        initUserView(); initAdminView();

        document.querySelectorAll('.refresh-btn').forEach(btn => btn.onclick = refreshCurrentView);
        themeToggleButtons.forEach(btn => btn.onclick = toggleTheme);
        document.querySelectorAll('.hamburger-btn').forEach(btn => { btn.onclick = () => btn.closest('.nav-bar').querySelector('.nav-links').classList.toggle('open'); });

        ['user', 'admin'].forEach(prefix => {
            const render = () => { displayLimit = 100; renderInventory(prefix === 'admin'); };
            document.getElementById(`${prefix}-inv-search-name`)?.addEventListener('input', render);
            document.getElementById(`${prefix}-inv-search-code`)?.addEventListener('input', render);
            document.getElementById(`${prefix}-inv-sort`)?.addEventListener('change', render);
        });

        document.body.addEventListener('click', (e) => {
            const navLink = e.target.closest('a[data-page]');
            if (navLink) { e.preventDefault(); showPage(navLink.dataset.page); }
            if (e.target.closest('#switch-to-admin-btn') || e.target.closest('#admin-commands-btn')) handleCommandPrompt();
            if (e.target.closest('#switch-to-user-btn')) switchToUser();
            if (!e.target.closest('.custom-dropdown')) { document.querySelectorAll('.dropdown-options.open').forEach(el => { el.classList.remove('open'); }); }
        });
        document.getElementById('user-note-content-input').addEventListener('click', (e)=>{if(e.target.closest('a')) window.open(e.target.closest('a').href,'_blank');});
        document.getElementById('note-content-input').addEventListener('click', (e)=>{if(e.target.closest('a')) window.open(e.target.closest('a').href,'_blank');});

        function setupTaskListeners() {
            document.body.addEventListener('change', async (e) => {
                if(e.target.classList.contains('subtask-checkbox')) {
                    const cb = e.target; const row = cb.closest('.item-row');
                    let content = row.dataset.fullContent;
                    let idx = 0, targetIdx = parseInt(cb.dataset.index);
                    const newContent = content.replace(/\((#|&)(.*?)\)/g, (m, s, t) => { if(idx++ === targetIdx) return `(${cb.checked?'&':'#'}${t})`; return m; });
                    try {
                        if(row.dataset.source==='supabase') await supabase.from('tasks').update({content:newContent}).eq('id',row.dataset.taskId.replace('supabase-',''));
                        else await updateDoc(doc(db,`artifacts/${appId}/public/data/tasks`,row.dataset.taskId),{content:newContent});
                        row.dataset.fullContent = newContent; cb.nextElementSibling.classList.toggle('done',cb.checked);
                    } catch(e) { cb.checked=!cb.checked; }
                }
            });
        }
        setupTaskListeners();

        let scannerBuffer = ""; let lastKeyTime = 0;
        document.addEventListener('keydown', (e) => {
            const now = Date.now();
            if (now - lastKeyTime > 300) scannerBuffer = "";
            lastKeyTime = now;
            if (e.key.length === 1) scannerBuffer += e.key;
            if (scannerBuffer.startsWith('@')) {
                if (document.activeElement.tagName === 'INPUT' && document.activeElement.type === 'text') { e.preventDefault(); }
                if (/@\d+/.test(scannerBuffer)) {
                    const code = scannerBuffer.substring(1);
                    const isAdmin = document.getElementById('admin-view').style.display === 'block';
                    const prefix = isAdmin ? 'admin' : 'user';
                    const codeInput = document.getElementById(`${prefix}-inv-search-code`);
                    if(codeInput) {
                        codeInput.value = code;
                        displayLimit = 100;
                        renderInventory(isAdmin);
                        scannerBuffer = "";
                    }
                }
            }
        });
    });
</script>
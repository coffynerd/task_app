<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista Zadań</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f0f2f5;
        }
        .nav-bar {
            overflow: hidden;
            padding: 0 20px;
            color: white;
        }
        .blue-nav { background-color: #004896; }
        .gray-nav { background-color: #6c757d; }
        .nav-bar a {
            float: left;
            display: block;
            color: white;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .blue-nav a:hover {
            background-color: #ffc101;
            color: black;
        }
        .gray-nav a:hover {
            background-color: #5a6268;
        }
        .content {
            padding: 20px 30px;
            display: none;
        }
        .content.active {
            display: block;
        }
        .item-row {
            border-bottom: 1px solid #ddd;
            padding: 10px 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .item-row.done {
            color: red;
            text-decoration: line-through;
            background-color: #f9f9f9;
        }
        .item-content-wrapper {
             display: flex;
             align-items: center;
             flex-grow: 1;
        }
        .assignees, .supplier-info {
            color: #555;
            font-size: 0.9em;
            margin-left: 15px;
        }
        .date-info {
            font-size: 0.8em;
            color: #888;
            margin-left: auto;
            padding-left: 20px;
            text-align: right;
        }
        h2, h3 { color: #333; }
        form { margin-top: 20px; margin-bottom: 20px; background-color: #fff; padding: 15px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        form input { padding: 8px; margin-right: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { margin-left: 10px; cursor: pointer; padding: 8px 12px; border: none; border-radius: 4px; color: white; background-color: #004896; }
        .item-row button { background-color: #6c757d; font-size: 0.8em; padding: 5px 8px; }
        .google-sheet-iframe {
            width: 100%;
            height: 75vh;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .page-header a {
            display: inline-block;
            padding: 8px 16px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        .page-header a:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>

    <div id="user-view">
        <div class="nav-bar blue-nav">
            <a onclick="showPage('user-tasks')">Lista zadań</a>
            <a onclick="showPage('user-order')">Do zamówienia</a>
            <a onclick="showPage('user-schedule')">Grafik</a>
            <a onclick="switchToAdmin()">Panel Administratora</a>
        </div>
        <div id="user-tasks" class="content active">
            <h2>Lista Zadań</h2>
            <div id="supabase-task-list">Ładowanie...</div>
        </div>
        <div id="user-order" class="content">
            <h2>Do zamówienia</h2>
            <form id="user-order-form">
                <input type="text" id="user-order-name" placeholder="Nazwa produktu" required>
                <input type="text" id="user-order-supplier" placeholder="Dostawca">
                <button type="submit">Dodaj do listy</button>
            </form>
            <div id="user-order-list"></div>
        </div>
        <div id="user-schedule" class="content">
            <h2>Grafik</h2>
            <iframe class="google-sheet-iframe" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTDEEc4cmeNHgLhQwp6zAXiUwhzwJSw0DYH-MV0XLEQBs9-2LvsklLOeSHbat4DZexTXeSad5MqzY_e/pubhtml?gid=0&amp;single=true&amp;widget=true&amp;headers=false"></iframe>
        </div>
    </div>

    <div id="admin-view" style="display: none;">
        <div class="nav-bar gray-nav">
            <a onclick="showPage('admin-tasks')">Lista zadań</a>
            <a onclick="showPage('admin-order')">Do zamówienia</a>
            <a onclick="showPage('admin-schedule')">Grafik</a>
            <a onclick="switchToUser()">Panel użytkownika</a>
        </div>
        <div id="admin-tasks" class="content active">
            <h2>Panel Administratora</h2>
            <form id="admin-task-form">
                <h3>Dodaj zadanie</h3>
                <input type="text" id="admin-task-input" placeholder="Treść zadania" required>
                <input type="text" id="admin-assignee-input" placeholder="Pracownicy (oddzieleni średnikiem)">
                <button type="submit">Dodaj</button>
            </form>
            <h3>Lista zadań</h3>
            <div id="admin-task-list-visible">Ładowanie...</div>
            <h3>Zadania ukryte</h3>
            <div id="admin-task-list-hidden"></div>
        </div>
        <div id="admin-order" class="content">
            <h2>Do zamówienia (Admin)</h2>
             <form id="admin-order-form">
                <input type="text" id="admin-order-name" placeholder="Nazwa produktu" required>
                <input type="text" id="admin-order-supplier" placeholder="Dostawca">
                <button type="submit">Dodaj do listy</button>
            </form>
            <h3>Pozycje do zamówienia</h3>
            <div id="admin-order-list-active"></div>
            <h3>Zamówienia zrealizowane</h3>
            <div id="admin-order-list-completed"></div>
        </div>
        <div id="admin-schedule" class="content">
            <div class="page-header">
                <h2>Grafik</h2>
                <a href="https://docs.google.com/spreadsheets/d/1nKe6cmb0Tz60gZykzb1Rw06pq1tG0c2FTdktCS2OYV0/edit?usp=sharing" target="_blank">Edytuj</a>
            </div>
            <iframe class="google-sheet-iframe" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTDEEc4cmeNHgLhQwp6zAXiUwhzwJSw0DYH-MV0XLEQBs9-2LvsklLOeSHbat4DZexTXeSad5MqzY_e/pubhtml?widget=true&headers=false&rm=minimal"></iframe>
        </div>
    </div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // --- GLOBAL STATE AND VIEW MANAGEMENT ---
    let isAdminInitialized = false;
    const supabaseUrl = 'https://ugznhwthaztruazsjbhu.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnem5od3RoYXp0cnVhenNqYmh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NjU4NjAsImV4cCI6MjA2NDA0MTg2MH0.MlBkk-oKSRW7CaUiFf3Edo0KXamVlLaZfLuxGcWL4yU';
    const supabase = createClient(supabaseUrl, supabaseKey);

    function showPage(pageId) {
        document.querySelectorAll('.content').forEach(div => div.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
    }

    function switchToAdmin() {
        const password = prompt("Wpisz hasło administratora:");
        if (password === "admin") {
            document.getElementById('user-view').style.display = 'none';
            document.getElementById('admin-view').style.display = 'block';
            showPage('admin-tasks');
            if (!isAdminInitialized) {
                initAdminView();
                isAdminInitialized = true;
            }
        } else if (password === "dev") {
            window.location.href = 'https://coffynerd.github.io/blazor1';
        } else if (password === "iddqd") {
            window.location.href = 'https://www.youtube.com/watch?v=dXji8ycMolI';
        } else if (password !== null) {
            alert("Niepoprawne hasło!");
        }
    }

    function switchToUser() {
        document.getElementById('admin-view').style.display = 'none';
        document.getElementById('user-view').style.display = 'block';
        showPage('user-tasks');
    }

    window.showPage = showPage;
    window.switchToAdmin = switchToAdmin;
    window.switchToUser = switchToUser;

    // --- USER VIEW LOGIC ---
    function initUserView() {
        // --- Tasks for User ---
        async function renderSupabaseTasks() {
            const { data: tasks, error } = await supabase.from('tasks').select('*');
            const taskList = document.getElementById('supabase-task-list');
            taskList.innerHTML = '';
            if (error) { taskList.innerHTML = 'Błąd ładowania zadań.'; return; }
            
            tasks.filter(task => task.visible !== false).forEach(task => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('item-row');
                itemDiv.classList.toggle('done', task.done);
                
                const contentWrapper = document.createElement('div');
                contentWrapper.classList.add('item-content-wrapper');

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = task.done;
                checkbox.style.marginRight = '10px';
                
                checkbox.addEventListener('change', async () => {
                    await supabase.from('tasks').update({ done: checkbox.checked }).eq('id', task.id);
                    itemDiv.classList.toggle('done', checkbox.checked);
                });

                const taskContent = document.createElement('span');
                taskContent.textContent = task.content;
                
                contentWrapper.appendChild(checkbox);
                contentWrapper.appendChild(taskContent);

                const assignees = document.createElement('div');
                assignees.classList.add('assignees');
                const assigneesList = Array.isArray(task.assignees) ? task.assignees : (typeof task.assignees === 'string' && task.assignees.length > 0 ? task.assignees.split(/[,;]/).map(s => s.trim()) : []);
                assignees.textContent = 'Osoby: ' + (assigneesList.length > 0 ? assigneesList.join(', ') : 'brak');
                
                itemDiv.appendChild(contentWrapper);
                itemDiv.appendChild(assignees);
                taskList.appendChild(itemDiv);
            });
        }

        // --- Orders for User ---
        async function renderUserOrders() {
            const { data: orders, error } = await supabase.from('orders').select('*').eq('is_completed', false).order('created_at', { ascending: true });
            const orderList = document.getElementById('user-order-list');
            orderList.innerHTML = '';
            if (error) { orderList.innerHTML = 'Błąd ładowania listy.'; return; }

            orders.forEach(order => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('item-row');
                
                const contentWrapper = document.createElement('div');
                contentWrapper.classList.add('item-content-wrapper');
                contentWrapper.textContent = order.name;
                
                const supplierInfo = document.createElement('span');
                supplierInfo.classList.add('supplier-info');
                supplierInfo.textContent = `(${order.supplier || 'brak dostawcy'})`;
                contentWrapper.appendChild(supplierInfo);

                const dateInfo = document.createElement('div');
                dateInfo.classList.add('date-info');
                dateInfo.textContent = new Date(order.created_at).toLocaleDateString('pl-PL');

                const buttonsDiv = document.createElement('div');
                const doneBtn = document.createElement('button');
                doneBtn.textContent = 'Zamówione';
                doneBtn.onclick = async () => {
                    await supabase.from('orders').update({ is_completed: true }).eq('id', order.id);
                    renderUserOrders(); 
                };
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edytuj';
                editBtn.onclick = async () => {
                    const newName = prompt("Nowa nazwa produktu:", order.name);
                    const newSupplier = prompt("Nowy dostawca:", order.supplier);
                    if(newName !== null && newSupplier !== null) {
                        await supabase.from('orders').update({ name: newName, supplier: newSupplier }).eq('id', order.id);
                        renderUserOrders();
                    }
                };
                buttonsDiv.appendChild(editBtn);
                buttonsDiv.appendChild(doneBtn);

                itemDiv.appendChild(contentWrapper);
                itemDiv.appendChild(dateInfo);
                itemDiv.appendChild(buttonsDiv);
                orderList.appendChild(itemDiv);
            });
        }
        
        const userOrderForm = document.getElementById('user-order-form');
        userOrderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('user-order-name').value;
            const supplier = document.getElementById('user-order-supplier').value;
            await supabase.from('orders').insert([{ name, supplier }]);
            userOrderForm.reset();
            renderUserOrders();
        });

        renderSupabaseTasks();
        renderUserOrders();
    }

    // --- ADMIN VIEW LOGIC ---
    function initAdminView() {
        // --- Tasks for Admin ---
        const adminTaskList = document.getElementById('admin-task-list-visible');
        const adminHiddenTaskList = document.getElementById('admin-task-list-hidden');
        const adminTaskForm = document.getElementById('admin-task-form');
        async function renderAdminTasks() {
            const { data: tasks, error } = await supabase.from('tasks').select('*');
            adminTaskList.innerHTML = '';
            adminHiddenTaskList.innerHTML = '';
            if (error) { adminTaskList.textContent = 'Błąd ładowania zadań.'; return; }
            
            tasks.forEach(task => {
                const div = document.createElement('div');
                div.classList.add('item-row');
                div.classList.toggle('done', task.done);
                const label = document.createElement('label');
                label.textContent = `${task.content} (Przypisani: ${task.assignees || 'brak'})`;
                const buttonsDiv = document.createElement('div');
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edytuj';
                editBtn.onclick = async () => {
                    const newContent = prompt('Nowa treść zadania:', task.content);
                    const newAssignees = prompt('Nowi przypisani (oddzieleni średnikiem):', task.assignees || '');
                    if (newContent !== null && newAssignees !== null) {
                        await supabase.from('tasks').update({ content: newContent, assignees: newAssignees }).eq('id', task.id);
                        renderAdminTasks();
                    }
                };
                const toggleBtn = document.createElement('button');
                toggleBtn.textContent = task.visible === false ? 'Odkryj' : 'Ukryj';
                toggleBtn.onclick = async () => {
                    await supabase.from('tasks').update({ visible: !task.visible }).eq('id', task.id);
                    renderAdminTasks();
                };
                buttonsDiv.appendChild(editBtn);
                buttonsDiv.appendChild(toggleBtn);
                div.appendChild(label);
                div.appendChild(buttonsDiv);
                (task.visible === false ? adminHiddenTaskList : adminTaskList).appendChild(div);
            });
        }
        adminTaskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = document.getElementById('admin-task-input').value.trim();
            const assignees = document.getElementById('admin-assignee-input').value.trim();
            if (!content) return;
            await supabase.from('tasks').insert([{ content, assignees, done: false, visible: true }]);
            adminTaskForm.reset();
            renderAdminTasks();
        });
        
        // --- Orders for Admin ---
        async function renderAdminOrders() {
            const { data: orders, error } = await supabase.from('orders').select('*').order('created_at', { ascending: true });
            const activeList = document.getElementById('admin-order-list-active');
            const completedList = document.getElementById('admin-order-list-completed');
            activeList.innerHTML = '';
            completedList.innerHTML = '';
            if (error) { activeList.innerHTML = 'Błąd ładowania listy.'; return; }

            orders.forEach(order => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('item-row');
                itemDiv.classList.toggle('done', order.is_completed);

                const contentWrapper = document.createElement('div');
                contentWrapper.classList.add('item-content-wrapper');
                contentWrapper.textContent = order.name;

                const supplierInfo = document.createElement('span');
                supplierInfo.classList.add('supplier-info');
                supplierInfo.textContent = `(${order.supplier || 'brak dostawcy'})`;
                contentWrapper.appendChild(supplierInfo);

                const dateInfo = document.createElement('div');
                dateInfo.classList.add('date-info');
                dateInfo.textContent = new Date(order.created_at).toLocaleDateString('pl-PL');

                const buttonsDiv = document.createElement('div');
                if (!order.is_completed) {
                    const doneBtn = document.createElement('button');
                    doneBtn.textContent = 'Zamówione';
                    doneBtn.onclick = async () => {
                        await supabase.from('orders').update({ is_completed: true }).eq('id', order.id);
                        renderAdminOrders();
                    };
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edytuj';
                    editBtn.onclick = async () => {
                        const newName = prompt("Nowa nazwa produktu:", order.name);
                        const newSupplier = prompt("Nowy dostawca:", order.supplier);
                         if(newName !== null && newSupplier !== null) {
                            await supabase.from('orders').update({ name: newName, supplier: newSupplier }).eq('id', order.id);
                            renderAdminOrders();
                        }
                    };
                    buttonsDiv.appendChild(editBtn);
                    buttonsDiv.appendChild(doneBtn);
                }
                
                itemDiv.appendChild(contentWrapper);
                itemDiv.appendChild(dateInfo);
                itemDiv.appendChild(buttonsDiv);
                
                if(order.is_completed) {
                    completedList.appendChild(itemDiv);
                } else {
                    activeList.appendChild(itemDiv);
                }
            });
        }

        const adminOrderForm = document.getElementById('admin-order-form');
        adminOrderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('admin-order-name').value;
            const supplier = document.getElementById('admin-order-supplier').value;
            await supabase.from('orders').insert([{ name, supplier }]);
            adminOrderForm.reset();
            renderAdminOrders();
        });

        renderAdminTasks();
        renderAdminOrders();
    }
    
    // --- INITIALIZE THE APP ---
    document.addEventListener('DOMContentLoaded', initUserView);
</script>
</body>
</html>

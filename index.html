<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lista Zadań</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      max-width: 600px;
    }
    .task {
      border-bottom: 1px solid #ddd;
      padding: 10px 0;
    }
    .task.done {
      color: #888;
      text-decoration: line-through;
    }
    .assignees {
      color: #555;
      font-size: 0.9em;
    }
  </style>
</head>
<body>

<h2>Lista Zadań</h2>
<div id="taskList"></div>

<script>
const TOKEN = "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";
const owner = "coffynerd";
const repo = "task_app";
const path = "tasks.json";
const branch = "main";

function base64ToUtf8(base64) {
  const binary = atob(base64);
  const bytes = new Uint8Array([...binary].map(ch => ch.charCodeAt(0)));
  return new TextDecoder("utf-8").decode(bytes);
}

function utf8ToBase64(str) {
  const utf8Bytes = new TextEncoder().encode(str);
  let binary = '';
  utf8Bytes.forEach(byte => binary += String.fromCharCode(byte));
  return btoa(binary);
}

async function fetchTasks() {
  const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`);
  if (!response.ok) {
    const errorData = await response.json();
    console.error("Błąd przy pobieraniu zadań:", errorData);
    throw new Error(errorData.message);
  }
  const data = await response.json();
  const decodedContent = base64ToUtf8(data.content);

  let tasksData;
  try {
    tasksData = JSON.parse(decodedContent);
  } catch (e) {
    throw new Error("Nieprawidłowy format JSON w pliku tasks.json");
  }

  if (!Array.isArray(tasksData)) {
    throw new Error("Pobrane dane nie są tablicą");
  }

  tasksData.forEach(task => {
    if (typeof task !== 'object' || task === null ||
        !('done' in task) ||
        !('content' in task) ||
        !('assignees' in task) ||
        !Array.isArray(task.assignees)) {
      throw new Error('Niepoprawna struktura zadania: ' + JSON.stringify(task));
    }
  });

  return { tasks: tasksData, sha: data.sha };
}

async function updateTasks(tasks) {
  const latest = await fetchTasks();
  const content = utf8ToBase64(JSON.stringify(tasks, null, 2));
  const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
    method: "PUT",
    headers: {
      "Authorization": `token ${TOKEN}`,
      "Accept": "application/vnd.github.v3+json",
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "Update tasks status",
      content: content,
      sha: latest.sha,
      branch: branch
    })
  });

  if (!response.ok) {
    const errorData = await response.json();
    console.error("Błąd przy aktualizacji zadań:", errorData);
    throw new Error(errorData.message);
  }

  return response.ok;
}

async function renderTasks() {
  try {
    const { tasks } = await fetchTasks();
    const taskList = document.getElementById("taskList");
    taskList.innerHTML = "";

    tasks.forEach((task, index) => {
      const taskDiv = document.createElement("div");
      taskDiv.classList.add("task");

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = task.done;

      checkbox.addEventListener("change", async () => {
        try {
          const fresh = await fetchTasks();
          if (!Array.isArray(fresh.tasks) || !fresh.tasks[index]) {
            throw new Error("Nie można znaleźć zadania do aktualizacji");
          }
          fresh.tasks[index].done = checkbox.checked;
          await updateTasks(fresh.tasks);
          taskDiv.classList.toggle("done", checkbox.checked);
          alert("Status zadania został zaktualizowany!");
        } catch (error) {
          console.error("Błąd podczas aktualizacji:", error);
          alert("Błąd przy aktualizacji statusu zadania: " + error.message);
          checkbox.checked = !checkbox.checked;
        }
      });

      taskDiv.classList.toggle("done", checkbox.checked);

      const content = document.createElement("span");
      content.textContent = " " + task.content;

      const assignees = document.createElement("div");
      assignees.classList.add("assignees");
      assignees.textContent = "Przypisane osoby: " + task.assignees.join(", ");

      taskDiv.appendChild(checkbox);
      taskDiv.appendChild(content);
      taskDiv.appendChild(assignees);

      taskList.appendChild(taskDiv);
    });
  } catch (error) {
    console.error("Błąd podczas renderowania:", error);
    document.getElementById("taskList").textContent = "Wystąpił błąd przy ładowaniu zadań: " + error.message;
  }
}

renderTasks();
</script>

</body>
</html>

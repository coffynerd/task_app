<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista Zada</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <style>
        :root {
            --background-light: #f0f2f5;
            --background-dark: #121212;
            --text-light: #1c1c1c;
            --text-dark: #e0e0e0;
            --surface-light: #fff;
            --surface-dark: #1e1e1e;
            --border-light: #ddd;
            --border-dark: #333;
            --priority-color: #B8860B; /* Ciemny zoty dla trybu jasnego */
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: var(--background-light);
            color: var(--text-light);
            transition: background-color 0.3s, color 0.3s;
        }
        .nav-bar {
            overflow: visible; /* Changed from hidden for mobile menu */
            padding: 0 20px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between; /* Changed for mobile */
            position: relative;
        }
        .nav-links {
            flex-grow: 1;
        }
        .blue-nav { background-color: #004896; }
        .gray-nav { background-color: #6c757d; }
        .nav-bar a {
            float: left;
            display: block;
            color: white;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .blue-nav a:hover {
            background-color: #ffc101;
            color: black;
        }
        .gray-nav a:hover {
            background-color: #5a6268;
        }
        .nav-actions {
            display: flex;
            align-items: center;
        }
        .theme-toggle-btn, .refresh-btn {
            font-size: 1.5em;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 10px;
            color: white;
        }
        .hamburger-btn {
            display: none; /* Hidden by default */
            font-size: 1.8em;
            background: none;
            border: none;
            cursor: pointer;
            color: white;
        }
        .content {
            padding: 20px 30px;
            display: none;
        }
        .content.active {
            display: block;
        }
        .item-row {
            border-bottom: 1px solid var(--border-light);
            padding: 10px 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 10px;
        }
        .item-row.done {
            color: red;
            text-decoration: line-through;
            background-color: #f9f9f9;
        }
        .item-row.priority {
            color: var(--priority-color);
            font-weight: bold;
        }
        .dark-mode .item-row.priority {
            color: #ffc101; 
        }
        .item-row.priority.done {
            color: red;
        }
        .order-item.done {
            text-decoration: none;
        }
        .item-content-wrapper {
              display: flex;
              align-items: center;
              flex-grow: 1;
        }
        .assignees, .supplier-info {
            color: #555;
            font-size: 0.9em;
            margin-left: 15px;
        }
        .date-info {
            font-size: 0.8em;
            color: #888;
            margin-left: auto;
            padding-left: 20px;
            text-align: right;
            white-space: nowrap;
        }
        .right-aligned-info {
            text-align: right;
        }
        h2, h3 { color: var(--text-light); }
        form { 
            margin-top: 20px; 
            margin-bottom: 20px; 
            background-color: var(--surface-light); 
            padding: 15px; 
            border-radius: 5px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        form input, form textarea { padding: 8px; margin-right: 10px; border: 1px solid #ccc; border-radius: 4px; resize: none; }
        
        .vacation-request-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        .vacation-request-form .vacation-form-row {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1 1 200px;
        }
         .vacation-request-form textarea {
            min-height: 36px;
        }

        .vacation-request-form button {
            margin-left: 0;
        }

        button { margin-left: 10px; cursor: pointer; padding: 8px 12px; border: none; border-radius: 4px; color: white; background-color: #004896; transition: background-color 0.3s; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        .item-row button { background-color: #6c757d; font-size: 0.8em; padding: 5px 8px; }
        .google-sheet-iframe {
            width: 100%;
            height: 75vh;
            border: 1px solid var(--border-light);
            border-radius: 5px;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .page-header a {
            display: inline-block;
            padding: 8px 16px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        .page-header a:hover {
            background-color: #218838;
        }
        
        /* --- DARK MODE STYLES --- */
        body.dark-mode {
            background-color: var(--background-dark);
            color: var(--text-dark);
        }
        .dark-mode h2, .dark-mode h3 { color: var(--text-dark); }
        .dark-mode form {
            background-color: var(--surface-dark);
            border: 1px solid var(--border-dark);
        }
        .dark-mode form input, .dark-mode form textarea, .dark-mode .note-content-input, .dark-mode .raw-editor {
            background-color: #2a2a2a;
            color: var(--text-dark);
            border-color: #444;
        }
        .dark-mode .item-row { border-bottom-color: var(--border-dark); }
        .dark-mode .item-row.done { background-color: #2c1d1d; }
        .dark-mode .assignees, .dark-mode .supplier-info, .dark-mode .date-info { color: #999; }
        .dark-mode .google-sheet-iframe {
            border-color: var(--border-dark);
            filter: invert(90%) hue-rotate(180deg);
        }
        
        /* --- STYLE DLA NOTATNIKA --- */
        .notebook-container { display: flex; gap: 20px; height: 80vh; }
        .note-list-column { flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border-light); padding-right: 20px; }
        .dark-mode .note-list-column { border-right-color: var(--border-dark); }
        .note-editor-column { flex: 3; display: flex; flex-direction: column; }
        .note-editor-content-wrapper { position: relative; flex-grow: 1; display: flex; }
        #new-note-btn, #user-new-note-btn { width: 100%; margin: 0 0 10px 0; }
        #note-title-list, #user-note-title-list { overflow-y: auto; }
        .note-list-item { padding: 10px; border-bottom: 1px solid var(--border-light); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .note-title-wrapper { display: flex; align-items: baseline; flex-grow: 1; overflow: hidden; }
        .note-title { font-weight: bold; font-size: 1.1em; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        .note-list-date {
            font-size: 0.8em;
            font-weight: normal;
            color: #888;
            margin-left: 8px;
            white-space: nowrap;
        }
        .dark-mode .note-list-date { color: #aaa; }
        .note-list-item:hover { background-color: rgba(0, 0, 0, 0.05); }
        .note-list-item.selected { background-color: #cccccc; color: #1c1c1c; }
        .dark-mode .note-list-item:hover { background-color: rgba(255, 255, 255, 0.05); }
        .dark-mode .note-list-item.selected { background-color: #383838; color: #e0e0e0; }
        .note-actions { display: flex; align-items: center; }
        .note-pin-btn, .note-publish-btn { cursor: pointer; opacity: 0.6; font-size: 1.1em; margin-left: 10px; }
        .note-pin-btn:hover, .note-publish-btn:hover { opacity: 1; }
        .note-list-item.pinned .note-pin-btn { opacity: 1; }
        .note-list-item.public .note-publish-btn { opacity: 1; color: #007bff; } 
        .editor-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        #note-title-input, #user-note-title-input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        #note-color-input, #user-note-color-input { height: 35px; padding: 2px; border: 1px solid #ccc; border-radius: 4px; background-color: white; }
        .note-content-input, .raw-editor {
            flex-grow: 1; width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; resize: none;
        }
        .note-content-input { overflow-y: auto; }
        .note-content-input div { display: flex; align-items: center; }
        .note-content-input input[type="checkbox"] { margin-right: 8px; flex-shrink: 0; }
        .note-content-input img, .note-content-input video { max-width: 100%; height: auto; }
        #note-timestamps, #user-note-timestamps { font-size: 0.8em; color: #888; text-align: right; margin-top: 10px; padding-right: 10px; }
        .dark-mode #note-timestamps, .dark-mode #user-note-timestamps { color: #aaa; }
        .note-editor-buttons { margin-top: 10px; text-align: right; }
        #admin-notes button { background-color: #6c757d; }
        #admin-notes button:hover { background-color: #5a6268; }
        #delete-note-btn, .delete-order-btn, .delete-vacation-btn { background-color: #dc3545; }
        #delete-note-btn:hover, .delete-order-btn:hover, .delete-vacation-btn:hover { background-color: #c82333; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-content {
            background: var(--surface-light); color: var(--text-light); padding: 20px; border-radius: 8px; text-align: center; max-width: 90%; width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .dark-mode .modal-content { background: var(--surface-dark); color: var(--text-dark); }
        .modal-content h4 { margin-top: 0; }
        .modal-content p { white-space: pre-wrap; }

        /* --- SUBTASK STYLES --- */
        .subtask {
            display: inline-flex;
            align-items: center;
            margin: 0 5px;
        }
        .subtask-text.done {
            text-decoration: line-through;
        }
        .task-text-container {
             display: inline;
        }
        .vacation-request.accepted {
            background-color: #d4edda;
        }
        .dark-mode .vacation-request.accepted {
            background-color: #1c3d23;
        }
        
        /* --- MOBILE STYLES --- */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                background-color: inherit;
                z-index: 1000;
                box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            }
            .nav-links.open {
                display: flex;
            }
            .nav-bar a {
                float: none;
                text-align: left;
            }
            .nav-bar .nav-links {
                flex-grow: 0; /* Reset flex-grow */
            }
            .hamburger-btn {
                display: block;
            }
            .nav-bar .nav-actions {
                order: 2; /* Move actions to the right */
            }
            .nav-bar .nav-links {
                order: 3; /* Ensure links are below */
                width: 100%;
            }
            .nav-bar::before { /* Pseudo-element for title */
                content: "Lista Zada";
                order: 1;
                flex-grow: 1;
                text-align: left;
            }
            .notebook-container {
                flex-direction: column;
                height: 75vh; /* Adjusted height for mobile */
            }
            .note-list-column {
                border-right: none;
                padding-right: 0;
                border-bottom: 1px solid var(--border-light);
                padding-bottom: 20px;
                margin-bottom: 20px;
                flex-shrink: 0; /* Prevent list from shrinking */
                max-height: 30%; /* Limit list height */
            }
            .dark-mode .note-list-column {
                border-bottom-color: var(--border-dark);
            }
            .content {
                padding: 15px;
            }
            .order-item .order-buttons {
                width: 100%;
                text-align: left;
                padding-top: 5px;
            }
            .order-item .order-buttons button {
                margin-left: 0;
                margin-right: 10px;
            }
            .vacation-request-form {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            .vacation-request-form .vacation-form-row {
                flex: initial;
            }
        }
    </style>
</head>
<body>
    <!-- Modal for alerts and AI responses -->
    <div id="modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h4 id="modal-title"></h4>
            <p id="modal-text"></p>
            <button id="modal-close-btn">Zamknij</button>
        </div>
    </div>

    <div id="user-view">
        <div class="nav-bar blue-nav">
            <div class="nav-links" id="user-nav-links">
                <a onclick="showPage('user-tasks')">Lista zada</a>
                <a onclick="showPage('user-order')">Do zam贸wienia</a>
                <a onclick="showPage('user-schedule')">Grafik</a>
                <a onclick="showPage('user-schedule-requests')">Wnioski do grafiku</a>
                <a onclick="showPage('user-notes')">Notatnik</a>
                <a onclick="switchToAdmin()">Panel Administratora</a>
            </div>
            <div class="nav-actions">
                <button class="refresh-btn" title="Odwie偶 dane"></button>
                <button class="theme-toggle-btn"></button>
                <button class="hamburger-btn" id="user-hamburger-btn">&#9776;</button>
            </div>
        </div>
        <div id="user-tasks" class="content active">
            <h2>Lista Zada</h2>
            <div id="supabase-task-list">adowanie...</div>
        </div>
        <div id="user-order" class="content">
            <h2>Do zam贸wienia</h2>
            <form id="user-order-form">
                <input type="text" id="user-order-name" placeholder="Nazwa produktu" required>
                <input type="text" id="user-order-supplier" placeholder="Dostawca">
                <button type="submit">Dodaj do listy</button>
            </form>
            <div id="user-order-list"></div>
        </div>
        <div id="user-schedule" class="content">
            <h2>Grafik</h2>
            <iframe class="google-sheet-iframe" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTDEEc4cmeNHgLhQwp6zAXiUwhzwJSw0DYH-MV0XLEQBs9-2LvsklLOeSHbat4DZexTXeSad5MqzY_e/pubhtml?gid=0&single=true&widget=true&headers=false"></iframe>
        </div>
        <div id="user-notes" class="content">
            <h2>Notatnik</h2>
            <div class="notebook-container">
                <div class="note-list-column">
                    <button id="user-new-note-btn">+ Nowa notatka</button>
                    <div id="user-note-title-list">Brak notatek</div>
                </div>
                <div class="note-editor-column">
                    <div class="editor-header">
                        <input type="text" id="user-note-title-input" placeholder="Tytu notatki...">
                        <input type="color" id="user-note-color-input" title="Wybierz kolor tytuu" value="#000000">
                    </div>
                    <div class="note-editor-content-wrapper">
                        <div id="user-note-content-input" class="note-content-input" contenteditable="true"></div>
                        <textarea id="user-note-content-raw" class="raw-editor" style="display: none;"></textarea>
                    </div>
                    <div id="user-note-timestamps"></div>
                    <div class="note-editor-buttons">
                        <button id="user-toggle-raw-btn">Edytuj Kod</button>
                        <button id="user-save-note-btn">Zapisz</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="user-schedule-requests" class="content">
            <h2>Z贸偶 wniosek do grafiku</h2>
            <form id="user-schedule-request-form" class="vacation-request-form">
                <div class="vacation-form-row">
                    <label for="user-employee-name">Imi i nazwisko:</label>
                    <input type="text" id="user-employee-name" required>
                </div>
                <div class="vacation-form-row">
                    <label for="user-start-date">Data od:</label>
                    <input type="date" id="user-start-date" required>
                </div>
                <div class="vacation-form-row">
                    <label for="user-end-date">Data do:</label>
                    <input type="date" id="user-end-date" required>
                </div>
                <div class="vacation-form-row">
                    <label for="user-vacation-notes">Notatka:</label>
                    <textarea id="user-vacation-notes"></textarea>
                </div>
                <button type="submit">Wylij wniosek</button>
            </form>
            
            <h3>Zgoszone wnioski</h3>
            <div id="user-schedule-request-list">adowanie...</div>
        </div>
    </div>

    <div id="admin-view" style="display: none;">
        <div class="nav-bar gray-nav">
            <div class="nav-links" id="admin-nav-links">
                <a onclick="showPage('admin-tasks')">Lista zada</a>
                <a onclick="showPage('admin-order')">Do zam贸wienia</a>
                <a onclick="showPage('admin-schedule')">Grafik</a>
                <a onclick="showPage('admin-schedule-requests')">Wnioski do grafiku</a>
                <a onclick="showPage('admin-notes')">Notatnik</a>
                <a onclick="switchToUser()">Panel u偶ytkownika</a>
            </div>
            <div class="nav-actions">
                <button class="refresh-btn" title="Odwie偶 dane"></button>
                <button class="theme-toggle-btn"></button>
                <button class="hamburger-btn" id="admin-hamburger-btn">&#9776;</button>
            </div>
        </div>
        <div id="admin-tasks" class="content">
            <h2>Panel Administratora</h2>
            <form id="admin-task-form">
                <h3>Dodaj zadanie</h3>
                <input type="text" id="admin-task-input" placeholder="Tre zadania" required>
                <input type="text" id="admin-assignee-input" placeholder="Pracownicy (oddzieleni rednikiem)">
                <button type="submit">Dodaj</button>
            </form>
            <h3>Lista zada</h3>
            <div id="admin-task-list-visible">adowanie...</div>
            <h3>Zadania ukryte</h3>
            <div id="admin-task-list-hidden"></div>
        </div>
        <div id="admin-order" class="content">
            <h2>Do zam贸wienia (Admin)</h2>
             <form id="admin-order-form">
                <input type="text" id="admin-order-name" placeholder="Nazwa produktu" required>
                <input type="text" id="admin-order-supplier" placeholder="Dostawca">
                <button type="submit">Dodaj do listy</button>
            </form>
            <h3>Pozycje do zam贸wienia</h3>
            <div id="admin-order-list-active"></div>
            <h3>Zam贸wienia zrealizowane</h3>
            <div id="admin-order-list-completed"></div>
        </div>
        <div id="admin-schedule" class="content">
            <div class="page-header">
                <h2>Grafik</h2>
                <a href="https://docs.google.com/spreadsheets/d/1nKe6cmb0Tz60gZykzb1Rw06pq1tG0c2FTdktCS2OYV0/edit?usp=sharing" target="_blank">Edytuj</a>
            </div>
            <iframe class="google-sheet-iframe" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTDEEc4cmeNHgLhQwp6zAXiUwhzwJSw0DYH-MV0XLEQBs9-2LvsklLOeSHbat4DZexTXeSad5MqzY_e/pubhtml?widget=true&headers=false&rm=minimal"></iframe>
        </div>
        <div id="admin-notes" class="content">
            <h2>Notatnik</h2>
            <div class="notebook-container">
                <div class="note-list-column">
                    <button id="new-note-btn">+ Nowa notatka</button>
                    <div id="note-title-list">adowanie...</div>
                </div>
                <div class="note-editor-column">
                    <div class="editor-header">
                        <input type="text" id="note-title-input" placeholder="Tytu notatki...">
                        <input type="color" id="note-color-input" title="Wybierz kolor tytuu">
                    </div>
                     <div class="note-editor-content-wrapper">
                        <div id="note-content-input" class="note-content-input" contenteditable="true"></div>
                        <textarea id="note-content-raw" class="raw-editor" style="display: none;"></textarea>
                    </div>
                    <div id="note-timestamps"></div>
                    <div class="note-editor-buttons">
                        <button id="admin-toggle-raw-btn">Edytuj Kod</button>
                        <button id="delete-note-btn">Usu</button>
                        <button id="save-note-btn">Zapisz</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="admin-schedule-requests" class="content">
            <h2>Z贸偶 wniosek do grafiku</h2>
            <form id="admin-schedule-request-form" class="vacation-request-form">
                <div class="vacation-form-row">
                    <label for="admin-employee-name">Imi i nazwisko:</label>
                    <input type="text" id="admin-employee-name" required>
                </div>
                <div class="vacation-form-row">
                    <label for="admin-start-date">Data od:</label>
                    <input type="date" id="admin-start-date" required>
                </div>
                <div class="vacation-form-row">
                    <label for="admin-end-date">Data do:</label>
                    <input type="date" id="admin-end-date" required>
                </div>
                <div class="vacation-form-row">
                    <label for="admin-vacation-notes">Notatka:</label>
                    <textarea id="admin-vacation-notes"></textarea>
                </div>
                <button type="submit">Wylij wniosek</button>
            </form>
            <h2>Zarzdzaj wnioskami</h2>
            <div class="filter-container" style="margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                <label for="admin-filter-start">Filtruj od:</label>
                <input type="date" id="admin-filter-start">
                <label for="admin-filter-end">do:</label>
                <input type="date" id="admin-filter-end">
                <button id="admin-filter-btn">Filtruj</button>
                <button id="admin-clear-filter-btn">Wyczy</button>
            </div>
            <div id="admin-schedule-request-list">adowanie...</div>
        </div>
    </div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // --- GLOBAL STATE AND VIEW MANAGEMENT ---
    let isAdminInitialized = false;
    const supabaseUrl = 'https://ugznhwthaztruazsjbhu.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnem5od3RoYXp0cnVhenNqYmh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NjU4NjAsImV4cCI6MjA2NDA0MTg2MH0.MlBkk-oKSRW7CaUiFf3Edo0KXamVlLaZfLuxGcWL4yU';
    const supabase = createClient(supabaseUrl, supabaseKey);
    let editorMode = { user: 'render', admin: 'render' }; // 'render' or 'raw'

    // --- UI UTILITIES ---
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalText = document.getElementById('modal-text');
    document.getElementById('modal-close-btn').onclick = () => modal.style.display = 'none';

    function showModal(title, text) {
        modalTitle.textContent = title;
        modalText.textContent = text;
        modal.style.display = 'flex';
    }

    function showPage(pageId) {
        document.querySelectorAll('.content').forEach(div => div.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        // Close mobile menu on navigation
        document.getElementById('user-nav-links').classList.remove('open');
        document.getElementById('admin-nav-links').classList.remove('open');
    }

    const themeToggleButtons = document.querySelectorAll('.theme-toggle-btn');
    function updateThemeIcon() {
        const isDarkMode = document.body.classList.contains('dark-mode');
        themeToggleButtons.forEach(btn => { btn.innerHTML = isDarkMode ? '&#9728;&#65039;' : '&#127769;'; });
    }
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        updateThemeIcon();
    }
    
    const passwordActions = {
        'admin': () => {
            document.getElementById('user-view').style.display = 'none';
            document.getElementById('admin-view').style.display = 'block';
            showPage('admin-tasks');
            if (!isAdminInitialized) { initAdminView(); isAdminInitialized = true; }
        },
        'dev': () => window.location.href = 'https://coffynerd.github.io/blazor1',
        'iddqd': () => window.location.href = 'https://www.youtube.com/watch?v=dXji8ycMolI',
        'minecraft': () => window.location.href = 'https://classic.minecraft.net',
        'help': () => {
            const availablePasswords = Object.keys(passwordActions).filter(p => p !== 'help');
            showModal('Dostpne Hasa', '- ' + availablePasswords.join('\n- '));
        }
    };

    function switchToAdmin() {
        const password = prompt("Wpisz haso administratora:");
        if (password === null) return;
        if (passwordActions.hasOwnProperty(password)) {
            passwordActions[password]();
        } else {
            showModal("Bd", "Niepoprawne haso!");
        }
    }

    function switchToUser() {
        document.getElementById('admin-view').style.display = 'none';
        document.getElementById('user-view').style.display = 'block';
        showPage('user-tasks');
    }

    window.showPage = showPage;
    window.switchToAdmin = switchToAdmin;
    window.switchToUser = switchToUser;
    
    // --- NOTEBOOK HELPERS ---
    function convertTextToHtml(text) {
        if (!text) return '';
        
        const buttonRegex = /\[(.*?)\]\{(.*?)\}/g;
        
        const lines = text.split('\n');
        const htmlLines = lines.map(line => {
            let processedLine = line;
            const trimmed = line.trim();

            if (trimmed.startsWith('# ')) {
                return `<div><input type="checkbox">${trimmed.substring(2)}</div>`;
            } else if (trimmed.startsWith('& ')) {
                return `<div><input type="checkbox" checked>${trimmed.substring(2)}</div>`;
            }

            processedLine = processedLine.replace(buttonRegex, (match, buttonText, link) => {
                let href = link.trim();
                if (!href.startsWith('http://') && !href.startsWith('https://')) {
                    href = 'https://' + href;
                }
                return `<a href="${href}" target="_blank"><button>${buttonText}</button></a>`;
            });

            return `<div>${processedLine}</div>`;
        });
        return htmlLines.join('');
    }

    function convertRenderedToSource(element) {
        const lines = [];
        element.childNodes.forEach(child => {
            if (child.nodeName === 'DIV') {
                const checkbox = child.querySelector('input[type="checkbox"]');
                const link = child.querySelector('a');
                const button = link ? link.querySelector('button') : null;

                if (checkbox) {
                    const prefix = checkbox.checked ? '& ' : '# ';
                    lines.push(prefix + child.textContent);
                } else if (link && button) {
                    const buttonText = button.textContent;
                    let href = link.getAttribute('href');
                    if (href.startsWith('https://')) {
                        href = href.substring(8);
                    } else if (href.startsWith('http://')) {
                        href = href.substring(7);
                    }
                    lines.push(`[${buttonText}]{${href}}`);
                } else {
                    lines.push(child.innerHTML);
                }
            }
        });
        return lines.join('\n');
    }

    // --- TASK HELPERS ---
    function parseTaskContent(content) {
        if (!content) return '';
        const subtaskRegex = /\((#|&)(.*?)\)/g;
        let index = 0;
        return content.replace(subtaskRegex, (match, sign, text) => {
            const isChecked = sign === '&';
            const textSpan = `<span class="subtask-text ${isChecked ? 'done' : ''}">${text}</span>`;
            const checkbox = `<input type="checkbox" class="subtask-checkbox" data-index="${index++}" ${isChecked ? 'checked' : ''}>`;
            return `<span class="subtask">${checkbox}${textSpan}</span>`;
        });
    }

    // --- RENDER FUNCTIONS (GLOBAL SCOPE) ---

    async function renderSupabaseTasks(listElement, isAdmin) {
        const { data: tasks, error } = await supabase.from('tasks').select('*');
        if (error) { 
            if(listElement) listElement.innerHTML = 'Bd adowania zada.';
            return; 
        }
        tasks.sort((a, b) => { const aIsPriority = a.content.startsWith('!!!'); const bIsPriority = b.content.startsWith('!!!'); if (aIsPriority && !bIsPriority) return -1; if (!aIsPriority && bIsPriority) return 1; if (a.created_at && b.created_at) { return new Date(b.created_at) - new Date(a.created_at); } return 0; });
        
        const renderList = (tasksToRender, targetElement) => {
            targetElement.innerHTML = '';
            tasksToRender.forEach(task => {
                const isPriority = task.content.startsWith('!!!');
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('item-row', 'task-item');
                itemDiv.classList.toggle('done', task.done);
                if (isPriority) itemDiv.classList.add('priority');
                itemDiv.dataset.taskId = task.id;
                itemDiv.dataset.fullContent = task.content;

                const contentWrapper = document.createElement('div');
                contentWrapper.classList.add('item-content-wrapper');

                const mainCheckbox = document.createElement('input');
                mainCheckbox.type = 'checkbox';
                mainCheckbox.checked = task.done;
                mainCheckbox.style.marginRight = '10px';
                mainCheckbox.addEventListener('change', async () => { const { error } = await supabase.from('tasks').update({ done: mainCheckbox.checked }).eq('id', task.id); if(error){ showModal('Bd', 'Bd aktualizacji!'); mainCheckbox.checked = !mainCheckbox.checked; } else { itemDiv.classList.toggle('done', mainCheckbox.checked); if (isPriority && mainCheckbox.checked) { const audio = new Audio('https://raw.githubusercontent.com/coffynerd/task_app/main/GLaDOS-758719.wav'); audio.play(); } } });
                
                const taskContentContainer = document.createElement('span');
                taskContentContainer.classList.add('task-text-container');
                
                let contentToParse = task.content;
                if (isPriority) {
                    contentToParse = task.content.substring(3).trim();
                }
                taskContentContainer.innerHTML = parseTaskContent(contentToParse);
                
                contentWrapper.appendChild(mainCheckbox);
                contentWrapper.appendChild(taskContentContainer);
                
                const rightSideInfo = document.createElement('div');
                rightSideInfo.classList.add('right-aligned-info');
                const assignees = document.createElement('div');
                assignees.classList.add('assignees');
                const assigneesList = Array.isArray(task.assignees) ? task.assignees : (typeof task.assignees === 'string' && task.assignees.length > 0 ? task.assignees.split(/[,;]/).map(s => s.trim()) : []);
                assignees.textContent = 'Osoby: ' + (assigneesList.length > 0 ? assigneesList.join(', ') : 'brak');
                rightSideInfo.appendChild(assignees);
                if (task.created_at) { const dateInfo = document.createElement('div'); dateInfo.classList.add('date-info'); dateInfo.textContent = new Date(task.created_at).toLocaleDateString('pl-PL'); rightSideInfo.appendChild(dateInfo); }
                itemDiv.appendChild(contentWrapper);
                itemDiv.appendChild(rightSideInfo);

                 if (isAdmin) {
                    const buttonsDiv = document.createElement('div');
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edytuj';
                    editBtn.onclick = async () => { const newContent = prompt('Nowa tre zadania:', task.content); const newAssignees = prompt('Nowi przypisani (oddzieleni rednikiem):', task.assignees || ''); if (newContent !== null && newAssignees !== null) { await supabase.from('tasks').update({ content: newContent, assignees: newAssignees }).eq('id', task.id); refreshAllData(); } };
                    const toggleBtn = document.createElement('button');
                    toggleBtn.textContent = task.visible === false ? 'Odkryj' : 'Ukryj';
                    toggleBtn.onclick = async () => { await supabase.from('tasks').update({ visible: !task.visible }).eq('id', task.id); refreshAllData(); };
                    buttonsDiv.appendChild(editBtn);
                    buttonsDiv.appendChild(toggleBtn);
                    itemDiv.appendChild(buttonsDiv);
                }

                targetElement.appendChild(itemDiv);
            });
        };

        if(isAdmin) {
             const visibleTasks = tasks.filter(t => t.visible !== false);
             const hiddenTasks = tasks.filter(t => t.visible === false);
             renderList(visibleTasks, document.getElementById('admin-task-list-visible'));
             renderList(hiddenTasks, document.getElementById('admin-task-list-hidden'));
        } else {
             const visibleTasks = tasks.filter(t => t.visible !== false);
             renderList(visibleTasks, listElement);
        }
    }

    async function renderUserOrders() {
        const { data: orders, error } = await supabase.from('orders').select('*').eq('is_completed', false).order('created_at', { ascending: true });
        const orderList = document.getElementById('user-order-list');
        orderList.innerHTML = '';
        if (error) { orderList.innerHTML = 'Bd adowania listy.'; return; }
        orders.forEach(order => {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('item-row', 'order-item');
            const contentWrapper = document.createElement('div');
            contentWrapper.classList.add('item-content-wrapper');
            contentWrapper.textContent = order.name;
            const supplierInfo = document.createElement('span');
            supplierInfo.classList.add('supplier-info');
            supplierInfo.textContent = `(${order.supplier || 'brak dostawcy'})`;
            contentWrapper.appendChild(supplierInfo);
            const dateInfo = document.createElement('div');
            dateInfo.classList.add('date-info');
            dateInfo.textContent = new Date(order.created_at).toLocaleDateString('pl-PL');
            const buttonsDiv = document.createElement('div');
            buttonsDiv.classList.add('order-buttons');
            const doneBtn = document.createElement('button');
            doneBtn.textContent = 'Zam贸wione';
            doneBtn.onclick = async () => { await supabase.from('orders').update({ is_completed: true }).eq('id', order.id); renderUserOrders(); };
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Edytuj';
            editBtn.onclick = async () => { const newName = prompt("Nowa nazwa produktu:", order.name); const newSupplier = prompt("Nowy dostawca:", order.supplier); if(newName !== null && newSupplier !== null) { await supabase.from('orders').update({ name: newName, supplier: newSupplier }).eq('id', order.id); renderUserOrders(); } };
            buttonsDiv.appendChild(editBtn);
            buttonsDiv.appendChild(doneBtn);
            itemDiv.appendChild(contentWrapper);
            itemDiv.appendChild(dateInfo);
            itemDiv.appendChild(buttonsDiv);
            orderList.appendChild(itemDiv);
        });
    }

    async function renderUserNotes() { 
        const userNoteTitleList = document.getElementById('user-note-title-list');
        const { data: notes, error } = await supabase.from('notes').select('*').eq('is_public', true).order('is_pinned', { ascending: false }).order('updated_at', { ascending: true }); 
        if (error) { userNoteTitleList.innerHTML = 'Bd adowania notatek.'; return; } 
        userNoteTitleList.innerHTML = ''; 
        if (notes.length === 0) { userNoteTitleList.innerHTML = 'Brak notatek.'; return; } 
        notes.forEach(note => { 
            const item = document.createElement('div'); 
            item.classList.add('note-list-item'); 
            item.classList.toggle('pinned', note.is_pinned); 
            item.dataset.noteId = note.id; 
            const titleWrapper = document.createElement('div');
            titleWrapper.classList.add('note-title-wrapper');
            const titleSpan = document.createElement('span'); 
            titleSpan.classList.add('note-title'); 
            titleSpan.textContent = note.title || 'Nowa notatka'; 
            titleSpan.style.color = note.title_color || 'inherit'; 
            const dateSpan = document.createElement('span');
            dateSpan.classList.add('note-list-date');
            const displayDate = note.updated_at || note.created_at;
            dateSpan.textContent = `(${new Date(displayDate).toLocaleDateString('pl-PL')})`;
            titleWrapper.appendChild(titleSpan);
            titleWrapper.appendChild(dateSpan);
            const actionsWrapper = document.createElement('div');
            actionsWrapper.classList.add('note-actions');
            const pinBtn = document.createElement('span');
            pinBtn.classList.add('note-pin-btn');
            pinBtn.innerHTML = '&#128204;';
            pinBtn.title = 'Przypnij/Odepnij';
            pinBtn.onclick = async (e) => {
                e.stopPropagation();
                await supabase.from('notes').update({ is_pinned: !note.is_pinned }).eq('id', note.id);
                renderUserNotes();
            };
            actionsWrapper.appendChild(pinBtn);
            item.appendChild(titleWrapper); 
            item.appendChild(actionsWrapper);
            item.onclick = () => loadUserNoteIntoEditor(note); 
            userNoteTitleList.appendChild(item); 
        }); 
        const currentUserNoteId = document.getElementById('user-note-title-input').dataset.currentId;
        if(currentUserNoteId) { const selectedItem = userNoteTitleList.querySelector(`[data-note-id='${currentUserNoteId}']`); if(selectedItem) selectedItem.classList.add('selected'); } 
    }

    async function renderAdminOrders() {
        const { data: orders, error } = await supabase.from('orders').select('*').order('created_at', { ascending: true });
        const activeList = document.getElementById('admin-order-list-active');
        const completedList = document.getElementById('admin-order-list-completed');
        activeList.innerHTML = '';
        completedList.innerHTML = '';
        if (error) { activeList.innerHTML = 'Bd adowania listy.'; return; }
        orders.forEach(order => {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('item-row', 'order-item');
            itemDiv.classList.toggle('done', order.is_completed);
            const contentWrapper = document.createElement('div');
            contentWrapper.classList.add('item-content-wrapper');
            contentWrapper.textContent = order.name;
            const supplierInfo = document.createElement('span');
            supplierInfo.classList.add('supplier-info');
            supplierInfo.textContent = `(${order.supplier || 'brak dostawcy'})`;
            contentWrapper.appendChild(supplierInfo);
            const dateInfo = document.createElement('div');
            dateInfo.classList.add('date-info');
            dateInfo.textContent = new Date(order.created_at).toLocaleDateString('pl-PL');
            const buttonsDiv = document.createElement('div');
            buttonsDiv.classList.add('order-buttons');
            
            if (!order.is_completed) {
                const doneBtn = document.createElement('button');
                doneBtn.textContent = 'Zam贸wione';
                doneBtn.onclick = async () => { await supabase.from('orders').update({ is_completed: true }).eq('id', order.id); renderAdminOrders(); };
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edytuj';
                editBtn.onclick = async () => { const newName = prompt("Nowa nazwa produktu:", order.name); const newSupplier = prompt("Nowy dostawca:", order.supplier); if(newName !== null && newSupplier !== null) { await supabase.from('orders').update({ name: newName, supplier: newSupplier }).eq('id', order.id); renderAdminOrders(); } };
                buttonsDiv.appendChild(editBtn);
                buttonsDiv.appendChild(doneBtn);
            }

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Usu';
            deleteBtn.classList.add('delete-order-btn');
            deleteBtn.onclick = async () => { 
                if (confirm('Czy na pewno chcesz usun ten element?')) {
                    await supabase.from('orders').delete().eq('id', order.id); 
                    renderAdminOrders(); 
                }
            };
            buttonsDiv.appendChild(deleteBtn);

            itemDiv.appendChild(contentWrapper);
            itemDiv.appendChild(dateInfo);
            itemDiv.appendChild(buttonsDiv);
            if(order.is_completed) { completedList.appendChild(itemDiv); } else { activeList.appendChild(itemDiv); }
        });
    }

    async function renderNotes() { 
        const noteTitleList = document.getElementById('note-title-list');
        const { data, error } = await supabase.from('notes').select('*').order('is_pinned', { ascending: false }).order('updated_at', { ascending: true }); 
        if (error) { noteTitleList.innerHTML = 'Bd adowania notatek.'; return; } 
        noteTitleList.innerHTML = ''; 
        data.forEach(note => { 
            const item = document.createElement('div'); 
            item.classList.add('note-list-item'); 
            item.classList.toggle('pinned', note.is_pinned); 
            item.classList.toggle('public', note.is_public); 
            item.dataset.noteId = note.id; 
            const titleWrapper = document.createElement('div'); 
            titleWrapper.classList.add('note-title-wrapper'); 
            const titleSpan = document.createElement('span'); 
            titleSpan.classList.add('note-title'); 
            titleSpan.textContent = note.title || 'Nowa notatka'; 
            titleSpan.style.color = note.title_color || 'inherit'; 
            const dateSpan = document.createElement('span'); 
            dateSpan.classList.add('note-list-date'); 
            const displayDate = note.updated_at || note.created_at; 
            dateSpan.textContent = `(${new Date(displayDate).toLocaleDateString('pl-PL')})`; 
            titleWrapper.appendChild(titleSpan); 
            titleWrapper.appendChild(dateSpan); 
            const actionsWrapper = document.createElement('div'); 
            actionsWrapper.classList.add('note-actions'); 
            const pinBtn = document.createElement('span'); 
            pinBtn.classList.add('note-pin-btn'); 
            pinBtn.innerHTML = '&#128204;'; 
            pinBtn.title = 'Przypnij/Odepnij'; 
            pinBtn.onclick = async (e) => { e.stopPropagation(); await supabase.from('notes').update({ is_pinned: !note.is_pinned }).eq('id', note.id); renderNotes(); }; 
            const publishBtn = document.createElement('span'); 
            publishBtn.classList.add('note-publish-btn'); 
            publishBtn.innerHTML = note.is_public ? '&#128275;' : '&#128274;'; 
            publishBtn.title = note.is_public ? 'Uczy prywatn' : 'Upublicznij'; 
            publishBtn.onclick = async (e) => { e.stopPropagation(); await supabase.from('notes').update({ is_public: !note.is_public }).eq('id', note.id); renderNotes(); }; 
            actionsWrapper.appendChild(pinBtn); 
            actionsWrapper.appendChild(publishBtn); 
            item.appendChild(titleWrapper); 
            item.appendChild(actionsWrapper); 
            item.onclick = () => loadAdminNoteIntoEditor(note); 
            noteTitleList.appendChild(item);
        }); 
        const currentNoteId = document.getElementById('note-title-input').dataset.currentId;
        if(currentNoteId) { const selectedItem = noteTitleList.querySelector(`[data-note-id='${currentNoteId}']`); if(selectedItem) selectedItem.classList.add('selected'); } 
    }

    async function renderUserScheduleRequests() {
        const listEl = document.getElementById('user-schedule-request-list');
        const { data, error } = await supabase.from('vacation_requests').select('*').eq('is_visible', true).order('start_date');
        listEl.innerHTML = '';
        if (error) { listEl.innerHTML = 'Bd adowania wniosk贸w.'; return; }
        
        if (data.length === 0) {
            listEl.innerHTML = 'Brak zgoszonych wniosk贸w.'; 
            return;
        }
        
        data.forEach(req => {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('item-row', 'vacation-request');
            itemDiv.classList.toggle('accepted', req.is_accepted);
            
            let status = req.is_accepted ? '(Zaakceptowany)' : '(Oczekujcy)';

            let content = `
                <span><strong>${req.employee_name}</strong>: ${req.start_date} do ${req.end_date} ${status}</span>
                <span>${req.notes || ''}</span>
            `;

            let buttons = `
                <div class="vacation-user-actions">
                    <button class="edit-vacation-btn" data-id="${req.id}">Edytuj</button>
                </div>
            `;

            itemDiv.innerHTML = content + buttons;
            listEl.appendChild(itemDiv);
        });
    }


    async function renderAdminScheduleRequests() {
        const { data, error } = await supabase.from('vacation_requests').select('*').order('created_at', { ascending: false });
        const listEl = document.getElementById('admin-schedule-request-list');
        listEl.innerHTML = '';
        if (error) { listEl.innerHTML = 'Bd adowania wniosk贸w.'; return; }

        const filterStartDate = document.getElementById('admin-filter-start').value;
        const filterEndDate = document.getElementById('admin-filter-end').value;

        let filteredData = data;
        if (filterStartDate && filterEndDate) {
            const filterStart = new Date(filterStartDate);
            const filterEnd = new Date(filterEndDate);

            filteredData = data.filter(req => {
                const reqStart = new Date(req.start_date);
                const reqEnd = new Date(req.end_date);
                return reqStart <= filterEnd && reqEnd >= filterStart;
            });
        }
        
        if (filteredData.length === 0) { listEl.innerHTML = 'Brak wniosk贸w speniajcych kryteria.'; return; }

        filteredData.forEach(req => {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('item-row', 'vacation-request');
            itemDiv.classList.toggle('accepted', req.is_accepted);

            const createdDate = new Date(req.created_at).toLocaleString('pl-PL');
            const content = `
                <span><strong>${req.employee_name}</strong>: ${req.start_date} do ${req.end_date} (Zgoszono: ${createdDate})</span>
                <span><i>${req.notes || 'Brak notatki'}</i></span>
            `;

            const actions = `
                <div class="vacation-admin-actions">
                    <label>
                        <input type="checkbox" class="accept-vacation-checkbox" data-id="${req.id}" ${req.is_accepted ? 'checked' : ''}>
                        Zaakceptowany
                    </label>
                    <button class="toggle-visibility-btn" data-id="${req.id}" data-visible="${req.is_visible}">${req.is_visible ? 'Ukryj' : 'Poka偶'}</button>
                    <button class="edit-vacation-btn" data-id="${req.id}">Edytuj</button>
                    <button class="delete-vacation-btn" data-id="${req.id}">Usu</button>
                </div>
            `;
            
            itemDiv.innerHTML = content + actions;
            listEl.appendChild(itemDiv);
        });
    }

    async function refreshAllData() {
        console.log("Odwie偶anie danych...");
        const userPromises = [
            renderSupabaseTasks(document.getElementById('supabase-task-list'), false), 
            renderUserOrders(), 
            renderUserNotes(),
            renderUserScheduleRequests()
        ];
        await Promise.all(userPromises);
        
        if (isAdminInitialized) {
            const adminPromises = [
                renderSupabaseTasks(null, true), 
                renderAdminOrders(), 
                renderNotes(),
                renderAdminScheduleRequests()
            ];
            await Promise.all(adminPromises);
        }
        console.log("Dane odwie偶one.");
    }

    // --- USER VIEW INITIALIZATION & NOTE LOGIC ---
    let currentUserNoteId = null;
    function clearUserEditor() { const userNoteTitleList = document.getElementById('user-note-title-list'); const userNoteTitleInput = document.getElementById('user-note-title-input'), userNoteColorInput = document.getElementById('user-note-color-input'), userNoteContentInput = document.getElementById('user-note-content-input'), userNoteTimestamps = document.getElementById('user-note-timestamps'); currentUserNoteId = null; userNoteTitleInput.value = ''; userNoteContentInput.innerHTML = ''; userNoteColorInput.value = '#000000'; userNoteTimestamps.innerHTML = ''; userNoteTitleInput.removeAttribute('data-current-id'); const selected = userNoteTitleList.querySelector('.selected'); if(selected) selected.classList.remove('selected'); editorMode.user = 'render'; document.getElementById('user-toggle-raw-btn').textContent = 'Edytuj Kod'; }
    function loadUserNoteIntoEditor(note) { const userNoteTitleInput = document.getElementById('user-note-title-input'), userNoteColorInput = document.getElementById('user-note-color-input'), userNoteContentInput = document.getElementById('user-note-content-input'), userNoteContentRaw = document.getElementById('user-note-content-raw'), userNoteTimestamps = document.getElementById('user-note-timestamps'); currentUserNoteId = note.id; userNoteTitleInput.setAttribute('data-current-id', note.id); userNoteTitleInput.value = note.title; userNoteContentInput.innerHTML = convertTextToHtml(note.content); userNoteColorInput.value = note.title_color || '#000000'; const created = new Date(note.created_at).toLocaleString('pl-PL'); const updated = note.updated_at ? new Date(note.updated_at).toLocaleString('pl-PL') : '---'; userNoteTimestamps.innerHTML = `Utworzono: ${created} | Ost. edycja: ${updated}`; document.getElementById('user-note-title-list').querySelectorAll('.note-list-item').forEach(item => { item.classList.toggle('selected', item.dataset.noteId == note.id); }); editorMode.user = 'render'; document.getElementById('user-toggle-raw-btn').textContent = 'Edytuj Kod'; userNoteContentInput.style.display = 'block'; userNoteContentRaw.style.display = 'none'; }
    async function saveUserNote() { 
        const userNoteTitleInput = document.getElementById('user-note-title-input'), userNoteColorInput = document.getElementById('user-note-color-input'), userNoteContentInput = document.getElementById('user-note-content-input'), userNoteContentRaw = document.getElementById('user-note-content-raw'); 
        const title = userNoteTitleInput.value;
        const content = editorMode.user === 'raw' ? userNoteContentRaw.value : convertRenderedToSource(userNoteContentInput);
        const title_color = userNoteColorInput.value; 
        if (!title) { showModal('Bd', 'Tytu notatki jest wymagany.'); return; } 
        if (currentUserNoteId) { 
            await supabase.from('notes').update({ title, content, title_color, updated_at: new Date() }).eq('id', currentUserNoteId); 
        } else { 
            const { data } = await supabase.from('notes').insert([{ title, content, title_color, is_public: true }]).select(); 
            if(data && data.length > 0) {
                currentUserNoteId = data[0].id; 
            }
        } 
        renderUserNotes(); 
    }
    
    function initUserView() {
        document.getElementById('user-order-form').addEventListener('submit', async (e) => { e.preventDefault(); const name = document.getElementById('user-order-name').value; const supplier = document.getElementById('user-order-supplier').value; await supabase.from('orders').insert([{ name, supplier }]); e.target.reset(); renderUserOrders(); });
        document.getElementById('user-new-note-btn').onclick = clearUserEditor;
        document.getElementById('user-save-note-btn').onclick = saveUserNote;
        document.getElementById('user-toggle-raw-btn').addEventListener('click', () => {
            const contentInput = document.getElementById('user-note-content-input');
            const rawInput = document.getElementById('user-note-content-raw');
            const button = document.getElementById('user-toggle-raw-btn');
            if (editorMode.user === 'render') {
                rawInput.value = convertRenderedToSource(contentInput);
                contentInput.style.display = 'none';
                rawInput.style.display = 'block';
                editorMode.user = 'raw';
                button.textContent = 'Podgld Wizualny';
            } else {
                contentInput.innerHTML = convertTextToHtml(rawInput.value);
                rawInput.style.display = 'none';
                contentInput.style.display = 'block';
                editorMode.user = 'render';
                button.textContent = 'Edytuj Kod';
            }
        });

        document.getElementById('user-schedule-request-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const employee_name = document.getElementById('user-employee-name').value;
            const start_date = document.getElementById('user-start-date').value;
            const end_date = document.getElementById('user-end-date').value;
            const notes = document.getElementById('user-vacation-notes').value;

            if (new Date(end_date) < new Date(start_date)) {
                showModal('Bd', 'Data zakoczenia nie mo偶e by wczeniejsza ni偶 data rozpoczcia.');
                return;
            }

            const { error } = await supabase.from('vacation_requests').insert([
                { employee_name, start_date, end_date, notes, is_visible: true }
            ]);

            if (error) {
                showModal('Bd', 'Nie udao si wysa wniosku.');
            } else {
                showModal('Sukces', 'Wniosek zosta pomylnie wysany.');
                e.target.reset();
                refreshAllData();
            }
        });
        
        document.getElementById('user-schedule-request-list').addEventListener('click', async (e) => {
            const target = e.target;
            const reqId = target.dataset.id;
            if (!reqId) return;

            if (target.classList.contains('edit-vacation-btn')) {
                 const { data, error } = await supabase.from('vacation_requests').select('*').eq('id', reqId).single();
                 if (error || !data) { showModal('Bd', 'Nie mo偶na znale藕 wniosku.'); return; }
                 
                 const new_start_date = prompt('Nowa data rozpoczcia:', data.start_date);
                 if (new_start_date === null) return;
                 const new_end_date = prompt('Nowa data zakoczenia:', data.end_date);
                 if (new_end_date === null) return;
                 const new_notes = prompt('Nowa notatka:', data.notes);
                 if (new_notes === null) return;

                 await supabase.from('vacation_requests').update({ start_date: new_start_date, end_date: new_end_date, notes: new_notes }).eq('id', reqId);
                 renderUserScheduleRequests();
            }
        });

        refreshAllData();
    }

    // --- ADMIN VIEW INITIALIZATION & NOTE LOGIC ---
    let currentAdminNoteId = null;
    function clearAdminEditor() { const adminNoteTitleInput = document.getElementById('note-title-input'), adminNoteColorInput = document.getElementById('note-color-input'), adminNoteContentInput = document.getElementById('note-content-input'), adminNoteTimestamps = document.getElementById('note-timestamps'); currentAdminNoteId = null; adminNoteTitleInput.value = ''; adminNoteContentInput.innerHTML = ''; adminNoteColorInput.value = '#000000'; adminNoteTimestamps.innerHTML = ''; adminNoteTitleInput.removeAttribute('data-current-id'); const selected = document.getElementById('note-title-list').querySelector('.selected'); if(selected) selected.classList.remove('selected'); editorMode.admin = 'render'; document.getElementById('admin-toggle-raw-btn').textContent = 'Edytuj Kod'; }
    function loadAdminNoteIntoEditor(note) { const adminNoteTitleInput = document.getElementById('note-title-input'), adminNoteColorInput = document.getElementById('note-color-input'), adminNoteContentInput = document.getElementById('note-content-input'), adminNoteContentRaw = document.getElementById('note-content-raw'), adminNoteTimestamps = document.getElementById('note-timestamps'); currentAdminNoteId = note.id; adminNoteTitleInput.setAttribute('data-current-id', note.id); adminNoteTitleInput.value = note.title; adminNoteContentInput.innerHTML = convertTextToHtml(note.content); adminNoteColorInput.value = note.title_color || '#000000'; const created = new Date(note.created_at).toLocaleString('pl-PL'); const updated = note.updated_at ? new Date(note.updated_at).toLocaleString('pl-PL') : '---'; adminNoteTimestamps.innerHTML = `Utworzono: ${created} | Ost. edycja: ${updated}`; document.getElementById('note-title-list').querySelectorAll('.note-list-item').forEach(item => { item.classList.toggle('selected', item.dataset.noteId == note.id); }); editorMode.admin = 'render'; document.getElementById('admin-toggle-raw-btn').textContent = 'Edytuj Kod'; adminNoteContentInput.style.display = 'block'; adminNoteContentRaw.style.display = 'none';}
    async function saveAdminNote() { const adminNoteTitleInput = document.getElementById('note-title-input'), adminNoteColorInput = document.getElementById('note-color-input'), adminNoteContentInput = document.getElementById('note-content-input'), adminNoteContentRaw = document.getElementById('note-content-raw'); const title = adminNoteTitleInput.value; const content = editorMode.admin === 'raw' ? adminNoteContentRaw.value : convertRenderedToSource(adminNoteContentInput); const title_color = adminNoteColorInput.value; if (!title) { showModal('Bd', 'Tytu notatki jest wymagany.'); return; } if (currentAdminNoteId) { await supabase.from('notes').update({ title, content, title_color, updated_at: new Date() }).eq('id', currentAdminNoteId); } else { const { data } = await supabase.from('notes').insert([{ title, content, title_color, is_public: false }]).select(); if(data && data.length > 0) { currentAdminNoteId = data[0].id; loadAdminNoteIntoEditor(data[0]); } } renderNotes(); }
    async function deleteAdminNote() { if (!currentAdminNoteId) return; if (confirm('Czy na pewno chcesz usun t notatk?')) { await supabase.from('notes').delete().eq('id', currentAdminNoteId); clearAdminEditor(); renderNotes(); } }
    
    function initAdminView() {
        document.getElementById('admin-task-form').addEventListener('submit', async (e) => { e.preventDefault(); const content = document.getElementById('admin-task-input').value.trim(); const assignees = document.getElementById('admin-assignee-input').value.trim(); if (!content) return; await supabase.from('tasks').insert([{ content, assignees, done: false, visible: true }]); e.target.reset(); refreshAllData(); });
        document.getElementById('admin-order-form').addEventListener('submit', async (e) => { e.preventDefault(); const name = document.getElementById('admin-order-name').value; const supplier = document.getElementById('admin-order-supplier').value; await supabase.from('orders').insert([{ name, supplier }]); e.target.reset(); renderAdminOrders(); });
        
        document.getElementById('new-note-btn').onclick = clearAdminEditor;
        document.getElementById('save-note-btn').onclick = saveAdminNote;
        document.getElementById('delete-note-btn').onclick = deleteAdminNote;
        document.getElementById('admin-toggle-raw-btn').addEventListener('click', () => {
            const contentInput = document.getElementById('note-content-input');
            const rawInput = document.getElementById('note-content-raw');
            const button = document.getElementById('admin-toggle-raw-btn');
            if (editorMode.admin === 'render') {
                rawInput.value = convertRenderedToSource(contentInput);
                contentInput.style.display = 'none';
                rawInput.style.display = 'block';
                editorMode.admin = 'raw';
                button.textContent = 'Podgld Wizualny';
            } else {
                contentInput.innerHTML = convertTextToHtml(rawInput.value);
                rawInput.style.display = 'none';
                contentInput.style.display = 'block';
                editorMode.admin = 'render';
                button.textContent = 'Edytuj Kod';
            }
        });
        
        document.getElementById('admin-schedule-request-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const employee_name = document.getElementById('admin-employee-name').value;
            const start_date = document.getElementById('admin-start-date').value;
            const end_date = document.getElementById('admin-end-date').value;
            const notes = document.getElementById('admin-vacation-notes').value;

            if (new Date(end_date) < new Date(start_date)) {
                showModal('Bd', 'Data zakoczenia nie mo偶e by wczeniejsza ni偶 data rozpoczcia.');
                return;
            }

            const { error } = await supabase.from('vacation_requests').insert([
                { employee_name, start_date, end_date, notes, is_visible: true }
            ]);

            if (error) {
                showModal('Bd', 'Nie udao si wysa wniosku.');
            } else {
                showModal('Sukces', 'Wniosek zosta pomylnie wysany.');
                e.target.reset();
                refreshAllData();
            }
        });

        document.getElementById('admin-schedule-request-list').addEventListener('click', async (e) => {
            const target = e.target;
            const reqId = target.dataset.id;
            if (!reqId) return;

            if (target.classList.contains('accept-vacation-checkbox')) {
                const is_accepted = target.checked;
                await supabase.from('vacation_requests').update({ is_accepted }).eq('id', reqId);
                target.closest('.vacation-request').classList.toggle('accepted', is_accepted);
            }
            if (target.classList.contains('toggle-visibility-btn')) {
                const is_visible = !(target.dataset.visible === 'true');
                await supabase.from('vacation_requests').update({ is_visible }).eq('id', reqId);
                renderAdminScheduleRequests();
            }
            if (target.classList.contains('edit-vacation-btn')) {
                 const { data, error } = await supabase.from('vacation_requests').select('*').eq('id', reqId).single();
                 if (error || !data) { showModal('Bd', 'Nie mo偶na znale藕 wniosku.'); return; }
                 
                 const new_start_date = prompt('Nowa data rozpoczcia:', data.start_date);
                 if (new_start_date === null) return;
                 const new_end_date = prompt('Nowa data zakoczenia:', data.end_date);
                 if (new_end_date === null) return;
                 const new_notes = prompt('Nowa notatka:', data.notes);
                 if (new_notes === null) return;

                 await supabase.from('vacation_requests').update({ start_date: new_start_date, end_date: new_end_date, notes: new_notes }).eq('id', reqId);
                 renderAdminScheduleRequests();
            }
             if (target.classList.contains('delete-vacation-btn')) {
                if (confirm('Czy na pewno chcesz usun ten wniosek?')) {
                    await supabase.from('vacation_requests').delete().eq('id', reqId);
                    renderAdminScheduleRequests();
                }
            }
        });
        
        document.getElementById('admin-filter-btn').addEventListener('click', renderAdminScheduleRequests);
        document.getElementById('admin-clear-filter-btn').addEventListener('click', () => {
            document.getElementById('admin-filter-start').value = '';
            document.getElementById('admin-filter-end').value = '';
            renderAdminScheduleRequests();
        });

        refreshAllData();
    }
    
    function setupTaskListeners() {
        const taskLists = [
            document.getElementById('supabase-task-list'),
            document.getElementById('admin-task-list-visible'),
            document.getElementById('admin-task-list-hidden')
        ];

        taskLists.forEach(list => {
            if (!list) return;
            list.addEventListener('change', async (e) => {
                if (e.target.classList.contains('subtask-checkbox')) {
                    const checkbox = e.target;
                    const textSpan = checkbox.nextElementSibling;
                    const taskRow = checkbox.closest('.item-row');
                    
                    if (!taskRow) return;

                    const taskId = taskRow.dataset.taskId;
                    let fullContent = taskRow.dataset.fullContent;
                    const clickedIndex = parseInt(checkbox.dataset.index, 10);
                    const isChecked = checkbox.checked;

                    textSpan.classList.toggle('done', isChecked);

                    const subtaskRegex = /\((#|&)(.*?)\)/g;
                    let currentIndex = 0;
                    const newContent = fullContent.replace(subtaskRegex, (match, sign, text) => {
                        if (currentIndex === clickedIndex) {
                            const newSign = isChecked ? '&' : '#';
                            return `(${newSign}${text})`;
                        }
                        currentIndex++;
                        return match;
                    });
                    
                    taskRow.dataset.fullContent = newContent;

                    const { error } = await supabase
                        .from('tasks')
                        .update({ content: newContent })
                        .eq('id', taskId);

                    if (error) {
                        showModal('Bd', 'Nie udao si zaktualizowa podzadania.');
                        checkbox.checked = !isChecked;
                        textSpan.classList.toggle('done', !isChecked);
                        taskRow.dataset.fullContent = fullContent;
                    }
                }
            });
        });
    }

    // --- APP INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        initUserView();
        document.querySelectorAll('.refresh-btn').forEach(btn => btn.addEventListener('click', refreshAllData));
        themeToggleButtons.forEach(btn => btn.addEventListener('click', toggleTheme));
        updateThemeIcon();

        // Hamburger Menu Logic
        document.getElementById('user-hamburger-btn').addEventListener('click', () => {
            document.getElementById('user-nav-links').classList.toggle('open');
        });
        document.getElementById('admin-hamburger-btn').addEventListener('click', () => {
            document.getElementById('admin-nav-links').classList.toggle('open');
        });

        // Handle clicks on links within note content
        function handleNoteClick(e) {
            const link = e.target.closest('a');
            if (link && link.href) {
                e.preventDefault();
                window.open(link.href, '_blank');
            }
        }
        document.getElementById('user-note-content-input').addEventListener('click', handleNoteClick);
        document.getElementById('note-content-input').addEventListener('click', handleNoteClick);
        
        setupTaskListeners();
    });
</script>
</body>
</html>


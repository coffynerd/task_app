<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista Zadań</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+EAN13+Text&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-light: #f0f2f5;
            --background-dark: #121212;
            --text-light: #1c1c1c;
            --text-dark: #e0e0e0;
            --surface-light: #fff;
            --surface-dark: #1e1e1e;
            --border-light: #ddd;
            --border-dark: #333;
            --priority-color: #B8860B; /* Ciemny złoty dla trybu jasnego */
            --supabase-source-color: #56a761;
            --firebase-source-color: #ffca28;
            --user-task-color: #007bff;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: var(--background-light);
            color: var(--text-light);
            transition: background-color 0.3s, color 0.3s;
        }
        .nav-bar {
            overflow: visible;
            padding: 0 20px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }
        .nav-links {
            flex-grow: 1;
        }
        .blue-nav { background-color: #004896; }
        .gray-nav { background-color: #6c757d; }
        .nav-bar a {
            float: left;
            display: block;
            color: white;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .blue-nav a:hover {
            background-color: #ffc101;
            color: black;
        }
        .gray-nav a:hover {
            background-color: #5a6268;
        }
        .nav-actions {
            display: flex;
            align-items: center;
        }
        .theme-toggle-btn, .refresh-btn {
            font-size: 1.5em;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 10px;
            color: white;
        }
        .hamburger-btn {
            display: none;
            font-size: 1.8em;
            background: none;
            border: none;
            cursor: pointer;
            color: white;
        }
        .content {
            padding: 20px 30px;
            display: none;
        }
        .content.active {
            display: block;
        }
        .item-row {
            border-bottom: 1px solid var(--border-light);
            padding: 10px 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        .item-row.done {
            color: red;
            text-decoration: line-through;
            background-color: #f9f9f9;
        }
        .item-row.priority {
            color: var(--priority-color);
            font-weight: bold;
        }
        .item-row.user-submitted {
            color: var(--user-task-color);
        }
        .dark-mode .item-row.priority {
            color: #ffc101;
        }
        .dark-mode .item-row.user-submitted {
            color: #3399ff;
        }
        .item-row.user-submitted.done, .item-row.priority.done {
            color: red;
        }
        .order-item.done {
            text-decoration: none;
        }
        .item-row.due-date-warning:not(.done) .task-text-container,
        .item-row.due-date-warning:not(.done) .due-date-text {
            color: purple;
            font-weight: bold;
        }
        .dark-mode .item-row.due-date-warning:not(.done) .task-text-container,
        .dark-mode .item-row.due-date-warning:not(.done) .due-date-text {
            color: #c58af9;
        }

        .item-content-wrapper {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        .assignees, .supplier-info {
            color: #555;
            font-size: 0.9em;
            margin-left: 15px;
        }
        .date-info {
            font-size: 0.8em;
            color: #888;
            margin-left: auto;
            padding-left: 20px;
            text-align: right;
            white-space: nowrap;
        }
        .due-date-text {
            margin-left: 15px;
            font-size: 1em;
            font-weight: normal;
        }
        .right-aligned-info {
            text-align: right;
        }
        h2, h3 { color: var(--text-light); }
        form {
            margin-top: 20px;
            margin-bottom: 20px;
            background-color: var(--surface-light);
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        form input, form textarea { padding: 8px; margin-right: 10px; border: 1px solid #ccc; border-radius: 4px; resize: none; }

        .vacation-request-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        .vacation-request-form .vacation-form-row {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1 1 200px;
        }
        .vacation-request-form textarea {
            min-height: 36px;
        }

        .vacation-request-form button {
            margin-left: 0;
        }

        button { margin-left: 10px; cursor: pointer; padding: 8px 12px; border: none; border-radius: 4px; color: white; background-color: #004896; transition: background-color 0.3s; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        .item-row button { background-color: #6c757d; font-size: 0.8em; padding: 5px 8px; }
        .google-sheet-iframe {
            width: 100%;
            height: 75vh;
            border: 1px solid var(--border-light);
            border-radius: 5px;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .page-header a {
            display: inline-block;
            padding: 8px 16px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        .page-header a:hover {
            background-color: #218838;
        }

        /* --- DARK MODE STYLES --- */
        body.dark-mode {
            background-color: var(--background-dark);
            color: var(--text-dark);
        }
        .dark-mode h2, .dark-mode h3 { color: var(--text-dark); }
        .dark-mode form {
            background-color: var(--surface-dark);
            border: 1px solid var(--border-dark);
        }
        .dark-mode form input, .dark-mode form textarea, .dark-mode .note-content-input, .dark-mode .raw-editor, .dark-mode .modal-input {
            background-color: #2a2a2a;
            color: var(--text-dark);
            border-color: #444;
        }
        .dark-mode .item-row { border-bottom-color: var(--border-dark); }
        .dark-mode .item-row.done { background-color: #2c1d1d; }
        .dark-mode .assignees, .dark-mode .supplier-info, .dark-mode .date-info { color: #999; }
        .dark-mode .google-sheet-iframe {
            border-color: var(--border-dark);
            filter: invert(90%) hue-rotate(180deg);
        }

        /* --- STYLE DLA NOTATNIKA --- */
        .notebook-container { display: flex; gap: 20px; height: 80vh; }
        .note-list-column { flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border-light); padding-right: 20px; }
        .dark-mode .note-list-column { border-right-color: var(--border-dark); }
        .note-editor-column { flex: 3; display: flex; flex-direction: column; }
        .note-editor-content-wrapper { position: relative; flex-grow: 1; display: flex; }
        #new-note-btn, #user-new-note-btn { width: 100%; margin: 0 0 10px 0; }
        #note-title-list, #user-note-title-list { overflow-y: auto; }
        .note-list-item { padding: 10px; border-bottom: 1px solid var(--border-light); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .note-title-wrapper { display: flex; align-items: baseline; flex-grow: 1; overflow: hidden; }
        .note-title { font-weight: bold; font-size: 1.1em; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        .note-list-date {
            font-size: 0.8em;
            font-weight: normal;
            color: #888;
            margin-left: 8px;
            white-space: nowrap;
        }
        .dark-mode .note-list-date { color: #aaa; }
        .note-list-item:hover { background-color: rgba(0, 0, 0, 0.05); }
        .note-list-item.selected { background-color: #cccccc; color: #1c1c1c; }
        .dark-mode .note-list-item:hover { background-color: rgba(255, 255, 255, 0.05); }
        .dark-mode .note-list-item.selected { background-color: #383838; color: #e0e0e0; }
        .note-actions { display: flex; align-items: center; }
        .note-pin-btn, .note-publish-btn, .note-share-btn { cursor: pointer; opacity: 0.6; font-size: 1.1em; margin-left: 10px; }
        .note-pin-btn:hover, .note-publish-btn:hover, .note-share-btn:hover { opacity: 1; }
        .note-list-item.pinned .note-pin-btn { opacity: 1; color: #007bff; }
        .note-list-item.public .note-publish-btn { opacity: 1; color: #28a745; }
        .editor-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        #note-title-input, #user-note-title-input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        #note-color-input, #user-note-color-input { height: 35px; padding: 2px; border: 1px solid #ccc; border-radius: 4px; background-color: white; }
        .note-content-input, .raw-editor {
            flex-grow: 1; width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; resize: none;
        }
        .note-content-input { overflow-y: auto; }
        .note-content-input div { min-height: 1.2em; }
        .note-content-input div { display: flex; align-items: center; }
        .note-content-input input[type="checkbox"] { margin-right: 8px; flex-shrink: 0; }
        .note-content-input img, .note-content-input video { max-width: 100%; height: auto; }
        #note-timestamps, #user-note-timestamps { font-size: 0.8em; color: #888; text-align: right; margin-top: 10px; padding-right: 10px; }
        .dark-mode #note-timestamps, .dark-mode #user-note-timestamps { color: #aaa; }
        .note-editor-buttons { margin-top: 10px; text-align: right; }
        #admin-notes button { background-color: #6c757d; }
        #admin-notes button:hover { background-color: #5a6268; }
        #delete-note-btn, .delete-order-btn, .delete-vacation-btn, .delete-task-btn { background-color: #dc3545; }
        #delete-note-btn:hover, .delete-order-btn:hover, .delete-vacation-btn:hover, .delete-task-btn:hover { background-color: #c82333; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-content {
            background: var(--surface-light); color: var(--text-light); padding: 20px; border-radius: 8px; text-align: center; max-width: 90%; width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .dark-mode .modal-content { background: var(--surface-dark); color: var(--text-dark); }
        .modal-content h4 { margin-top: 0; }
        .modal-content p { white-space: pre-wrap; }
        .modal-input {
            width: calc(100% - 20px);
            padding: 8px;
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .ean-barcode {
            font-family: 'Libre Barcode EAN13 Text', system-ui;
            font-size: 110px;
            line-height: 1;
        }

        /* --- SUBTASK STYLES --- */
        .subtask {
            display: inline-flex;
            align-items: center;
            margin: 0 5px;
        }
        .subtask-text.done {
            text-decoration: line-through;
        }
        .task-text-container {
            display: inline;
        }
        .vacation-request.accepted {
            background-color: #d4edda;
        }
        .vacation-request.rejected {
            background-color: #f8d7da;
        }
        .dark-mode .vacation-request.accepted {
            background-color: #1c3d23;
        }
        .dark-mode .vacation-request.rejected {
            background-color: #4d1f23;
        }
        .source-tag {
            font-size: 0.7em;
            padding: 2px 5px;
            border-radius: 3px;
            margin-left: 5px;
            font-weight: normal;
            color: white;
        }
        .source-tag.supabase {
            background-color: var(--supabase-source-color);
        }
        .source-tag.firebase {
            background-color: var(--firebase-source-color);
            color: var(--text-light); /* Make text readable on light yellow */
        }
        .dark-mode .source-tag.firebase {
            color: black;
        }
        .days-of-week {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .days-of-week label {
            cursor: pointer;
        }

        /* --- MOBILE STYLES --- */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                background-color: inherit;
                z-index: 1000;
                box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            }
            .nav-links.open {
                display: flex;
            }
            .nav-bar a {
                float: none;
                text-align: left;
            }
            .nav-bar .nav-links {
                flex-grow: 0;
            }
            .hamburger-btn {
                display: block;
            }
            .nav-bar .nav-actions {
                order: 2;
            }
            .nav-bar .nav-links {
                order: 3;
                width: 100%;
            }
            .nav-bar::before {
                content: "Lista Zadań";
                order: 1;
                flex-grow: 1;
                text-align: left;
            }
            .notebook-container {
                flex-direction: column;
                height: 75vh;
            }
            .note-list-column {
                border-right: none;
                padding-right: 0;
                border-bottom: 1px solid var(--border-light);
                padding-bottom: 20px;
                margin-bottom: 20px;
                flex-shrink: 0;
                max-height: 30%;
            }
            .dark-mode .note-list-column {
                border-bottom-color: var(--border-dark);
            }
            .content {
                padding: 15px;
            }
            .order-item .order-buttons {
                width: 100%;
                text-align: left;
                padding-top: 5px;
            }
            .order-item .order-buttons button {
                margin-left: 0;
                margin-right: 10px;
            }
            .vacation-request-form {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            .vacation-request-form .vacation-form-row {
                flex: initial;
            }
        }
    </style>
</head>
<body>
    <!-- Modal for alerts -->
    <div id="modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h4 id="modal-title"></h4>
            <p id="modal-text"></p>
            <button id="modal-close-btn">Zamknij</button>
        </div>
    </div>

    <div id="user-view">
        <div class="nav-bar blue-nav">
            <div class="nav-links" id="user-nav-links">
                <a data-page="user-tasks">Lista zadań</a>
                <a data-page="user-order">Do zamówienia</a>
                <a data-page="user-schedule">Grafik</a>
                <a data-page="user-schedule-requests">Wnioski do grafiku</a>
                <a data-page="user-notes">Notatnik</a>
                <a id="switch-to-admin-btn">Panel Administratora</a>
            </div>
            <div class="nav-actions">
                <button class="refresh-btn" title="Odśwież dane">🔄</button>
                <button class="theme-toggle-btn"></button>
                <button class="hamburger-btn" id="user-hamburger-btn">&#9776;</button>
            </div>
        </div>
        <div id="user-tasks" class="content active">
            <h2>Lista Zadań</h2>
            <form id="user-task-form">
                <h3>Dodaj zadanie</h3>
                <input type="text" id="user-task-input" placeholder="Treść zadania" required>
                <input type="text" id="user-assignee-input" placeholder="Pracownicy (oddzieleni średnikiem)">
                <input type="date" id="user-due-date-input" title="Termin wykonania">
                <button type="submit">Dodaj</button>
            </form>
            <div id="user-task-list">Ładowanie...</div>
        </div>
        <div id="user-order" class="content">
            <h2>Do zamówienia</h2>
            <form id="user-order-form">
                <input type="text" id="user-order-name" placeholder="Nazwa produktu (!!! dla priorytetu)" required>
                <input type="text" id="user-order-supplier" placeholder="Dostawca">
                <button type="submit">Dodaj do listy</button>
            </form>
            <div id="user-order-list"></div>
        </div>
        <div id="user-schedule" class="content">
            <h2>Grafik</h2>
            <iframe class="google-sheet-iframe" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTDEEc4cmeNHgLhQwp6zAXiUwhzwJSw0DYH-MV0XLEQBs9-2LvsklLOeSHbat4DZexTXeSad5MqzY_e/pubhtml?gid=0&single=true&widget=true&headers=false"></iframe>
        </div>
        <div id="user-notes" class="content">
            <h2>Notatnik</h2>
            <div class="notebook-container">
                <div class="note-list-column">
                    <button id="user-new-note-btn">+ Nowa notatka</button>
                    <div id="user-note-title-list">Brak notatek</div>
                </div>
                <div class="note-editor-column">
                    <div class="editor-header">
                        <input type="text" id="user-note-title-input" placeholder="Tytuł notatki...">
                        <input type="color" id="user-note-color-input" title="Wybierz kolor tytułu" value="#000000">
                    </div>
                    <div class="note-editor-content-wrapper">
                        <div id="user-note-content-input" class="note-content-input" contenteditable="true"></div>
                        <textarea id="user-note-content-raw" class="raw-editor" style="display: none;"></textarea>
                    </div>
                    <div id="user-note-timestamps"></div>
                    <div class="note-editor-buttons">
                        <button id="user-toggle-raw-btn">Edytuj Kod</button>
                        <button id="user-save-note-btn">Zapisz</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="user-schedule-requests" class="content">
            <h2>Złóż wniosek do grafiku</h2>
            <form id="user-schedule-request-form" class="vacation-request-form">
                <div class="vacation-form-row">
                    <label for="user-employee-name">Imię i nazwisko:</label>
                    <input type="text" id="user-employee-name" required>
                </div>
                <div class="vacation-form-row">
                    <label for="user-start-date">Data od:</label>
                    <input type="date" id="user-start-date" required>
                </div>
                <div class="vacation-form-row">
                    <label for="user-end-date">Data do:</label>
                    <input type="date" id="user-end-date" required>
                </div>
                <div class="vacation-form-row">
                    <label for="user-vacation-notes">Notatka:</label>
                    <textarea id="user-vacation-notes"></textarea>
                </div>
                <button type="submit">Wyślij wniosek</button>
            </form>

            <h3>Zgłoszone wnioski</h3>
            <div id="user-schedule-request-list"></div>
        </div>
    </div>

    <div id="admin-view" style="display: none;">
        <div class="nav-bar gray-nav">
            <div class="nav-links" id="admin-nav-links">
                <a data-page="admin-tasks">Lista zadań</a>
                <a data-page="admin-recurring-tasks">Zadania cykliczne</a>
                <a data-page="admin-order">Do zamówienia</a>
                <a data-page="admin-schedule">Grafik</a>
                <a data-page="admin-schedule-requests">Wnioski do grafiku</a>
                <a data-page="admin-notes">Notatnik</a>
                <a id="switch-to-user-btn">Panel użytkownika</a>
                <a id="admin-commands-btn">Komendy</a>
            </div>
            <div class="nav-actions">
                <button class="refresh-btn" title="Odśwież dane">🔄</button>
                <button class="theme-toggle-btn"></button>
                <button class="hamburger-btn" id="admin-hamburger-btn">&#9776;</button>
            </div>
        </div>
        <div id="admin-tasks" class="content">
            <h2>Panel Administratora</h2>
            <form id="admin-task-form">
                <h3>Dodaj zadanie (tylko Firebase)</h3>
                <input type="text" id="admin-task-input" placeholder="Treść zadania" required>
                <input type="text" id="admin-assignee-input" placeholder="Pracownicy (oddzieleni średnikiem)">
                <input type="date" id="admin-due-date-input" title="Termin wykonania">
                <button type="submit">Dodaj</button>
            </form>
            <h3>Lista zadań (Supabase i Firebase)</h3>
            <div id="admin-task-list-visible">Ładowanie...</div>
            <h3>Zadania ukryte (Supabase i Firebase)</h3>
            <div id="admin-task-list-hidden"></div>
        </div>
        <div id="admin-order" class="content">
            <h2>Do zamówienia (Admin)</h2>
            <form id="admin-order-form">
                <input type="text" id="admin-order-name" placeholder="Nazwa produktu (!!! dla priorytetu)" required>
                <input type="text" id="admin-order-supplier" placeholder="Dostawca">
                <button type="submit">Dodaj do listy</button>
            </form>
            <h3>Pozycje do zamówienia (Supabase i Firebase)</h3>
            <div id="admin-order-list-active"></div>
            <h3>Zamówienia zrealizowane (Supabase i Firebase)</h3>
            <div id="admin-order-list-completed"></div>
        </div>
         <div id="admin-recurring-tasks" class="content">
            <h2>Zadania cykliczne</h2>
            <form id="recurring-task-form">
                <h3>Dodaj zadanie cykliczne</h3>
                <input type="text" id="recurring-task-content" placeholder="Treść zadania" required>
                <input type="text" id="recurring-task-assignees" placeholder="Przypisane osoby (średnik ;)">
                <div class="days-of-week">
                    <label><input type="checkbox" name="day" value="1"> Pn</label>
                    <label><input type="checkbox" name="day" value="2"> Wt</label>
                    <label><input type="checkbox" name="day" value="3"> Śr</label>
                    <label><input type="checkbox" name="day" value="4"> Cz</label>
                    <label><input type="checkbox" name="day" value="5"> Pt</label>
                    <label><input type="checkbox" name="day" value="6"> So</label>
                    <label><input type="checkbox" name="day" value="7"> Nd</label>
                </div>
                <button type="submit">Dodaj</button>
            </form>
            <h3>Istniejące zadania cykliczne</h3>
            <div id="recurring-task-list"></div>
        </div>
        <div id="admin-schedule" class="content">
            <div class="page-header">
                <h2>Grafik</h2>
                <a href="https://docs.google.com/spreadsheets/d/1nKe6cmb0Tz60gZykzb1Rw06pq1tG0c2FTdktCS2OYV0/edit?usp=sharing" target="_blank">Edytuj</a>
            </div>
            <iframe class="google-sheet-iframe" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTDEEc4cmeNHgLhQwp6zAXiUwhzwJSw0DYH-MV0XLEQBs9-2LvsklLOeSHbat4DZexTXeSad5MqzY_e/pubhtml?widget=true&headers=false&rm=minimal"></iframe>
        </div>
        <div id="admin-notes" class="content">
            <h2>Notatnik</h2>
            <div class="notebook-container">
                <div class="note-list-column">
                    <button id="new-note-btn">+ Nowa notatka</button>
                    <div id="note-title-list">Ładowanie...</div>
                </div>
                <div class="note-editor-column">
                    <div class="editor-header">
                        <input type="text" id="note-title-input" placeholder="Tytuł notatki...">
                        <input type="color" id="note-color-input" title="Wybierz kolor tytułu">
                    </div>
                    <div class="note-editor-content-wrapper">
                        <div id="note-content-input" class="note-content-input" contenteditable="true"></div>
                        <textarea id="note-content-raw" class="raw-editor" style="display: none;"></textarea>
                    </div>
                    <div id="note-timestamps"></div>
                    <div class="note-editor-buttons">
                        <button id="admin-toggle-raw-btn">Edytuj Kod</button>
                        <button id="delete-note-btn">Usuń</button>
                        <button id="save-note-btn">Zapisz</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="admin-schedule-requests" class="content">
            <h2>Złóż wniosek do grafiku (tylko Firebase)</h2>
            <form id="admin-schedule-request-form" class="vacation-request-form">
                <div class="vacation-form-row">
                    <label for="admin-employee-name">Imię i nazwisko:</label>
                    <input type="text" id="admin-employee-name" required>
                </div>
                <div class="vacation-form-row">
                    <label for="admin-start-date">Data od:</label>
                    <input type="date" id="admin-start-date" required>
                </div>
                <div class="vacation-form-row">
                    <label for="admin-end-date">Data do:</label>
                    <input type="date" id="admin-end-date" required>
                </div>
                <div class="vacation-form-row">
                    <label for="admin-vacation-notes">Notatka:</label>
                    <textarea id="admin-vacation-notes"></textarea>
                </div>
                <button type="submit">Wyślij wniosek</button>
            </form>
            <h2>Zarządzaj wnioskami (Supabase i Firebase)</h2>
            <div class="filter-container" style="margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                <label for="admin-filter-start">Filtruj od:</label>
                <input type="date" id="admin-filter-start">
                <label for="admin-filter-end">do:</label>
                <input type="date" id="admin-filter-end">
                <button id="admin-filter-btn">Filtruj</button>
                <button id="admin-clear-filter-btn">Wyczyść</button>
            </div>
            <h3>Widoczne wnioski</h3>
            <div id="admin-schedule-request-list-visible">Ładowanie...</div>
            <h3>Ukryte wnioski</h3>
            <div id="admin-schedule-request-list-hidden">Ładowanie...</div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, updateDoc, deleteDoc, doc, getDocs, getDoc, setDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // --- CONFIGURATION ---
    const firebaseConfigFromEnv = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const firebaseConfig = firebaseConfigFromEnv || {
        apiKey: "AIzaSyDT2h4LtrlLP0d2X4jWyaQKabzUbpK_elA",
        authDomain: "psb-app-58090.firebaseapp.com",
        projectId: "psb-app-58090",
        storageBucket: "psb-app-58090.appspot.com",
        messagingSenderId: "100516614463",
        appId: "1:100516614463:web:36fe37ee48cee575b8838a"
    };
    const supabaseUrl = 'https://ugznhwthaztruazsjbhu.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnem5od3RoYXp0cnVhenNqYmh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NjU4NjAsImV4cCI6MjA2NDA0MTg2MH0.MlBkk-oKSRW7CaUiFf3Edo0KXamVlLaZfLuxGcWL4yU';
    const supabase = createClient(supabaseUrl, supabaseKey);


    // --- GLOBAL STATE AND VIEW MANAGEMENT ---
    let isAdminInitialized = false;
    let isUserInitialized = false;
    let showSourceTagsAdmin = false;
    let editorMode = { user: 'render', admin: 'render' };
    let currentUserNoteId = null;
    let currentAdminNoteId = null;

    // --- Firebase Setup ---
    let app, db, auth, userId;
    let isAuthReady = false;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        setLogLevel('debug');

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed, signing in anonymously as fallback:", error);
                    await signInAnonymously(auth);
                }
            }
            userId = auth.currentUser?.uid || crypto.randomUUID();
            isAuthReady = true;
            console.log("Firebase Auth Ready. User ID:", userId);
            await checkAndCreateRecurringTasks();
            refreshAllData();
        });
    } catch (error) {
        console.error("Firebase initialization failed:", error);
        document.body.innerHTML = 'Błąd inicjalizacji Firebase. Sprawdź konfigurację w sekcji CONFIGURATION na początku skryptu.';
    }


    // --- UI UTILITIES ---
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalText = document.getElementById('modal-text');
    document.getElementById('modal-close-btn').onclick = () => modal.style.display = 'none';

    function showModal(title, text) {
        modalTitle.textContent = title;
        modalText.textContent = text;
        modal.style.display = 'flex';
    }

    function showPage(pageId) {
        document.querySelectorAll('.content').forEach(div => div.classList.remove('active'));
        const page = document.getElementById(pageId);
        if (page) page.classList.add('active');
        document.getElementById('user-nav-links').classList.remove('open');
        document.getElementById('admin-nav-links').classList.remove('open');
    }

    let themeToggleButtons;
    function updateThemeIcon() {
        const isDarkMode = document.body.classList.contains('dark-mode');
        if (themeToggleButtons) themeToggleButtons.forEach(btn => { btn.innerHTML = isDarkMode ? '&#9728;&#65039;' : '&#127769;'; });
    }
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        updateThemeIcon();
    }

    function showAdminView() {
        document.getElementById('user-view').style.display = 'none';
        document.getElementById('admin-view').style.display = 'block';
        showPage('admin-tasks');
        if (!isAdminInitialized) { initAdminView(); isAdminInitialized = true; }
        refreshAllData();
    }
    
    const passwordActions = {
        'admin_1': async () => {
            const password = prompt("Potwierdź hasłem administratora:");
            if (password === null) return;
            if (await checkAdminPassword(password)) {
                 localStorage.setItem('defaultView', 'admin'); 
                 showModal('Sukces', 'Panel administratora został ustawiony jako domyślny.'); 
                 showAdminView();
            } else {
                 showModal('Błąd', 'Niepoprawne hasło!');
            }
        },
        'admin_0': async () => {
            const password = prompt("Potwierdź hasłem administratora:");
            if (password === null) return;
            if (await checkAdminPassword(password)) {
                localStorage.setItem('defaultView', 'user'); 
                showModal('Sukces', 'Panel użytkownika został ustawiony jako domyślny.'); 
                switchToUser();
            } else {
                showModal('Błąd', 'Niepoprawne hasło!');
            }
        },
        'passwd': async () => {
             const newPass1 = prompt("Wpisz nowe hasło:");
             if (newPass1 === null) return;
             const newPass2 = prompt("Powtórz nowe hasło:");
             if (newPass2 === null) return;

             if (newPass1 && newPass1 === newPass2) {
                try {
                    const docRef = doc(db, `artifacts/${appId}/config/admin`);
                    await setDoc(docRef, { password: newPass1 });
                    showModal('Sukces', 'Hasło zostało zmienione.');
                } catch (e) {
                    showModal('Błąd', 'Nie udało się zmienić hasła.');
                }
             } else {
                showModal('Błąd', 'Hasła nie są takie same lub pole jest puste.');
             }
        },
        'sql': () => { showSourceTagsAdmin = !showSourceTagsAdmin; showModal('Status', `Widoczność tagów źródła: ${showSourceTagsAdmin ? 'Włączona' : 'Wyłączona'}`); refreshAllData(); },
        'dev': () => window.open('https://coffynerd.github.io/publicnotebook/', '_blank'),
        'iddqd': () => window.open('https://www.youtube.com/watch?v=dXji8ycMolI', '_blank'),
        'minecraft': () => window.open('https://classic.minecraft.net', '_blank'),
        'help': () => {
            const isAdminView = document.getElementById('admin-view').style.display === 'block';
            let commands = ['sql', 'dev', 'iddqd', 'minecraft', 'help', 'admin_1', 'admin_0'];
            if (isAdminView) {
                commands.push('passwd');
            }
            showModal('Dostępne komendy', '- ' + commands.join('\n- '));
        }
    };
    
    async function checkAdminPassword(password) {
        const docRef = doc(db, `artifacts/${appId}/config/admin`);
        try {
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                return docSnap.data().password === password;
            } else {
                // If doc doesn't exist, create it with a default password "admin"
                await setDoc(docRef, { password: 'admin' });
                return password === 'admin';
            }
        } catch (e) {
            console.error("Error checking password:", e);
            return false;
        }
    }

    async function handleCommandPrompt() {
        const userInput = prompt("Wpisz hasło lub komendę:");
        if (userInput === null) return;

        if (passwordActions.hasOwnProperty(userInput)) {
            passwordActions[userInput]();
        } else {
             if (await checkAdminPassword(userInput)) {
                showAdminView();
             } else {
                showModal("Błąd", "Niepoprawne hasło lub komenda!");
             }
        }
    }

    function switchToUser() {
        document.getElementById('admin-view').style.display = 'none';
        document.getElementById('user-view').style.display = 'block';
        showPage('user-tasks');
        if (!isUserInitialized) {
            initUserView();
            isUserInitialized = true;
        }
        refreshAllData();
    }

    // --- NOTEBOOK HELPERS ---
    function convertTextToHtml(text) {
        if (!text) return '';
        const lines = text.split('\n');
        let inHtmlBlock = false;
        let htmlContent = '';
        const output = [];

        for (const line of lines) {
             if (line.trim().startsWith('(html){') && !inHtmlBlock) {
                inHtmlBlock = true;
                htmlContent = line.substring(line.indexOf('{') + 1);
                if (line.trim().endsWith('}(html)')) {
                    htmlContent = htmlContent.slice(0, htmlContent.lastIndexOf('}(html)'));
                    output.push(`<div class="raw-html-block">${htmlContent}</div>`);
                    inHtmlBlock = false;
                    htmlContent = '';
                }
                continue;
            }

            if (inHtmlBlock) {
                if (line.trim().endsWith('}(html)')) {
                    htmlContent += '\n' + line.slice(0, line.lastIndexOf('}(html)'));
                    output.push(`<div class="raw-html-block">${htmlContent}</div>`);
                    inHtmlBlock = false;
                    htmlContent = '';
                } else {
                    htmlContent += (htmlContent ? '\n' : '') + line;
                }
                continue;
            }
            
            if (line.trim() === '') {
                output.push('<div><br></div>');
                continue;
            }

            let hasCheckbox = false;
            let isChecked = false;
            let lineContent = line;

            const trimmed = line.trim();
            if (trimmed.startsWith('# ')) {
                hasCheckbox = true;
                isChecked = false;
                lineContent = trimmed.substring(2);
            } else if (trimmed.startsWith('& ')) {
                hasCheckbox = true;
                isChecked = true;
                lineContent = trimmed.substring(2);
            }

            let renderedContent = lineContent.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

            renderedContent = renderedContent.replace(/ean\((.+?)\)/g, (match, content) => {
                const displayCode = content.replace(/[@"']/g, '');
                const escapedMatch = match.replace(/'/g, '&apos;').replace(/"/g, '&quot;');
                return `<span class="ean-barcode" data-ean-source="${escapedMatch}">${displayCode}</span>`;
            });
            
            renderedContent = renderedContent.replace(/\[(.*?)\]\{(.*?)\}/g, (match, buttonText, link) => {
                let href = link.trim();
                if (!href.startsWith('http://') && !href.startsWith('https://')) href = 'https://' + href;
                const unescapedButtonText = buttonText.replace(/&lt;/g, '<').replace(/&gt;/g, '>');
                return `<a href="${href}" target="_blank"><button>${unescapedButtonText}</button></a>`;
            });
            
            if (hasCheckbox) {
                output.push(`<div><input type="checkbox" ${isChecked ? 'checked' : ''}>${renderedContent}</div>`);
            } else {
                output.push(`<div>${renderedContent}</div>`);
            }
        }
        
         if (inHtmlBlock) { // Just in case it's not closed
            output.push(`<div class="raw-html-block">${htmlContent}</div>`);
        }

        return output.join('');
    }


    function convertRenderedToSource(element) {
        const lines = [];
        element.childNodes.forEach(node => {
            if (node.nodeType !== 1) return; 

            if (node.innerHTML === '<br>') {
                lines.push('');
                return;
            }
            
            if (node.classList.contains('raw-html-block')) {
                lines.push(`(html){${node.innerHTML}}(html)`);
                return;
            }
            
            let line = '';
            const checkbox = node.querySelector('input[type="checkbox"]');
            if (checkbox) {
                line += checkbox.checked ? '& ' : '# ';
            }

            const processNode = (currentNode) => {
                 currentNode.childNodes.forEach(child => {
                    if (child.nodeType === 3) { // Text Node
                        line += child.textContent;
                    } else if (child.nodeType === 1) { // Element Node
                        if (child.tagName === 'INPUT' && child.type === 'checkbox') return;

                        if (child.classList.contains('ean-barcode')) {
                             line += child.dataset.eanSource.replace(/&apos;/g, "'").replace(/&quot;/g, '"');
                        } else if (child.tagName === 'A' && child.querySelector('button')) {
                            const button = child.querySelector('button');
                            let href = child.getAttribute('href');
                            if (href.startsWith('https://')) href = href.substring(8);
                            else if (href.startsWith('http://')) href = href.substring(7);
                            line += `[${button.textContent}]{${href}}`;
                        } else {
                           processNode(child); // Recurse
                        }
                    }
                });
            };
            
            processNode(node);
            lines.push(line);
        });
        return lines.join('\n');
    }

    // --- TASK HELPERS ---
    function parseTaskContent(content = '') {
        let index = 0;
        let processedContent = content.replace(/\((#|&)(.*?)\)/g, (match, sign, text) => {
            const isChecked = sign === '&';
            return `<span class="subtask"><input type="checkbox" class="subtask-checkbox" data-index="${index++}" ${isChecked ? 'checked' : ''}><span class="subtask-text ${isChecked ? 'done' : ''}">${text}</span></span>`;
        });
        
        processedContent = processedContent.replace(/{([^}]+?)}/g, (match, link) => {
             let href = link.trim();
             if (!href.startsWith('http://') && !href.startsWith('https://')) {
                href = 'https://' + href;
             }
             return `<a href="${href}" target="_blank" style="margin-left: 10px;"><button>załącznik</button></a>`;
        });
        
        return processedContent;
    }

    // --- RENDER FUNCTIONS ---
    async function renderTasks(isAdmin) {
        const listElement = document.getElementById(isAdmin ? 'admin-task-list-visible' : 'user-task-list');
        const hiddenListElement = isAdmin ? document.getElementById('admin-task-list-hidden') : null;

        if (!isAuthReady) {
            if (listElement) listElement.innerHTML = 'Ładowanie uwierzytelniania...';
            return;
        }

        const { data: supabaseTasks, error: supabaseError } = await supabase.from('tasks').select('*');
        if (supabaseError) console.error('Supabase tasks fetch error:', supabaseError);
        const formattedSupabaseTasks = (supabaseTasks || []).map(task => ({ ...task, source: 'supabase', createdAt: task.created_at, id: `supabase-${task.id}` }));

        const firebaseTasksColRef = collection(db, `artifacts/${appId}/public/data/tasks`);
        const firebaseTasksSnapshot = await getDocs(firebaseTasksColRef);
        const firebaseTasks = firebaseTasksSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), source: 'firebase', createdAt: doc.data().createdAt?.toDate() }));

        const allTasks = [...formattedSupabaseTasks, ...firebaseTasks];
        allTasks.sort((a, b) => {
            const aIsPriority = a.content.startsWith('!!!');
            const bIsPriority = b.content.startsWith('!!!');
            if (aIsPriority && !bIsPriority) return -1;
            if (!aIsPriority && bIsPriority) return 1;
            return (b.createdAt ? new Date(b.createdAt) : 0) - (a.createdAt ? new Date(a.createdAt) : 0);
        });

        const renderList = (tasksToRender, targetElement) => {
            if (!targetElement) return;
            targetElement.innerHTML = tasksToRender.length === 0 ? '<p>Brak zadań.</p>' : '';
            tasksToRender.forEach(task => {
                const isPriority = task.content.startsWith('!!!');
                const itemDiv = document.createElement('div');
                itemDiv.className = `item-row task-item ${task.done ? 'done' : ''} ${isPriority ? 'priority' : ''}`;
                if (task.source === 'firebase' && task.userAdded) {
                    itemDiv.classList.add('user-submitted');
                }
                itemDiv.dataset.taskId = task.id;
                itemDiv.dataset.source = task.source;
                itemDiv.dataset.fullContent = task.content;
                itemDiv.dataset.authorId = task.submittedByUserId;
                itemDiv.dataset.dueDate = task.dueDate;

                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'item-content-wrapper';

                const mainCheckbox = document.createElement('input');
                mainCheckbox.type = 'checkbox';
                mainCheckbox.checked = task.done;
                mainCheckbox.style.marginRight = '10px';
                mainCheckbox.onchange = async () => {
                    const updateData = { done: mainCheckbox.checked };
                    try {
                        if (task.source === 'supabase') {
                            const { error } = await supabase.from('tasks').update(updateData).eq('id', task.id.replace('supabase-',''));
                            if (error) throw error;
                        } else {
                            await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, task.id), updateData);
                        }
                        itemDiv.classList.toggle('done', mainCheckbox.checked);
                        if (isPriority && mainCheckbox.checked) new Audio('https://raw.githubusercontent.com/coffynerd/task_app/main/GLaDOS-758719.wav').play();
                        refreshAllData();
                    } catch (error) {
                        showModal('Błąd', 'Błąd aktualizacji zadania: ' + error.message);
                        mainCheckbox.checked = !mainCheckbox.checked; // Revert UI
                    }
                };

                const taskContentContainer = document.createElement('span');
                taskContentContainer.className = 'task-text-container';
                taskContentContainer.innerHTML = parseTaskContent(isPriority ? task.content.substring(3).trim() : task.content);
                contentWrapper.append(mainCheckbox, taskContentContainer);

                if (task.dueDate) {
                    const dueDateSpan = document.createElement('span');
                    dueDateSpan.classList.add('due-date-text');
                    
                    const dateParts = task.dueDate.split('-');
                    const dueDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));

                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    const day = dueDate.getDate().toString().padStart(2, '0');
                    const month = (dueDate.getMonth() + 1).toString().padStart(2, '0');
                    dueDateSpan.textContent = `Wykonać do: ${day}.${month}`;

                    if (dueDate <= today && !task.done) {
                         itemDiv.classList.add('due-date-warning');
                    }
                    contentWrapper.appendChild(dueDateSpan);
                }

                if ((isAdmin || showSourceTagsAdmin) && showSourceTagsAdmin) {
                    const sourceTag = document.createElement('span');
                    sourceTag.className = `source-tag ${task.source}`;
                    sourceTag.textContent = task.source;
                    contentWrapper.appendChild(sourceTag);
                }

                const rightSideInfo = document.createElement('div');
                rightSideInfo.className = 'right-aligned-info';
                const assigneesList = Array.isArray(task.assignees) ? task.assignees : (typeof task.assignees === 'string' && task.assignees.length > 0 ? task.assignees.split(/[,;]/).map(s => s.trim()) : []);
                rightSideInfo.innerHTML = `<div class="assignees">Osoby: ${assigneesList.length > 0 ? assigneesList.join(', ') : 'brak'}</div>
                                           ${task.createdAt ? `<div class="date-info">${new Date(task.createdAt).toLocaleDateString('pl-PL')}</div>` : ''}`;
                itemDiv.append(contentWrapper, rightSideInfo);

                if (isAdmin) {
                    const buttonsDiv = document.createElement('div');
                    buttonsDiv.innerHTML = `<button class="edit-btn">Edytuj</button><button class="toggle-btn">${task.visible === false ? 'Odkryj' : 'Ukryj'}</button><button class="delete-task-btn">Usuń</button>`;
                    buttonsDiv.querySelector('.edit-btn').onclick = async () => {
                        const newContent = prompt('Nowa treść zadania:', task.content);
                        if (newContent === null) return;
                        const newAssignees = prompt('Nowi przypisani (oddzieleni średnikiem):', Array.isArray(task.assignees) ? task.assignees.join(';') : task.assignees || '');
                        if (newAssignees === null) return;
                        const newDueDate = prompt('Nowy termin wykonania (YYYY-MM-DD):', task.dueDate || '');
                        const updateData = { content: newContent, assignees: newAssignees.split(';').map(s => s.trim()), dueDate: newDueDate || null };
                        if (task.source === 'supabase') await supabase.from('tasks').update(updateData).eq('id', task.id.replace('supabase-',''));
                        else await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, task.id), updateData);
                        refreshAllData();
                    };
                    buttonsDiv.querySelector('.toggle-btn').onclick = async () => {
                        const updateData = { visible: !(task.visible !== false) };
                        if (task.source === 'supabase') await supabase.from('tasks').update(updateData).eq('id', task.id.replace('supabase-',''));
                        else await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, task.id), updateData);
                        refreshAllData();
                    };
                    buttonsDiv.querySelector('.delete-task-btn').onclick = async () => {
                        if (confirm('Czy na pewno chcesz usunąć to zadanie?')) {
                            if (task.source === 'supabase') await supabase.from('tasks').delete().eq('id', task.id.replace('supabase-',''));
                            else await deleteDoc(doc(db, `artifacts/${appId}/public/data/tasks`, task.id));
                            refreshAllData();
                        }
                    };
                    itemDiv.appendChild(buttonsDiv);
                } else {
                    if (task.source === 'firebase' && task.userAdded) {
                        const buttonsDiv = document.createElement('div');
                        buttonsDiv.innerHTML = `<button class="edit-btn">Edytuj</button><button class="delete-task-btn">Usuń</button>`;
                        buttonsDiv.querySelector('.edit-btn').onclick = async () => {
                            const newContent = prompt('Nowa treść zadania:', task.content);
                            if (newContent === null) return;
                            const newAssignees = prompt('Nowi przypisani (oddzieleni średnikiem):', Array.isArray(task.assignees) ? task.assignees.join(';') : task.assignees || '');
                            if (newAssignees === null) return;
                             const newDueDate = prompt('Nowy termin wykonania (YYYY-MM-DD):', task.dueDate || '');
                            const updateData = { content: newContent, assignees: newAssignees.split(';').map(s => s.trim()), dueDate: newDueDate || null };
                            await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, task.id), updateData);
                            refreshAllData();
                        };
                        buttonsDiv.querySelector('.delete-task-btn').onclick = async () => {
                            if (confirm('Czy na pewno chcesz usunąć to zadanie?')) {
                                await deleteDoc(doc(db, `artifacts/${appId}/public/data/tasks`, task.id));
                                refreshAllData();
                            }
                        };
                        itemDiv.appendChild(buttonsDiv);
                    }
                }
                targetElement.appendChild(itemDiv);
            });
        };

        if (isAdmin) {
            renderList(allTasks.filter(t => t.visible !== false), listElement);
            renderList(allTasks.filter(t => t.visible === false), hiddenListElement);
        } else {
            renderList(allTasks.filter(t => t.visible !== false), document.getElementById('user-task-list'));
        }
    }

    async function renderOrders(isAdmin) {
        const activeListElement = document.getElementById(isAdmin ? 'admin-order-list-active' : 'user-order-list');
        const completedListElement = isAdmin ? document.getElementById('admin-order-list-completed') : null;

        if (!isAuthReady) {
            if (activeListElement) activeListElement.innerHTML = 'Ładowanie...';
            return;
        }

        const { data: supabaseOrders, error: supabaseError } = await supabase.from('orders').select('*');
        if (supabaseError) console.error('Supabase orders fetch error:', supabaseError);
        const formattedSupabaseOrders = (supabaseOrders || []).map(order => ({ ...order, done: order.is_completed, source: 'supabase', createdAt: order.created_at, id: `supabase-${order.id}` }));

        const firebaseOrdersSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/orders`));
        const firebaseOrders = firebaseOrdersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), source: 'firebase', createdAt: doc.data().createdAt?.toDate() }));

        const allOrders = [...formattedSupabaseOrders, ...firebaseOrders];
        allOrders.sort((a, b) => {
            const aIsPriority = a.name.startsWith('!!!');
            const bIsPriority = b.name.startsWith('!!!');
            if (aIsPriority !== bIsPriority) return aIsPriority ? -1 : 1;
            return (b.createdAt ? new Date(b.createdAt) : 0) - (a.createdAt ? new Date(a.createdAt) : 0);
        });

        const renderList = (ordersToRender, targetElement) => {
            if (!targetElement) return;
            targetElement.innerHTML = ordersToRender.length === 0 ? '<p>Brak pozycji.</p>' : '';
            ordersToRender.forEach(order => {
                const isPriority = order.name.startsWith('!!!');
                const displayName = isPriority ? order.name.substring(3).trim() : order.name;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = `item-row order-item ${order.done ? 'done' : ''} ${isPriority ? 'priority' : ''}`;
                itemDiv.dataset.orderId = order.id;
                itemDiv.dataset.source = order.source;

                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'item-content-wrapper';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = displayName;
                
                contentWrapper.append(nameSpan);
                
                const supplierInfo = document.createElement('span');
                supplierInfo.classList.add('supplier-info');
                supplierInfo.textContent = `(${order.supplier || 'brak dostawcy'})`;
                contentWrapper.appendChild(supplierInfo);

                if ((isAdmin || showSourceTagsAdmin) && showSourceTagsAdmin) {
                    const sourceTag = document.createElement('span');
                    sourceTag.className = `source-tag ${order.source}`;
                    sourceTag.textContent = order.source;
                    contentWrapper.appendChild(sourceTag);
                }

                const rightSideInfo = document.createElement('div');
                rightSideInfo.className = 'right-aligned-info';
                rightSideInfo.innerHTML = `${order.createdAt ? `<div class="date-info">${new Date(order.createdAt).toLocaleDateString('pl-PL')}</div>` : ''}`;
                
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'order-buttons';
                
                const doneBtn = document.createElement('button');
                doneBtn.textContent = 'Zamówione';
                doneBtn.onclick = async () => {
                    if (isPriority) new Audio('https://raw.githubusercontent.com/coffynerd/task_app/main/GLaDOS-770340.wav').play();
                    
                    try {
                        if (order.source === 'supabase') {
                             await supabase.from('orders').update({ is_completed: true }).eq('id', order.id.replace('supabase-',''));
                        } else {
                             await updateDoc(doc(db, `artifacts/${appId}/public/data/orders`, order.id), { done: true });
                        }
                        refreshAllData();
                    } catch (error) {
                        showModal('Błąd', 'Nie udało się zaktualizować statusu zamówienia: ' + error.message);
                    }
                };

                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edytuj';
                editBtn.onclick = async () => {
                    const newName = prompt('Nowa nazwa produktu:', order.name);
                    if (newName === null) return;
                    const newSupplier = prompt('Nowy dostawca:', order.supplier || '');
                    if (newSupplier === null) return;
                    const updateData = { name: newName, supplier: newSupplier };
                    try {
                        if (order.source === 'supabase') {
                            await supabase.from('orders').update(updateData).eq('id', order.id.replace('supabase-',''));
                        } else {
                            await updateDoc(doc(db, `artifacts/${appId}/public/data/orders`, order.id), updateData);
                        }
                        refreshAllData();
                    } catch(error) {
                        showModal('Błąd', 'Nie udało się zaktualizować pozycji: ' + error.message);
                    }
                };

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Usuń';
                deleteBtn.className = 'delete-order-btn';
                deleteBtn.onclick = async () => {
                    if (confirm('Czy na pewno chcesz usunąć tę pozycję?')) {
                        try {
                            if (order.source === 'supabase') {
                                await supabase.from('orders').delete().eq('id', order.id.replace('supabase-',''));
                            } else {
                                await deleteDoc(doc(db, `artifacts/${appId}/public/data/orders`, order.id));
                            }
                            refreshAllData();
                        } catch (error) {
                            showModal('Błąd', 'Nie udało się usunąć pozycji: ' + error.message);
                        }
                    }
                };
                
                if (!isAdmin) {
                    if (!order.done) {
                        buttonsDiv.appendChild(doneBtn);
                        if (order.source === 'firebase') {
                            buttonsDiv.appendChild(editBtn);
                        }
                    }
                } else {
                    if (!order.done) {
                        buttonsDiv.appendChild(editBtn);
                        buttonsDiv.appendChild(doneBtn);
                    }
                    buttonsDiv.appendChild(deleteBtn);
                }
                
                itemDiv.append(contentWrapper, rightSideInfo, buttonsDiv);
                targetElement.appendChild(itemDiv);
            });
        };
        
        const activeOrders = allOrders.filter(o => o.done !== true);
        const completedOrders = allOrders.filter(o => o.done === true);
        
        if (isAdmin) {
            renderList(activeOrders, activeListElement);
            renderList(completedOrders, completedListElement);
        } else {
            renderList(activeOrders, activeListElement);
        }
    }
    
    async function renderNotes(isAdmin) {
        if (!isAuthReady) return;
        
        const listEl = document.getElementById(isAdmin ? 'note-title-list' : 'user-note-title-list');
        listEl.innerHTML = 'Ładowanie...';

        const { data: supabaseNotes = [] } = await supabase.from('notes').select('*');
        const formattedSupabaseNotes = supabaseNotes.map(n => ({ ...n, id: `supabase-${n.id}`, source: 'supabase', createdAt: n.created_at, titleColor: n.title_color, pinned: n.is_pinned, public: n.is_public }));

        const fbPath = `artifacts/${appId}/public/data/notes`;
        const fbSnapshot = await getDocs(collection(db, fbPath));
        const firebaseNotes = fbSnapshot.docs.map(d => ({ ...d.data(), id: d.id, source: 'firebase', createdAt: d.data().createdAt?.toDate() }));
        
        const allNotes = [...formattedSupabaseNotes, ...firebaseNotes]
            .filter(note => isAdmin || note.public || note.is_public)
            .sort((a, b) => (b.pinned ? 1 : -1) - (a.pinned ? 1 : -1) || (new Date(b.createdAt || b.created_at) - new Date(a.createdAt || a.created_at)));

        listEl.innerHTML = allNotes.length === 0 ? 'Brak notatek.' : '';
        allNotes.forEach(note => {
            const item = document.createElement('div');
            item.className = `note-list-item ${note.pinned ? 'pinned' : ''} ${note.public || note.is_public ? 'public' : ''}`;
            item.dataset.id = note.id;
            item.dataset.source = note.source;
            item.dataset.authorId = note.submittedByUserId;
            if ((isAdmin && note.id === currentAdminNoteId) || (!isAdmin && note.id === currentUserNoteId)) item.classList.add('selected');
            
            const titleHtml = `<span class="note-title" style="color:${note.titleColor || note.title_color || 'inherit'}">${note.title}</span>
                               <span class="note-list-date">${note.createdAt ? new Date(note.createdAt).toLocaleDateString() : ''}</span>
                               ${((isAdmin || showSourceTagsAdmin) && showSourceTagsAdmin) ? `<span class="source-tag ${note.source}">${note.source}</span>` : ''}`;
            
            item.innerHTML = `<div class="note-title-wrapper">${titleHtml}</div>`;

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'note-actions';
            
            const pinBtn = document.createElement('span');
            pinBtn.className = 'note-pin-btn';
            pinBtn.innerHTML = '&#128204;';
            pinBtn.title = note.pinned ? 'Odepnij' : 'Przypnij';
            pinBtn.onclick = (e) => { e.stopPropagation(); handleNoteAction('pin', note, isAdmin); };
            
            const publishBtn = document.createElement('span');
            publishBtn.className = 'note-publish-btn';
            publishBtn.innerHTML = (note.public || note.is_public) ? '&#128275;' : '&#128274;';
            publishBtn.title = (note.public || note.is_public) ? 'Ustaw jako prywatną' : 'Upublicznij';
            publishBtn.onclick = (e) => { e.stopPropagation(); handleNoteAction('publish', note, isAdmin); };

            const shareBtn = document.createElement('span');
            shareBtn.className = 'note-share-btn';
            shareBtn.innerHTML = '&#128279;';
            shareBtn.title = 'Udostępnij (kopiuj link)';
            shareBtn.onclick = (e) => {
                e.stopPropagation();
                const identifier = note.uuid || note.id;
                if(identifier) {
                    const shareLink = `https://coffynerd.github.io/publicnotebook/?uuid=${identifier}`;
                    navigator.clipboard.writeText(shareLink).then(() => {
                        showModal('Sukces', 'Link do notatki skopiowany do schowka.');
                    }, () => {
                        showModal('Błąd', 'Nie udało się skopiować linku.');
                    });
                } else {
                    showModal('Błąd', 'Brak identyfikatora do udostępnienia tej notatki.');
                }
            };
            
            actionsDiv.appendChild(pinBtn); 

            if (isAdmin) {
                 actionsDiv.appendChild(publishBtn);
            }
            if(note.uuid || note.source === 'firebase') actionsDiv.appendChild(shareBtn);

            item.appendChild(actionsDiv);
            item.onclick = () => {
                if (isAdmin) { currentAdminNoteId = note.id; loadAdminNoteIntoEditor(note); } 
                else { currentUserNoteId = note.id; loadUserNoteIntoEditor(note); }
                document.querySelectorAll('.note-list-item.selected').forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
            };
            listEl.appendChild(item);
        });
    }

    async function renderVacationRequests(isAdmin) {
       const userListElement = document.getElementById('user-schedule-request-list');
       const adminVisibleListElement = document.getElementById('admin-schedule-request-list-visible');
       const adminHiddenListElement = document.getElementById('admin-schedule-request-list-hidden');

        if (!isAuthReady) {
            if (userListElement) userListElement.innerHTML = 'Ładowanie...';
            if (adminVisibleListElement) adminVisibleListElement.innerHTML = 'Ładowanie...';
            return;
        }

        const { data: supabaseRequests, error: supabaseError } = await supabase.from('vacation_requests').select('*');
        if (supabaseError) console.error('Supabase requests fetch error:', supabaseError);
        const formattedSupabaseRequests = (supabaseRequests || []).map(req => ({ ...req, source: 'supabase', createdAt: req.created_at, id: `supabase-${req.id}` }));

        const firebaseRequestsSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/vacation_requests`));
        const firebaseRequests = firebaseRequestsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), source: 'firebase', createdAt: doc.data().createdAt?.toDate() }));

        let allRequests = [...formattedSupabaseRequests, ...firebaseRequests];
        allRequests.sort((a, b) => new Date(b.created_at || b.createdAt) - new Date(a.created_at || a.createdAt));

        const renderList = (requestsToRender, targetElement) => {
            if (!targetElement) return;
            targetElement.innerHTML = requestsToRender.length === 0 ? '<p>Brak wniosków.</p>' : '';
            requestsToRender.forEach(req => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `item-row vacation-request`;
                 let statusText = 'Oczekujący';
                let statusColor = 'orange';

                if (req.is_accepted === true) {
                    statusText = 'Zaakceptowany';
                    statusColor = 'green';
                    itemDiv.classList.add('accepted');
                } else if (req.rejection_reason) {
                    statusText = 'Odrzucony';
                    statusColor = 'red';
                    itemDiv.classList.add('rejected');
                }

                itemDiv.dataset.id = req.id;
                itemDiv.dataset.source = req.source;
                itemDiv.dataset.visible = req.is_visible;

                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'item-content-wrapper';
                let notesText = req.notes || '';
                if(req.rejection_reason) {
                    notesText += ` (Powód odrzucenia: ${req.rejection_reason})`;
                }
                contentWrapper.innerHTML = `
                    <span style="font-weight: bold; flex-shrink: 0; min-width: 150px;">${req.employee_name}</span>
                    <span style="margin-left: 15px; flex-shrink: 0;">${req.start_date} do ${req.end_date}</span>
                    <span style="margin-left: 15px; font-weight: bold; flex-shrink: 0; color: ${statusColor};">(${statusText})</span>
                    <span style="flex-grow: 1; text-align: right; color: #666; padding: 0 20px;">${notesText}</span>
                `;

                if ((isAdmin || showSourceTagsAdmin) && showSourceTagsAdmin) {
                     const sourceTag = document.createElement('span');
                     sourceTag.className = `source-tag ${req.source}`;
                     sourceTag.textContent = req.source;
                     contentWrapper.appendChild(sourceTag);
                }

                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'right-aligned-info';
                
                if (isAdmin) {
                    const date = new Date(req.createdAt || req.created_at);
                    const dateInfo = !isNaN(date) ? `<div class="date-info">${date.toLocaleString('pl-PL')}</div>` : '';
                    let rejectButton = '';
                    if (req.source === 'firebase') {
                        rejectButton = `<button class="reject-vacation-btn">Odrzuć</button>`;
                    }
                    buttonsDiv.innerHTML = `
                        ${dateInfo}
                        <div>
                            <label style="cursor:pointer; margin-right: 10px;"><input type="checkbox" class="accept-vacation-checkbox" ${req.is_accepted ? 'checked' : ''}> Akceptuj</label>
                            <button class="toggle-visibility-btn">${req.is_visible !== false ? 'Ukryj' : 'Pokaż'}</button>
                            <button class="edit-vacation-btn">Edytuj</button>
                            ${rejectButton}
                            <button class="delete-vacation-btn">Usuń</button>
                        </div>`;
                } else {
                     buttonsDiv.innerHTML = `<div><button class="edit-vacation-btn">Edytuj</button></div>`;
                }
                
                itemDiv.append(contentWrapper, buttonsDiv);
                targetElement.appendChild(itemDiv);
            });
        };

        if (isAdmin) {
            const filterStart = document.getElementById('admin-filter-start').value;
            const filterEnd = document.getElementById('admin-filter-end').value;
            let filteredData = allRequests;
            if (filterStart) filteredData = filteredData.filter(req => new Date(req.end_date) >= new Date(filterStart));
            if (filterEnd) filteredData = filteredData.filter(req => new Date(req.start_date) <= new Date(filterEnd));
            
            const visibleRequests = filteredData.filter(req => req.is_visible !== false);
            const hiddenRequests = filteredData.filter(req => req.is_visible === false);

            renderList(visibleRequests, adminVisibleListElement);
            renderList(hiddenRequests, adminHiddenListElement);
        } else {
            const userVisibleRequests = allRequests.filter(req => req.is_visible !== false);
            renderList(userVisibleRequests, userListElement);
        }
    }

    async function refreshAllData() {
        if (!isAuthReady) return;
        console.log("Odświeżanie danych...");
        const inAdminView = document.getElementById('admin-view').style.display === 'block';
        const promises = [
            renderTasks(inAdminView),
            renderOrders(inAdminView),
            renderNotes(true), 
            renderNotes(false), 
            renderVacationRequests(inAdminView)
        ];

        if (inAdminView) {
            promises.push(renderRecurringTasks());
        }

        await Promise.all(promises);
        
        console.log("Dane odświeżone.");
    }
    
    async function handleNoteAction(action, note, isAdmin) {
        const source = note.source;
        const noteId = source === 'supabase' ? note.id.replace('supabase-', '') : note.id;
        const fbPath = `artifacts/${appId}/public/data/notes`;

        try {
            if (action === 'pin') {
                const newPinnedState = !(note.pinned || note.is_pinned);
                if (source === 'supabase') {
                    const { error } = await supabase.from('notes').update({ is_pinned: newPinnedState }).eq('id', noteId);
                    if (error) throw error;
                } else {
                    await updateDoc(doc(db, fbPath, noteId), { pinned: newPinnedState });
                }
            } else if (action === 'publish') {
                if (isAdmin) {
                    const newPublicState = !(note.public || note.is_public);
                    if(source === 'supabase') {
                        const { error } = await supabase.from('notes').update({ is_public: newPublicState }).eq('id', noteId);
                        if (error) throw error;
                    } else {
                        const noteRef = doc(db, fbPath, noteId);
                        await updateDoc(noteRef, { public: newPublicState });
                    }
                } else {
                    showModal('Błąd', 'Tylko administrator może zmieniać status publiczny notatki.');
                }
            }
            renderNotes(true);
            renderNotes(false);
        } catch (error) {
            showModal('Błąd', 'Nie udało się wykonać akcji na notatce: ' + error.message);
        }
    }

    // --- USER VIEW ---
    function clearUserEditor() {
        currentUserNoteId = null;
        document.getElementById('user-note-title-input').value = '';
        document.getElementById('user-note-color-input').value = '#000000';
        document.getElementById('user-note-content-input').innerHTML = '';
        document.getElementById('user-note-content-raw').value = '';
        document.getElementById('user-note-timestamps').textContent = '';
        document.querySelectorAll('#user-note-title-list .selected').forEach(item => item.classList.remove('selected'));
        editorMode.user = 'render';
        document.getElementById('user-note-content-input').style.display = 'block';
        document.getElementById('user-note-content-raw').style.display = 'none';
        document.getElementById('user-toggle-raw-btn').textContent = 'Edytuj Kod';
        document.getElementById('user-save-note-btn').disabled = false;
        document.getElementById('user-save-note-btn').title = "";
    }

    function loadUserNoteIntoEditor(note) {
        currentUserNoteId = note.id;
        const saveButton = document.getElementById('user-save-note-btn');
        
        saveButton.disabled = false;
        saveButton.title = "";
        
        document.getElementById('user-note-title-input').value = note.title || '';
        document.getElementById('user-note-color-input').value = note.titleColor || note.title_color ||'#000000';
        document.getElementById('user-note-content-input').innerHTML = convertTextToHtml(note.content);
        const date = note.updatedAt ? new Date(note.updatedAt.seconds * 1000) : new Date(note.updated_at || note.created_at);
        const timestamps = `Ostatnia edycja: ${date.toLocaleString()}`;
        document.getElementById('user-note-timestamps').textContent = timestamps;
        editorMode.user = 'render';
        document.getElementById('user-note-content-input').style.display = 'block';
        document.getElementById('user-note-content-raw').style.display = 'none';
        document.getElementById('user-toggle-raw-btn').textContent = 'Edytuj Kod';
    }

    async function saveUserNote() {
        const title = document.getElementById('user-note-title-input').value.trim();
        if (!title) { showModal('Błąd', 'Tytuł notatki nie może być pusty!'); return; }
        const content = editorMode.user === 'raw' ? document.getElementById('user-note-content-raw').value : convertRenderedToSource(document.getElementById('user-note-content-input'));
        const noteData = { title, content, titleColor: document.getElementById('user-note-color-input').value, updatedAt: new Date() };

        if (currentUserNoteId) {
            const source = document.querySelector(`#user-note-title-list .note-list-item[data-id="${currentUserNoteId}"]`).dataset.source;
             if (source === 'supabase') {
                const { error } = await supabase.from('notes').update({ title: noteData.title, content: noteData.content, title_color: noteData.titleColor, updated_at: new Date().toISOString() }).eq('id', currentUserNoteId.replace('supabase-',''));
                if (error) throw new Error('Supabase update failed');
            } else {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/notes`, currentUserNoteId), noteData);
            }
        } else {
            const newDocRef = await addDoc(collection(db, `artifacts/${appId}/public/data/notes`), { ...noteData, createdAt: new Date(), pinned: false, public: true, submittedByUserId: userId, uuid: crypto.randomUUID() });
            currentUserNoteId = newDocRef.id;
        }
        renderNotes(false);
        renderNotes(true);
    }

    function initUserView() {
        document.getElementById('user-order-form').onsubmit = async (e) => { 
            e.preventDefault(); 
            const nameInput = document.getElementById('user-order-name');
            const supplierInput = document.getElementById('user-order-supplier');
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/orders`), { 
                    name: nameInput.value, 
                    supplier: supplierInput.value, 
                    done: false, 
                    createdAt: new Date(), 
                    submittedByUserId: userId 
                });
                nameInput.value = '';
                supplierInput.value = '';
                renderOrders(false);
            } catch (error) {
                showModal('Błąd zapisu', 'Nie udało się dodać pozycji do Firebase. Sprawdź konsolę, aby uzyskać więcej informacji.');
                console.error("Firebase addDoc error:", error);
            }
        };
        document.getElementById('user-new-note-btn').onclick = clearUserEditor;
        document.getElementById('user-save-note-btn').onclick = saveUserNote;
        document.getElementById('user-toggle-raw-btn').onclick = (e) => { 
            const contentInput = document.getElementById('user-note-content-input');
            const rawInput = document.getElementById('user-note-content-raw');
            if (editorMode.user === 'render') {
                rawInput.value = convertRenderedToSource(contentInput);
                contentInput.style.display = 'none';
                rawInput.style.display = 'block';
                editorMode.user = 'raw';
                e.target.textContent = 'Podgląd Wizualny';
            } else {
                contentInput.innerHTML = convertTextToHtml(rawInput.value);
                rawInput.style.display = 'none';
                contentInput.style.display = 'block';
                editorMode.user = 'render';
                e.target.textContent = 'Edytuj Kod';
            }
        };
        document.getElementById('user-schedule-request-form').onsubmit = async (e) => { 
            e.preventDefault(); 
            const form = e.target;
            const employee_name = form.querySelector('#user-employee-name').value;
            const start_date = form.querySelector('#user-start-date').value;
            const end_date = form.querySelector('#user-end-date').value;
            if (new Date(end_date) < new Date(start_date)) {
                showModal('Błąd', 'Data zakończenia nie może być wcześniejsza niż data rozpoczęcia.');
                return;
            }
            localStorage.setItem('lastUserName', employee_name);
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/vacation_requests`), {
                    employee_name, start_date, end_date,
                    notes: form.querySelector('#user-vacation-notes').value,
                    is_visible: true, is_accepted: false, createdAt: new Date(), submittedByUserId: userId
                });
                showModal('Sukces', 'Wniosek został wysłany.');
                form.reset();
                renderVacationRequests(false);
            } catch (error) {
                showModal('Błąd zapisu', 'Nie udało się wysłać wniosku. Sprawdź konsolę, aby uzyskać więcej informacji.');
                console.error("Firebase addDoc error:", error);
            }
        };
        document.getElementById('user-task-form').onsubmit = async (e) => { 
            e.preventDefault();
            const form = e.target;
            const content = form.querySelector('#user-task-input').value.trim();
            if (!content) return;
            const assignees = form.querySelector('#user-assignee-input').value.trim();
             const dueDate = form.querySelector('#user-due-date-input').value;
            const taskData = {
                content,
                assignees: assignees.split(/[,;]/).map(s => s.trim()).filter(s => s),
                done: false,
                visible: true,
                createdAt: new Date(),
                submittedByUserId: userId,
                userAdded: true
            };
            if(dueDate) {
                taskData.dueDate = dueDate;
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), taskData);
                form.reset();
                renderTasks(false);
                renderTasks(true);
            } catch (error) {
                showModal('Błąd zapisu', 'Nie udało się dodać zadania: ' + error.message);
            }
        };
    }
    
    // --- ADMIN VIEW ---
    function clearAdminEditor() {
        currentAdminNoteId = null;
        document.getElementById('note-title-input').value = '';
        document.getElementById('note-color-input').value = '#000000';
        document.getElementById('note-content-input').innerHTML = '';
        document.getElementById('note-content-raw').value = '';
        document.getElementById('note-timestamps').textContent = '';
        document.querySelectorAll('#note-title-list .selected').forEach(item => item.classList.remove('selected'));
        editorMode.admin = 'render';
        document.getElementById('note-content-input').style.display = 'block';
        document.getElementById('note-content-raw').style.display = 'none';
        document.getElementById('admin-toggle-raw-btn').textContent = 'Edytuj Kod';
    }

    function loadAdminNoteIntoEditor(note) {
        currentAdminNoteId = note.id;
        document.getElementById('note-title-input').value = note.title || '';
        document.getElementById('note-color-input').value = note.titleColor || note.title_color || '#000000';
        document.getElementById('note-content-input').innerHTML = convertTextToHtml(note.content);
        const ts = note.updatedAt || note.updated_at || note.createdAt;
        const date = ts ? (ts.seconds ? new Date(ts.seconds * 1000) : new Date(ts)) : new Date(ts);
        document.getElementById('note-timestamps').textContent = date ? `Ostatnia edycja: ${date.toLocaleString()}`: '';
        editorMode.admin = 'render';
        document.getElementById('note-content-input').style.display = 'block';
        document.getElementById('note-content-raw').style.display = 'none';
        document.getElementById('admin-toggle-raw-btn').textContent = 'Edytuj Kod';
    }

    async function saveAdminNote() {
        const title = document.getElementById('note-title-input').value.trim();
        if (!title) { showModal('Błąd', 'Tytuł jest wymagany'); return; }
        const content = editorMode.admin === 'raw' ? document.getElementById('note-content-raw').value : convertRenderedToSource(document.getElementById('note-content-input'));
        const noteData = { title, content, title_color: document.getElementById('note-color-input').value, updated_at: new Date().toISOString() };
        const firebaseNoteData = { title, content, titleColor: document.getElementById('note-color-input').value, updatedAt: new Date() };
        
        try {
            if (currentAdminNoteId) {
                if (currentAdminNoteId.startsWith('supabase')) {
                    await supabase.from('notes').update(noteData).eq('id', currentAdminNoteId.replace('supabase-',''));
                } else {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/notes`, currentAdminNoteId), firebaseNoteData);
                }
            } else { 
                await addDoc(collection(db, `artifacts/${appId}/public/data/notes`), { ...firebaseNoteData, createdAt: new Date(), pinned: false, public: false, uuid: crypto.randomUUID() });
                clearAdminEditor();
            }
            renderNotes(true);
        } catch(error) {
            showModal('Błąd zapisu', 'Nie udało się zapisać notatki: ' + error.message);
        }
    }
    
    async function deleteAdminNote() {
        if (!currentAdminNoteId || !confirm('Czy na pewno chcesz usunąć tę notatkę?')) return;
        try {
            if (currentAdminNoteId.startsWith('supabase')) {
                await supabase.from('notes').delete().eq('id', currentAdminNoteId.replace('supabase-', ''));
            } else {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/notes`, currentAdminNoteId));
            }
            clearAdminEditor();
            renderNotes(true);
        } catch (error) {
            showModal('Błąd', 'Nie udało się usunąć notatki: ' + error.message);
        }
    }
    
    function initAdminView() {
        document.getElementById('admin-task-form').onsubmit = async (e) => { 
            e.preventDefault();
            const form = e.target;
            const content = form.querySelector('#admin-task-input').value.trim();
            if (!content) return;
            const assignees = form.querySelector('#admin-assignee-input').value.trim();
            const dueDate = form.querySelector('#admin-due-date-input').value;
            const taskData = {
                content,
                assignees: assignees.split(/[,;]/).map(s => s.trim()).filter(s => s),
                done: false,
                visible: true,
                createdAt: new Date(),
                submittedByUserId: userId
            };
            if(dueDate) {
                taskData.dueDate = dueDate;
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), taskData);
                form.reset();
                renderTasks(true);
            } catch (error) {
                showModal('Błąd zapisu', 'Nie udało się dodać zadania: ' + error.message);
            }
        };
        document.getElementById('admin-order-form').onsubmit = async (e) => { 
            e.preventDefault(); 
            const nameInput = document.getElementById('admin-order-name');
            const supplierInput = document.getElementById('admin-order-supplier');
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/orders`), { name: nameInput.value, supplier: supplierInput.value, done: false, createdAt: new Date(), submittedByUserId: userId });
                nameInput.value = '';
                supplierInput.value = '';
                renderOrders(true);
            } catch (error) {
                showModal('Błąd zapisu', 'Nie udało się dodać pozycji: ' + error.message);
            }
        };
        document.getElementById('new-note-btn').onclick = clearAdminEditor;
        document.getElementById('save-note-btn').onclick = saveAdminNote;
        document.getElementById('delete-note-btn').onclick = deleteAdminNote;
        document.getElementById('admin-toggle-raw-btn').onclick = (e) => {
            const contentInput = document.getElementById('note-content-input');
            const rawInput = document.getElementById('note-content-raw');
            if (editorMode.admin === 'render') {
                rawInput.value = convertRenderedToSource(contentInput);
                contentInput.style.display = 'none';
                rawInput.style.display = 'block';
                editorMode.admin = 'raw';
                e.target.textContent = 'Podgląd Wizualny';
            } else {
                contentInput.innerHTML = convertTextToHtml(rawInput.value);
                rawInput.style.display = 'none';
                contentInput.style.display = 'block';
                editorMode.admin = 'render';
                e.target.textContent = 'Edytuj Kod';
            }
        };
        document.getElementById('admin-schedule-request-form').onsubmit = async (e) => { 
            e.preventDefault();
            const form = e.target;
            const employee_name = form.querySelector('#admin-employee-name').value;
            const start_date = form.querySelector('#admin-start-date').value;
            const end_date = form.querySelector('#admin-end-date').value;
            if (new Date(end_date) < new Date(start_date)) {
                showModal('Błąd', 'Data zakończenia nie może być wcześniejsza niż data rozpoczęcia.');
                return;
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/vacation_requests`), {
                    employee_name, start_date, end_date,
                    notes: form.querySelector('#admin-vacation-notes').value,
                    is_visible: true, is_accepted: false, createdAt: new Date(), submittedByUserId: userId
                });
                showModal('Sukces', 'Wniosek został wysłany.');
                form.reset();
                renderVacationRequests(true);
            } catch (error) {
                showModal('Błąd zapisu', 'Nie udało się wysłać wniosku: ' + error.message);
            }
        };
        document.getElementById('admin-filter-btn').onclick = () => renderVacationRequests(true);
        document.getElementById('admin-clear-filter-btn').onclick = () => {
            document.getElementById('admin-filter-start').value = '';
            document.getElementById('admin-filter-end').value = '';
            renderVacationRequests(true);
        };
        document.getElementById('recurring-task-form').onsubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const content = form.querySelector('#recurring-task-content').value.trim();
            if (!content) return;
            const assignees = form.querySelector('#recurring-task-assignees').value.trim();
            const days = Array.from(form.querySelectorAll('input[name="day"]:checked')).map(cb => parseInt(cb.value));
            
            if(days.length === 0){
                showModal('Błąd', 'Musisz wybrać co najmniej jeden dzień.');
                return;
            }

            try {
                 await addDoc(collection(db, `artifacts/${appId}/public/data/recurring_tasks`), {
                    content,
                    assignees: assignees.split(/[,;]/).map(s => s.trim()).filter(s => s),
                    days,
                    lastCreated: null
                });
                form.reset();
                renderRecurringTasks();
            } catch (error) {
                 showModal('Błąd zapisu', 'Nie udało się dodać zadania cyklicznego: ' + error.message);
            }
        };
    }

    // --- RECURRING TASKS ---
    async function renderRecurringTasks() {
        const listEl = document.getElementById('recurring-task-list');
        if(!listEl) return;
        listEl.innerHTML = 'Ładowanie...';
        const recurringTasksSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/recurring_tasks`));
        const recurringTasks = recurringTasksSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        listEl.innerHTML = recurringTasks.length === 0 ? '<p>Brak zadań cyklicznych.</p>' : '';
        const dayNames = ['N/A', 'Pn', 'Wt', 'Śr', 'Cz', 'Pt', 'So', 'Nd'];

        recurringTasks.forEach(task => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item-row';
            const days = task.days.map(d => dayNames[d]).join(', ');
            itemDiv.innerHTML = `
                <div class="item-content-wrapper">
                    <span>${task.content}</span>
                    <span class="assignees">Osoby: ${task.assignees.join(', ') || 'brak'}</span>
                     <span class="assignees">Dni: ${days}</span>
                </div>
                 <div>
                    <button class="edit-recurring-btn">Edytuj</button>
                    <button class="delete-recurring-btn">Usuń</button>
                </div>
            `;
             itemDiv.querySelector('.edit-recurring-btn').onclick = async () => {
                const newContent = prompt('Nowa treść zadania:', task.content);
                if (newContent === null) return;

                const newAssignees = prompt('Nowi przypisani (oddzieleni średnikiem):', (task.assignees || []).join(';'));
                if (newAssignees === null) return;

                const newDaysStr = prompt('Nowe dni (cyfry 1-7 oddzielone przecinkami, 1=Pn, 7=Nd):', task.days.join(','));
                if (newDaysStr === null) return;

                const newDays = newDaysStr.split(',').map(d => parseInt(d.trim())).filter(d => d >= 1 && d <= 7);
                if (newDays.length === 0) {
                    showModal('Błąd', 'Musisz podać przynajmniej jeden poprawny dzień (1-7).');
                    return;
                }
                
                const updateData = {
                    content: newContent,
                    assignees: newAssignees.split(/[,;]/).map(s => s.trim()).filter(s => s),
                    days: newDays
                };
                
                try {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/recurring_tasks`, task.id), updateData);
                    renderRecurringTasks();
                } catch (error) {
                    showModal('Błąd', 'Nie udało się zaktualizować zadania cyklicznego.');
                }
            };
            itemDiv.querySelector('.delete-recurring-btn').onclick = async () => {
                if (confirm('Czy na pewno chcesz usunąć to zadanie cykliczne?')) {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/recurring_tasks`, task.id));
                    renderRecurringTasks();
                }
            };
            listEl.appendChild(itemDiv);
        });
    }

    async function checkAndCreateRecurringTasks() {
        if (!isAuthReady) return;
        console.log("Checking recurring tasks...");
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        let dayOfWeek = today.getDay(); 
        if (dayOfWeek === 0) dayOfWeek = 7; 

        const recurringTasksSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/recurring_tasks`));
        
        const promises = [];
        let createdAny = false;

        recurringTasksSnapshot.forEach(doc => {
            const recurringTask = { id: doc.id, ...doc.data() };
            if (recurringTask.days.includes(dayOfWeek) && recurringTask.lastCreated !== todayStr) {
                console.log(`Creating recurring task: ${recurringTask.content}`);
                createdAny = true;
                promises.push(addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), {
                    content: recurringTask.content,
                    assignees: recurringTask.assignees,
                    createdAt: new Date(),
                    done: false,
                    visible: true
                }));
                promises.push(updateDoc(doc.ref, { lastCreated: todayStr }));
            }
        });
        
        await Promise.all(promises);
        if (createdAny) {
             console.log("Finished creating recurring tasks, refreshing list.");
            refreshAllData();
        } else {
             console.log("No new recurring tasks to create today.");
        }
    }


    // --- EVENT LISTENERS & INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        themeToggleButtons = document.querySelectorAll('.theme-toggle-btn');
        if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        updateThemeIcon();

        initUserView();
        initAdminView();

        if (localStorage.getItem('defaultView') === 'admin') {
            showAdminView();
        } else {
            document.getElementById('user-view').style.display = 'block';
            isUserInitialized = true; // Set this flag
            refreshAllData();
        }

        document.querySelectorAll('.refresh-btn').forEach(btn => btn.onclick = refreshAllData);
        themeToggleButtons.forEach(btn => btn.onclick = toggleTheme);
        document.querySelectorAll('.hamburger-btn').forEach(btn => {
            btn.onclick = () => btn.closest('.nav-bar').querySelector('.nav-links').classList.toggle('open');
        });

        document.body.addEventListener('click', (e) => {
            const navLink = e.target.closest('a[data-page]');
            if (navLink) {
                e.preventDefault();
                showPage(navLink.dataset.page);
            }
            if (e.target.closest('#switch-to-admin-btn') || e.target.closest('#admin-commands-btn')) handleCommandPrompt();
            if (e.target.closest('#switch-to-user-btn')) switchToUser();

            const vacationList = e.target.closest('#user-schedule-request-list, #admin-schedule-request-list-visible, #admin-schedule-request-list-hidden');
            if(vacationList) handleVacationListClick(e, vacationList.id.includes('admin'));
        });
        
        function handleNoteClick(e) {
            const link = e.target.closest('a');
            if (link && link.href) {
                e.preventDefault();
                window.open(link.href, '_blank');
            }
        }
        document.getElementById('user-note-content-input').addEventListener('click', handleNoteClick);
        document.getElementById('note-content-input').addEventListener('click', handleNoteClick);

        async function handleCheckboxAutoSave(e) {
            if (e.target.tagName === 'INPUT' && e.target.type === 'checkbox') {
                const isAdmin = e.currentTarget.id === 'note-content-input';
                
                setTimeout(() => {
                    if (isAdmin) {
                        saveAdminNote();
                    } else {
                        saveUserNote();
                    }
                }, 100);
            }
        }
        document.getElementById('user-note-content-input').addEventListener('change', handleCheckboxAutoSave);
        document.getElementById('note-content-input').addEventListener('change', handleCheckboxAutoSave);


        setupTaskListeners();
    });

    function setupTaskListeners() {
       document.body.addEventListener('change', async (e) => {
           if(e.target.classList.contains('subtask-checkbox')) {
                const checkbox = e.target;
                const taskRow = checkbox.closest('.item-row');
                const taskId = taskRow.dataset.taskId;
                const source = taskRow.dataset.source;
                let fullContent = taskRow.dataset.fullContent;
                const clickedIndex = parseInt(checkbox.dataset.index, 10);
                const isChecked = checkbox.checked;

                checkbox.nextElementSibling.classList.toggle('done', isChecked);

                let currentIndex = 0;
                const newContent = fullContent.replace(/\((#|&)(.*?)\)/g, (match, sign, text) => {
                    if (currentIndex++ === clickedIndex) return `(${isChecked ? '&' : '#'}${text})`;
                    return match;
                });
                
                try {
                    const updateData = { content: newContent };
                    if (source === 'supabase') {
                       const { error } = await supabase.from('tasks').update(updateData).eq('id', taskId.replace('supabase-',''));
                       if(error) throw error;
                    } else {
                       await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, taskId), updateData);
                    }
                    taskRow.dataset.fullContent = newContent;
                } catch (error) {
                    showModal('Błąd', 'Nie udało się zaktualizować podzadania: ' + error.message);
                    checkbox.checked = !isChecked; // Revert UI
                    checkbox.nextElementSibling.classList.toggle('done', !isChecked);
                    taskRow.dataset.fullContent = fullContent; // Revert dataset
                }
           }
       });
    }

    async function handleVacationListClick(e, isAdmin) {
        const target = e.target;
        const reqDiv = target.closest('.vacation-request');
        if (!reqDiv) return;

        const reqId = reqDiv.dataset.id;
        const source = reqDiv.dataset.source;
        const dbId = reqId.replace('supabase-','');

        if (target.matches('.accept-vacation-checkbox')) {
            const updateData = { is_accepted: target.checked, rejection_reason: "" };
            try {
                if (source === 'supabase') await supabase.from('vacation_requests').update(updateData).eq('id', dbId);
                else await updateDoc(doc(db, `artifacts/${appId}/public/data/vacation_requests`, dbId), updateData);
                renderVacationRequests(isAdmin);
            } catch(error) {
                showModal('Błąd', 'Nie udało się zaktualizować statusu: ' + error.message);
                target.checked = !target.checked;
            }
        } else if (target.matches('.toggle-visibility-btn')) {
            const isCurrentlyVisible = reqDiv.dataset.visible !== 'false';
            const newVisibility = !isCurrentlyVisible;
            const updateData = { is_visible: newVisibility };
            try {
                if (source === 'supabase') await supabase.from('vacation_requests').update(updateData).eq('id', dbId);
                else await updateDoc(doc(db, `artifacts/${appId}/public/data/vacation_requests`, dbId), updateData);
                renderVacationRequests(true);
            } catch(error) {
                showModal('Błąd', 'Nie udało się zmienić widoczności: ' + error.message);
            }
        } else if (target.matches('.edit-vacation-btn')) {
            let currentData;
            if (source === 'supabase') { const { data } = await supabase.from('vacation_requests').select('*').eq('id', dbId).single(); currentData = data; }
            else { const docSnap = await getDoc(doc(db, `artifacts/${appId}/public/data/vacation_requests`, dbId)); currentData = docSnap.data(); }
            if (!currentData) return showModal('Błąd', 'Nie znaleziono wniosku.');
            
            const new_start_date = prompt('Nowa data rozpoczęcia:', currentData.start_date);
            if (new_start_date === null) return;
            const new_end_date = prompt('Nowa data zakończenia:', currentData.end_date);
            if (new_end_date === null) return;
            const new_notes = prompt('Nowa notatka:', currentData.notes);
            if (new_notes === null) return;
            const updateData = { start_date: new_start_date, end_date: new_end_date, notes: new_notes };

            try {
                if (source === 'supabase') await supabase.from('vacation_requests').update(updateData).eq('id', dbId);
                else await updateDoc(doc(db, `artifacts/${appId}/public/data/vacation_requests`, dbId), updateData);
                renderVacationRequests(isAdmin);
            } catch (error) {
                showModal('Błąd', 'Nie udało się zedytować wniosku: ' + error.message);
            }
        } else if (target.matches('.delete-vacation-btn')) {
            if (confirm('Czy na pewno chcesz usunąć ten wniosek?')) {
                try {
                    if (source === 'supabase') await supabase.from('vacation_requests').delete().eq('id', dbId);
                    else await deleteDoc(doc(db, `artifacts/${appId}/public/data/vacation_requests`, dbId));
                    renderVacationRequests(isAdmin);
                } catch(error) {
                    showModal('Błąd', 'Nie udało się usunąć wniosku: ' + error.message);
                }
            }
        } else if (target.matches('.reject-vacation-btn')) {
             if (source !== 'firebase') {
                showModal('Błąd', 'Odrzucać można tylko wnioski zapisane w nowej bazie danych.');
                return;
            }
            const reason = prompt("Podaj powód odrzucenia:");
            if (reason !== null) {
                if (reason.trim() === "") {
                    showModal("Błąd", "Powód odrzucenia nie może być pusty.");
                    return;
                }
                const updateData = { is_accepted: false, rejection_reason: reason };
                try {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/vacation_requests`, dbId), updateData);
                    renderVacationRequests(isAdmin);
                } catch(error) {
                    showModal('Błąd', 'Nie udało się odrzucić wniosku: ' + error.message);
                }
            }
        }
    }
</script>
</body>
</html>

